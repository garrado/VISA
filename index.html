<!DOCTYPE html>
<html lang="pt-BR">
<head>

<link rel="stylesheet" href="./css/design-tokens.css">
  
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta property="og:title" content="Vigil√¢ncia Sanit√°ria de An√°polis">
<meta property="og:description" content="Aplicativo interno da Vigil√¢ncia Sanit√°ria">
<meta property="og:image" content="https://garrado.github.io/VISA/icons/visa-compartilhar.png">
<meta property="og:url" content="https://garrado.github.io/VISA/">
<meta property="og:type" content="website">

<meta property="og:image:width" content="https://garrado.github.io/VISA/icons/visa-compartilhar.png">
<meta property="og:image:height" content="https://garrado.github.io/VISA/icons/visa-compartilhar.png">
<meta name="apple-touch-icon" content="icons/visa-compartilhar.png">

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#004aad">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icons/visa-192.png">

<title>Vigil√¢ncia Sanit√°ria</title>

<style>
:root{
  
  /* === INPUTS E FORMUL√ÅRIOS (CR√çTICO!) === */
  --input-bg: #ffffff;
  --input-border: rgba(0, 0, 0, 0.23);
  --input-focus: #2c5aa0;
  --input-text: #1a202c;
  --input-placeholder: #a0aec0;
  --input-disabled-bg: #f5f7fa;
  --input-disabled-text: #a0aec0;

  --brand1:#2c5aa0;
  --brand2:#3d6bb3;
  --bg:#f2f4f8;
  --text:#1f2a3a;
  --muted:#5b6b83;
  --card:#ffffff;
  --line:rgba(31,42,58,.10);
  --shadow:0 10px 28px rgba(0,0,0,.08);
  --shadow2:0 6px 16px rgba(0,0,0,.08);
  --warnBg:#fff7dd;
  --warnLine:#d1a000;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

/* --- TELA DE CARREGAMENTO (LOADING) --- */
#loading {
  position: fixed;
  inset: 0;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #ccd6e0;
  border-top: 4px solid var(--brand1);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 15px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* --- CONTE√öDO E LOGIN (Invis√≠veis inicialmente) --- */
#conteudo{display:none}

#login{
  /* Oculto por padr√£o para evitar o "pisca" antes do Firebase carregar */
  display:none; 
  min-height: 70vh;
  align-items:center;
  justify-content:center;
  padding: 28px 18px;
}

.loginCard{
  width:min(520px, 100%);
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 16px;
  padding: 22px;
  box-shadow: var(--shadow);
  text-align:center;
}
.loginCard h2{margin:0 0 6px 0}
.loginCard p{margin:0 0 14px 0;color:var(--muted)}
.btn{
  appearance:none;
  border: 1px solid var(--line);
  background: #fff;
  color: var(--text);
  padding: 12px 16px;
  border-radius: 12px;
  cursor:pointer;
  font-weight:700;
  transition: .15s transform, .15s box-shadow, .15s background;
}
.btn:hover{box-shadow: var(--shadow2); transform: translateY(-1px)}
.btn:active{transform: translateY(0)}
.btnPrimary{
  border: none;
  background: linear-gradient(135deg, var(--brand1), var(--brand2));
  color:#fff;
}

header {
  background: #1a3a6b;
  color: #ffffff;
  padding: 28px 20px 26px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

header h1 {
  margin: 0;
  font-size: clamp(1.7rem, 2.4vw, 2.3rem);
  font-weight: 900;
  letter-spacing: .2px;
  color: #ffffff;
}

header h2 {
  margin: 8px 0 0;
  font-size: clamp(1rem, 1.5vw, 1.15rem);
  font-weight: 500;
  opacity: .92;
  color: #ffffff;
}
  
.container{
  max-width: 1100px;
  margin: 22px auto 30px;
  padding: 0 16px;
}

.card{
  background: var(--card);
  border-radius: 16px;
  padding: 18px 18px;
  margin-bottom: 16px;
  border: 1px solid var(--line);
  box-shadow: var(--shadow2);
}
.card h3{
  margin:0 0 10px 0;
  color: var(--brand1);
  padding-left: 10px;
  border-left: 6px solid var(--brand1);
}
.card p{
  text-align: justify;
  text-justify: inter-word;
}

.avisos{
  background: var(--warnBg);
  border-left: 6px solid var(--warnLine);
}

.muted{color:var(--muted)}
.small{font-size:.92rem;color:var(--muted)}

.grid{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap:16px;
}
@media (max-width: 920px){
  .grid{grid-template-columns:1fr}
}

.hero{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  padding: 18px;
  border-radius: 18px;
  background: linear-gradient(135deg, rgba(44,90,160,.12), rgba(61,107,179,.10));
  border: 1px solid rgba(44,90,160,.18);
}
.heroLeft h3{
  margin:0 0 6px 0;
  border-left:none;
  padding-left:0;
  color: var(--text);
  font-size: 1.2rem;
}
.heroLeft p{margin:0;color:var(--muted)}
.heroBtn{
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding: 14px 18px;
  border-radius: 14px;
  font-weight: 900;
  letter-spacing:.2px;
  white-space:nowrap;
}
.heroBtn span{
  display:inline-flex;
  width: 30px;
  height: 30px;
  border-radius: 10px;
  background: rgba(255,255,255,.22);
  align-items:center;
  justify-content:center;
  font-weight:900;
}

.links-section ul{list-style:none;padding:0;margin:0}
.links-section li{margin: 10px 0}
.linkPill{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid var(--line);
  background:#fff;
  text-decoration:none;
  color: var(--text);
  font-weight:800;
}
.linkPill:hover{box-shadow: var(--shadow2); transform: translateY(-1px)}
.linkPill small{font-weight:600;color:var(--muted)}
.linkPill .arrow{
  width: 34px;
  height: 34px;
  border-radius: 12px;
  background: rgba(44,90,160,.10);
  display:flex;
  align-items:center;
  justify-content:center;
}

.footer{
  text-align:center;
  padding: 18px 16px 26px;
  color: #66728a;
}

}

/* iOS/telas pequenas: bot√£o "WebCVS" com toque melhor e largura total */
@media (max-width: 640px), (pointer: coarse){
  .heroBtn{
    width: 100% !important;
    justify-content: center !important;
    padding: 16px 16px !important;
    font-size: 1.05rem !important;
    line-height: 1.15 !important;
    white-space: normal !important;
    text-align: center !important;
  }
  .heroBtn span{
    width: 34px !important;
    height: 34px !important;
    border-radius: 12px !important;
  }
}

/* === CARDS QUADRADOS 2x2 PARA MOBILE === */
@media (max-width: 768px) {
  .links-section ul {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 14px;
    padding: 0;
    margin: 0;
  }
  
  .links-section li {
    margin: 0;
  }
  
  .linkPill {
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 18px 10px;
    height: 150px; /* Altura fixa para uniformidade */
    gap: 10px;
    border-radius: 16px;
    box-shadow: var(--shadow2);
  }
  
  .linkPill .arrow {
    order: -1;
    width: 50px;
    height: 50px;
    margin-bottom: 6px;
    background: linear-gradient(135deg, var(--brand1), var(--brand2));
    font-size: 1.6rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 14px;
  }
  
  .linkPill small {
    font-size: 0.82rem;
    line-height: 1.25;
    display: block;
    margin-top: -2px;
  }
  
  .linkPill:active {
    transform: scale(0.97);

/* INDICADORES */
.indicadores-section{margin-top:24px;padding-top:20px;border-top:2px solid var(--line);}
.indicadores-section h3{margin:0 0 16px 0;color:var(--brand1);padding-left:10px;border-left:6px solid var(--brand1);font-size:1.05rem;}
.indicadores-loading{text-align:center;padding:20px;color:var(--muted);font-size:0.9rem;background:#f8f9fb;border-radius:8px;}
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;}
.stat-card{background:linear-gradient(135deg,#f8f9fb,#ffffff);border:1px solid rgba(44,90,160,0.15);border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px;text-align:left;}
.stat-icon{font-size:1.6rem;flex-shrink:0;}
.stat-numero{font-size:1.3rem;font-weight:900;background:linear-gradient(135deg,var(--brand1),var(--brand2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;margin:4px 0;}
.stat-label{font-size:0.75rem;color:var(--text);font-weight:700;margin:2px 0;}
.stat-detalhe{font-size:0.7rem;color:var(--muted);}
.tipos-table-container h4{margin:16px 0 10px 0;font-size:0.85rem;color:var(--brand1);font-weight:700;text-transform:uppercase;}
.tipos-table{width:100%;border-collapse:collapse;font-size:0.8rem;}
.tipos-table tr{border-bottom:1px solid rgba(0,0,0,0.05);}
.tipos-table tr:last-child{border-bottom:none;}
.tipos-table td{padding:8px 4px;}
.tipos-table td:first-child{text-align:left;font-weight:600;color:var(--text);}
.tipos-table td:last-child{text-align:right;font-weight:900;color:var(--brand1);font-size:0.9rem;width:50px;}
.tipo-barra{height:5px;background:#e8edf3;border-radius:3px;margin-top:3px;overflow:hidden;}
.tipo-barra-fill{height:100%;background:linear-gradient(90deg,var(--brand1),var(--brand2));transition:width 0.6s ease;}
.update-info{text-align:center;font-size:0.7rem;color:var(--muted);margin-top:12px;padding-top:10px;border-top:1px solid rgba(0,0,0,0.05);}
@media(max-width:480px){.stats-grid{grid-template-columns:1fr;gap:8px;}}.stat-card{display:flex;align-items:center;gap:12px;text-align:left;}.stat-icon{font-size:2rem;}.stat-numero{font-size:1.5rem;}}
  }
}

/* Modal de acesso n√£o autorizado */
.modalOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:9999;
}
.modalCard{
  width:min(520px, 100%);
  background:#fff;
  border:1px solid rgba(31,42,58,.12);
  border-radius:16px;
  box-shadow:0 18px 50px rgba(0,0,0,.20);
  padding:18px;
}
.modalCard h3{ margin:0 0 8px 0; color:#b30000; }
.modalCard p{ margin:8px 0; color:#1f2a3a; }
.modalCard .small{ color:#5b6b83; font-size:.92rem; white-space:pre-line; }
.modalActions{
  display:flex;
  gap:10px;
  justify-content:flex-end;
  margin-top:12px;
}
.modalActions .btn{ width:auto; }

/* Card que ocupa as duas colunas da grid */
.grid-span-2{
  grid-column: 1 / -1;
}

</style>

  <!-- Sistema de Design - VISA An√°polis -->
  <link rel="stylesheet" href="./css/base.css">
  <link rel="stylesheet" href="./css/components.css">
  <link rel="stylesheet" href="./css/layouts.css">

  <style>
    /* Bot√£o Voltar - iOS e Android Nativos */
    .topbar .btn {
      background: transparent !important;
      border: none !important;
      color: var(--text, #1a202c) !important;
      padding: 6px 12px !important;
      font-size: 17px !important;
      font-weight: 400 !important;
    }
    
    .topbar .btn::before {
      content: "‚Üê";
      margin-right: 4px;
      font-size: 20px;
    }
    
    /* iOS: Setinha fina azul */
    @supports (-webkit-touch-callout: none) {
      .topbar .btn {
        color: #007AFF !important;
        font-weight: 400 !important;
      }
      .topbar .btn::before {
        content: "‚Äπ";
        font-size: 32px;
        font-weight: 300;
        margin-right: 0px;
        vertical-align: middle;
      }
    }
    
    /* Ocultar topbar no desktop */
    @media (min-width: 769px) {
      .topbar--mobile-only {
        display: none !important;
      }
    }
  </style>

  <style>
    /* Corre√ß√£o WebCVS - Alinhamento */
    .card p {
      padding: 0 !important;
      margin: 0 !important;
    }
  </style>

  <style>
    /* Textos justificados */
    .aviso p,
    .mensagem p,
    .institucional p {
      text-align: justify !important;
      text-justify: inter-word;
    }
  </style>
</head>

<body>

<div id="loading">
  <div class="spinner"></div>
  <div style="color:var(--brand1); font-weight:600">Verificando acesso...</div>
</div>

<div id="login">
  <div class="loginCard">
    <h2>√Årea Restrita</h2>
    <p>Entre com sua conta Google para acessar os conte√∫dos internos.</p>
    <button class="btn btnPrimary" onclick="loginGoogle()">Entrar com Google</button>
  </div>
</div>

<div id="conteudo">

<header>
  <h1>Vigil√¢ncia Sanit√°ria</h1>
  <h2>Diretoria de Vigil√¢ncia em Sa√∫de ‚Äî An√°polis</h2>
</header>

<div class="container">

  <div class="grid">
    <div class="card avisos">
     
      <h3>Novidades no Aplicativo</h3>

  <p>

<p>
    üß©<strong>√Äreas</strong><br>
  </p>
 <br>
  <p>
  Divis√£o dos fiscais por √°reas de atua√ß√£o(bairro e CNAEe).
  </p>
 <br>
    
  <p>
    üìã<strong>OS</strong><br>
  </p>
 <br>
  <p>
  Pesquisa Ordens de Servi√ßo pelo N√∫mero, Fiscal, Raz√£o Social, Nome de Fantasia.
  </p>
 <br>
    
      
      
  <p>
    ‚è≥<strong>CVS em Tempo Real</strong><br>
  </p>
 <br>
  <p>
  As informa√ß√µes do APP, como inspe√ß√µes e dados dos regulados s√£o sincronizadas com o CVS todas as noites.
  </p>
 <br>

    üìö <strong>Inspe√ß√µes por Per√≠odo</strong><br>
  </p>
 <br>
      <p>
      Lista todas inspe√ß√µes por fiscal e per√≠odo desde 2018. Para acessar, selecione o nome e utilize a senha do CVS.  
      </p>  
 <br>
      <h3>Avisos da Supervis√£o</h3>
     
       <br>  
    <div class="indicadores-section"><h3>üìä Indicadores do M√™s</h3><div id="indicadores-content"><div class="indicadores-loading">üìä Carregando...</div></div></div>
</div>
     <div class="card links-section">
      <h3>Central de Trabalho</h3>
      <ul>
        <li><a class="linkPill" href="os.html"><div>OS<br><small>Consulta Ordens de Servi√ßo</small></div><div class="arrow">üìã</div></a></li>
        <li><a class="linkPill" href="Regulados.html"><div>WebCVS<br><small>Sistema CVS online</small></div><div class="arrow">üåê</div></a></li>
        <li><a class="linkPill" href="RPF_OTIMIZADO.html"><div>Inspe√ß√µes<br><small>Relat√≥rio por fiscal e per√≠odo</small></div><div class="arrow">üìä</div></a></li>
        <li><a class="linkPill" href="Escala_Plantao_Janeiro_2026"><div>Plant√£o Fiscal<br><small>Escala de plant√£o em janeiro</small></div><div class="arrow">üìÖ</div></a></li>
        <li><a class="linkPill" href="Escala_Veiculos_Janeiro_2026_APP.html"><div>Ve√≠culos<br><small>Escala de uso dos ve√≠culos em janeiro</small></div><div class="arrow">üöó</div></a></li>
        <li><a class="linkPill" href="Escala_Ferias_Janeiro_2026_APP"><div>F√©rias<br><small>Escala de f√©rias de janeiro</small></div><div class="arrow">üèñÔ∏è</div></a></li>
        <li><a class="linkPill" href="relatorio_plantao_fiscal.html"><div>Ocorr√™ncias<br><small>Relat√≥rio do plant√£o fiscal</small></div><div class="arrow">üìà</div></a></li>
        <li><a class="linkPill" href="legislacao.html"><div>Legisla√ß√£o<br><small>Consulta normativa</small></div><div class="arrow">üìú</div></a></li>
        <li><a class="linkPill" href="check.html"><div>Check List<br><small>Roteiro de inspe√ß√£o</small></div><div class="arrow">‚úì</div></a></li>
        <li><a class="linkPill" href="areas.html"><div>√Åreas<br><small>Fiscais por bairro e CNAEs</small></div><div class="arrow">üß©</div></a></li>
        <li><a class="linkPill" href="cadastro_economico_por_equipe_colorido.html"><div>CNAEs<br><small>Distribui√ß√£o por √°rea</small></div><div class="arrow">üë•</div></a></li>
        <li><a class="linkPill" href="mailto:visa@anapolis.go.gov.br"><div>Sugest√µes<br><small>Envie sua ideia</small></div><div class="arrow">üí°</div></a></li> 
      </ul>

  </div>


  
  
    <div class="card grid-span-2">
    <h3>Mensagem Institucional</h3>
    <p>
      Esta p√°gina interna da Ger√™ncia de Vigil√¢ncia Sanit√°ria re√∫ne informa√ß√µes, links e comunicados destinados aos servidores, com o objetivo de apoiar as atividades de fiscaliza√ß√£o sanit√°ria, promovendo a qualidade das a√ß√µes fiscalizat√≥rias e a melhor organiza√ß√£o da comunica√ß√£o e do acesso a dados operacionais.
    </p>
    <br>
    <p class="small">
      üìÑ <a href="README.html" target="_blank" rel="noopener">Consulte aqui o Aviso Institucional e as regras de uso da plataforma</a>
    </p>
  </div>



</div>

</div></div>

<div style="text-align: center; padding: 20px 16px;">
  <button class="btn" onclick="logout()">Encerrar sess√£o</button>
</div>

<div class="footer">
  Vigil√¢ncia Sanit√°ria ‚Äì Diretoria de Vigil√¢ncia em Sa√∫de<br>
  Munic√≠pio de An√°polis ‚Äì GO<br>
  ¬© 2025-2026
</div>

</div>

<div id="modalNaoAutorizado" class="modalOverlay" style="display:none" role="dialog" aria-modal="true" aria-labelledby="modalNaoAutorizadoTitulo">
  <div class="modalCard">
    <h3 id="modalNaoAutorizadoTitulo">Acesso n√£o autorizado</h3>
    <p>Sua conta Google n√£o consta na lista de usu√°rios liberados para esta p√°gina institucional.</p>
    <p class="small" id="modalNaoAutorizadoConta"></p>
    <p class="small">Solicite a libera√ß√£o ao administrador da p√°gina e tente novamente.</p>
    <div class="modalActions">
      <button class="btn btnPrimary" onclick="fecharModalNaoAutorizado()">Entendi</button>
    </div>
  

  
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  signInWithPopup,
  GoogleAuthProvider,
  onAuthStateChanged,
  signOut,
  setPersistence,
  browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";


// ===== SISTEMA DE CACHE DE AUTENTICA√á√ÉO =====
const AUTH_CACHE_KEY = 'visa_auth_cache';
const AUTH_CACHE_DURATION = 60 * 60 * 1000; // 1 hora

class AuthCache {
  constructor() {
    this.cacheKey = AUTH_CACHE_KEY;
    this.cacheDuration = AUTH_CACHE_DURATION;
  }

  save(user) {
    const cacheData = {
      email: user.email,
      uid: user.uid,
      displayName: user.displayName,
      photoURL: user.photoURL,
      timestamp: Date.now(),
      expiresAt: Date.now() + this.cacheDuration
    };
    try {
      localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
      console.log('‚úÖ Cache salvo - v√°lido por', Math.floor(this.cacheDuration / 1000 / 60), 'minutos');
    } catch (error) {
      console.warn('Erro ao salvar cache:', error);
    }
  }

  get() {
    try {
      const cached = localStorage.getItem(this.cacheKey);
      if (!cached) return null;
      const data = JSON.parse(cached);
      if (Date.now() < data.expiresAt) return data;
      this.clear();
      return null;
    } catch (error) {
      return null;
    }
  }

  clear() {
    try {
      localStorage.removeItem(this.cacheKey);
      console.log('üóëÔ∏è Cache limpo');
    } catch (error) {}
  }

  getTimeRemaining() {
    const cached = this.get();
    if (!cached) return 0;
    return Math.max(0, Math.floor((cached.expiresAt - Date.now()) / 1000));
  }
}

const authCache = new AuthCache();
// ===== FIM DO CACHE =====

const firebaseConfig = {
  apiKey: "AIzaSyDo473puJesZ9rr3IBoX5AWczCIMuKBTrg",
  authDomain: "visam-3a30b.firebaseapp.com",
  projectId: "visam-3a30b",
  messagingSenderId: "308899251430",
  appId: "1:308899251430:web:0053cdbd0bed7f0de76727"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// CONFIGURA√á√ÉO DE PERSIST√äNCIA (Isso evita logins repetidos)
setPersistence(auth, browserLocalPersistence).catch((error) => {
  console.error("Erro ao definir persist√™ncia:", error);
});

/* ===== LISTA DE AUTORIZADOS (SOMENTE E-MAIL) ===== */
const AUTHORIZED_EMAILS = new Set([
  "vmsbgyn@gmail.com",
  "adrianosantos@anapolis.go.gov.br",
  "joseluizribeiro22@gmail.com",
  "acadiaasocial@gmail.com",
  "santanaluciana097@gmail.com",
  "visa.saude@anapolis.go.gov.br",
  "rubiamarabel@gmail.com",
  "ps.visa@anapolis.go.gov.br",
  "jotadaguas@gmail.com",
  "geraldoedsonrosa@gmail.com",
  "patycdmes@gmail.com",
  "ariannefvieira@hotmail.com",
  "marinaperillo@hotmail.com",
  "visa@anapolis.go.gov.br",
  "mariaedwiges@anapolis.go.gov.br",
  "tathnut@hotmail.com",
  "simonegrossi@anapolis.go.gov.br",
  "kamillarolim@gmail.com",
  "lulucieneepais@gmail.com",
  "adrianepereira@anapolis.go.gov.br",
  "claudio@anapolis.go.gov.br",
  "silviamarques@anapolis.go.gov.br",
  "mhg.rodovalho@gmail.com",
  "medwiges@gmail.com",
  "lindaenila@gmail.com",
  "wanessab412@gmail.com",
  "juliocteles@anapolis.go.gov.br",
  "fabiolappmarques@gmail.com",
  "lidianesimoes@anapolis.go.gov.br",
  "educacao.esportes@anapolis.go.gov.br",
  "crbferreira81@gmail.com",
  "profajulianakenia@gmail.com",
  "dani.visaanapolis@gmail.com",
  "medicamentos@anapolis.go.gov.br",
  "cesio@anapolis.go.gov.br",
  "gubio@anapolis.go.gov.br",
  "marciorodovalho@anapolis.go.gov.br",
  "edsonarantes@anapolis.go.gov.br",
  "981217644pedro@gmail.com",
  "julianafviturino@gmail.com",
  "thaysasouza97@gmail.com",
  "farm.castro78@gmail.com",
  "viniciuscassiano@anapolis.go.gov.br",
  "thiagogomesgobo@gmail.com",
  "liviabr.visa@gmail.com",
  "wanessa05@gmail.com",
  "santosrat@gmail.com",
  "vivianemiyada@gmail.com",
  "angelavet2@gmail.com",
  "diasbrito1515@gmail.com",
  "cidalinacoelho@anapolis.go.gov.br",
  "lauraeleuza@gmail.com",
  "portaria344@anapolis.go.gov.br",
  "mens.agitat.molem.cns@gmail.com"
]);

function isAuthorized(user){
  const email = (user?.email || "").toLowerCase().trim();
  return AUTHORIZED_EMAILS.has(email);
}

/* --- CONTROLE DE EXIBI√á√ÉO --- */
function showLoading(){
  document.getElementById("loading").style.display = "flex";
  document.getElementById("login").style.display = "none";
  document.getElementById("conteudo").style.display = "none";
}

function showLogin(){
  document.getElementById("loading").style.display = "none";
  document.getElementById("login").style.display = "flex";
  document.getElementById("conteudo").style.display = "none";
}

function showConteudo(){
  document.getElementById("loading").style.display = "none";
  document.getElementById("login").style.display = "none";
  document.getElementById("conteudo").style.display = "block";
}

/* modal n√£o autorizado */
function showUnauthorizedModal(user){
  const modal = document.getElementById("modalNaoAutorizado");
  const conta = document.getElementById("modalNaoAutorizadoConta");
  const email = user?.email || "(e-mail n√£o identificado)";
  if (conta) conta.textContent = `E-mail: ${email}`;
  if (modal) modal.style.display = "flex";
}

window.__pendingLogout = false;

window.fecharModalNaoAutorizado = async function(){
  const modal = document.getElementById("modalNaoAutorizado");
  if (modal) modal.style.display = "none";

  if (window.__pendingLogout){
    window.__pendingLogout = false;
    try { await signOut(auth); } catch(e){ console.error(e); }
  }
};

/* fechar clicando fora do card */
document.addEventListener("click", (e) => {
  const modal = document.getElementById("modalNaoAutorizado");
  if (modal && modal.style.display === "flex" && e.target === modal) {
    window.fecharModalNaoAutorizado();
  }
});

/* LOGIN */
window.loginGoogle = function() {
  signInWithPopup(auth, provider).catch(console.error);
};

/* LOGOUT (manual) */
window.logout = function(){
  signOut(auth).catch(console.error);
};

/* CONTROLE DE SESS√ÉO */

// ===== INICIALIZA√á√ÉO OTIMIZADA =====
(function initOptimizedAuth() {
  // 1. Verifica cache primeiro
  const cachedAuth = authCache.get();
  
  if (cachedAuth && AUTHORIZED_EMAILS.has(cachedAuth.email.toLowerCase())) {
    console.log('‚úÖ Login via cache - v√°lido por', authCache.getTimeRemaining(), 'segundos');
    showConteudo();
    
    // Verifica token em background
    onAuthStateChanged(auth, (user) => {
      if (user && isAuthorized(user)) {
        authCache.save(user);
      } else {
        authCache.clear();
        showLogin();
      }
    });
    
    return;
  }

  // 2. Sem cache v√°lido - usa Firebase normalmente
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      showLogin();
      return;
    }

    if (isAuthorized(user)) {
      authCache.save(user); // Salva no cache
      showConteudo();
      return;
    }

    showLogin();
    showUnauthorizedModal(user);
    window.__pendingLogout = true;
  });
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
function carregarIndicadores() {
  const container = document.getElementById('indicadores-content');
  if (!container) return;
  
  Papa.parse('data/inspecoes.csv', {
    download: true,
    header: true,
    delimiter: ';',
    encoding: '',
    skipEmptyLines: true,
    complete: function(results) {
      processarDados(results.data, container);
    },
    error: function(error) {
      container.innerHTML = '<div class="indicadores-loading">‚ö†Ô∏è Erro: data/inspecoes.csv</div>';
    }
  });
}

function processarDados(data, container) {
  const rows = data;

  // ===== Helpers =====
  const mesesPt = [
    'Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho',
    'Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'
  ];

  const pad2 = (n) => String(n).padStart(2, '0');

  // Extrai {day, month, year} de "DD.MM.YYYY" ou "DD/MM/YYYY" (ou com "-")
  function parseDMY(str) {
    if (!str) return null;
    const m = String(str).trim().match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})/);
    if (!m) return null;
    const day = parseInt(m[1], 10);
    const month = parseInt(m[2], 10);
    let year = parseInt(m[3], 10);
    if (year < 100) year += 2000; // caso venha "26" em vez de "2026"
    if (!(day >= 1 && day <= 31 && month >= 1 && month <= 12)) return null;
    return { day, month, year };
  }

  function labelMesAno(month, year) {
    return `${mesesPt[month - 1]} ${year}`;
  }

  function prevMesAno(month, year) {
    if (month === 1) return { month: 12, year: year - 1 };
    return { month: month - 1, year };
  }

  function keyMesAno(month, year) {
    return `${pad2(month)}.${year}`; // ex: "01.2026"
  }

  // ===== Regra do m√™s avaliado =====
  const hoje = new Date(); // data do dispositivo (web/pwa)
  const hojeDia = hoje.getDate();
  const mesAtual = hoje.getMonth() + 1; // 1..12
  const anoAtual = hoje.getFullYear();

  const atualKey = keyMesAno(mesAtual, anoAtual);
  const anterior = prevMesAno(mesAtual, anoAtual);
  const anteriorKey = keyMesAno(anterior.month, anterior.year);

  // Filtra linhas do m√™s atual e do m√™s anterior (baseado no "MM.AAAA" presente na data)
  const rowsMesAtual = rows.filter(row => row.DT_VISITA && String(row.DT_VISITA).includes(atualKey));
  const rowsMesAnterior = rows.filter(row => row.DT_VISITA && String(row.DT_VISITA).includes(anteriorKey));

  // Verifica se no m√™s atual j√° existem inspe√ß√µes "a partir do dia 15" (>= 15)
  const existeDia15ouMaisNoMesAtual = rowsMesAtual.some(row => {
    const dmy = parseDMY(row.DT_VISITA);
    return dmy && dmy.year === anoAtual && dmy.month === mesAtual && dmy.day >= 15;
  });

  // === Decis√£o final ===
  // 1) Enquanto N√ÉO chegar no dia 15 do m√™s corrente, mostra m√™s anterior.
  // 2) Depois do dia 15, s√≥ troca para o m√™s corrente se j√° existirem inspe√ß√µes com dia >= 15 nesse m√™s.
  let inspecoesFiltradas;
  let periodoTexto;

  if (hojeDia < 15) {
    inspecoesFiltradas = rowsMesAnterior;
    periodoTexto = labelMesAno(anterior.month, anterior.year);
  } else {
    if (existeDia15ouMaisNoMesAtual) {
      inspecoesFiltradas = rowsMesAtual;
      periodoTexto = labelMesAno(mesAtual, anoAtual);
    } else {
      inspecoesFiltradas = rowsMesAnterior;
      periodoTexto = labelMesAno(anterior.month, anterior.year);
    }
  }

  // Fallback final: se n√£o achou nada no m√™s anterior (muito raro), pega √∫ltimos 1000
  if (!inspecoesFiltradas || inspecoesFiltradas.length === 0) {
    inspecoesFiltradas = rows.slice(-1000);
    periodoTexto = '√öltimos 1000';
  }

  // ===== segue seu c√°lculo original =====
  const totalInspecoes = inspecoesFiltradas.length;
  const autos = inspecoesFiltradas.filter(row => row.TIPO && row.TIPO.includes('AUTO DE INFRA√á√ÉO')).length;

  const fiscaisSet = new Set();
  inspecoesFiltradas.forEach(row => {
  if (row.Fiscal1 && row.Fiscal1.trim()) fiscaisSet.add(row.Fiscal1.trim());
  if (row.Fiscal2 && row.Fiscal2.trim()) fiscaisSet.add(row.Fiscal2.trim());
  if (row.Fiscal3 && row.Fiscal3.trim()) fiscaisSet.add(row.Fiscal3.trim());
  });
  const totalFiscais = fiscaisSet.size;

  // === CONTAR CADA MODALIDADE SEPARADAMENTE ===
  const denuncias = new Set();
  const requerimentos = new Set();
  const oficios = new Set();
  const protocolos = new Set();

  inspecoesFiltradas.forEach(row => {
    if (row.Denuncia && row.Denuncia.trim() !== '') denuncias.add(row.Denuncia.trim());
    if (row.OS && row.OS.trim() !== '') requerimentos.add(row.OS.trim());
    if (row.Oficio && row.Oficio.trim() !== '') oficios.add(row.Oficio.trim());
    if (row.Protocolo && row.Protocolo.trim() !== '') protocolos.add(row.Protocolo.trim());
  });

  const osDetalhadas = {
    requerimentos: requerimentos.size,
    oficios: oficios.size,
    denuncias: denuncias.size,
    protocolos: protocolos.size,
    total: requerimentos.size + oficios.size + denuncias.size + protocolos.size
  };



  const tiposDocumentos = {};
  inspecoesFiltradas.forEach(row => {
   if (row.TIPO && row.TIPO.trim()) {
      tiposDocumentos[row.TIPO.trim()] = (tiposDocumentos[row.TIPO.trim()] || 0) + 1;

    }
  });

  const topTipos = Object.entries(tiposDocumentos).sort((a, b) => b[1] - a[1]).slice(0, 5);
  const mediaPorFiscal = totalFiscais > 0 ? Math.round(totalInspecoes / totalFiscais) : 0;
  const taxaAutos = totalInspecoes > 0 ? ((autos / totalInspecoes) * 100).toFixed(1) : 0;

  renderizarIndicadores(container, {
    totalInspecoes,
    autos,
    totalFiscais,
    osDetalhadas,
    mediaPorFiscal,
    taxaAutos,
    topTipos,
    periodoTexto
  });
}



function renderizarIndicadores(container, dados) {
  // INDICADORES INICIAIS COMO TABELA COMPACTA (estilo padronizado)
  let html = '<table style="width: 100%; font-size: 0.875rem; border-collapse: collapse; margin-bottom: 8px;">' +
    '<tr style="border-bottom: 1px solid rgba(0,0,0,0.05);"><td style="padding: 8px 4px;">üìä Inspe√ß√µes</td><td style="text-align: right; font-weight: 600; color: #2c5aa0;">' + dados.totalInspecoes + ' <small style="color: var(--muted); font-weight: normal;">‚Ä¢ M√©dia ' + dados.mediaPorFiscal + '/fiscal</small></td></tr>' +
    '<tr style="border-bottom: 1px solid rgba(0,0,0,0.05);"><td style="padding: 8px 4px;">üìã Autos</td><td style="text-align: right; font-weight: 600; color: #2c5aa0;">' + dados.autos + ' <small style="color: var(--muted); font-weight: normal;">‚Ä¢ Taxa ' + dados.taxaAutos + '%</small></td></tr>' +
    '<tr><td style="padding: 8px 4px;">üë• Fiscais Ativos</td><td style="text-align: right; font-weight: 600; color: #2c5aa0;">' + dados.totalFiscais + '</td></tr>' +
    '</table>' +

    // Linha de separa√ß√£o antes de Ordens de Servi√ßo
    '<div style="border-top: 1px solid rgba(0,0,0,0.08); margin: 20px 0 16px 0;"></div>' +

    // Se√ß√£o Ordens de Servi√ßo
    '<div style="margin-top: 0px; padding-top: 0px;">' +
      '<h4 style="margin: 0 0 12px 0; color: #2c5aa0; font-size: 0.95rem; font-weight: 600;">üìù Ordens de Servi√ßo: <strong style="font-size: 0.95rem;">' + dados.osDetalhadas.total + '</strong> <small style="color: var(--muted); font-weight: normal;">Atendidas</small></h4>' +
      '<table style="width: 100%; font-size: 0.875rem; border-collapse: collapse;">' +
        '<tr style="border-bottom: 1px solid rgba(0,0,0,0.05);"><td style="padding: 8px 4px;">üìÑ Requerimento</td><td style="text-align: right; font-weight: 600; color: #2c5aa0;">' + dados.osDetalhadas.requerimentos + '</td></tr>' +
        '<tr style="border-bottom: 1px solid rgba(0,0,0,0.05);"><td style="padding: 8px 4px;">üìÆ Of√≠cio</td><td style="text-align: right; font-weight: 600; color: #2c5aa0;">' + dados.osDetalhadas.oficios + '</td></tr>' +
        '<tr style="border-bottom: 1px solid rgba(0,0,0,0.05);"><td style="padding: 8px 4px;">üîî Den√∫ncia</td><td style="text-align: right; font-weight: 600; color: #2c5aa0;">' + dados.osDetalhadas.denuncias + '</td></tr>' +
        '<tr><td style="padding: 8px 4px;">üìã Protocolo</td><td style="text-align: right; font-weight: 600; color: #2c5aa0;">' + dados.osDetalhadas.protocolos + '</td></tr>' +
      '</table>' +
    '</div>' +
    '<div style="border-top: 1px solid rgba(0,0,0,0.08); margin: 20px 0 16px 0;"></div>' +
    
    // Se√ß√£o Tipos de Documentos
    '<div style="margin-top: 8px; padding-top: 0px;">' +
      '<h4 style="margin: 0 0 12px 0; color: #2c5aa0; font-size: 0.95rem; font-weight: 600;">üìÑ Tipos de Documentos: <strong style="font-size: 0.95rem;">' + dados.totalInspecoes + '</strong> <small style="color: var(--muted); font-weight: normal;">Total</small></h4>' +
      '<table style="width: 100%; font-size: 0.875rem; border-collapse: collapse;">';

  // Fun√ß√£o auxiliar para converter para Title Case
  function toTitleCase(str) {
    var minusculas = ['de', 'da', 'do', 'das', 'dos', 'e', 'em', 'a', 'o'];
    return str.toLowerCase().split(' ').map(function(palavra, indice) {
      if (indice === 0) {
        return palavra.charAt(0).toUpperCase() + palavra.slice(1);
      }
      if (minusculas.indexOf(palavra) > -1) {
        return palavra;
      }
      return palavra.charAt(0).toUpperCase() + palavra.slice(1);
    }).join(' ');
  }

  // Mapear tipos de documentos para √≠cones
  function getIconeDocumento(tipo) {
    var tipoLower = tipo.toLowerCase();
    if (tipoLower.indexOf('intima√ß√£o') > -1 || tipoLower.indexOf('intimacao') > -1) return '‚ö†Ô∏è';
    if (tipoLower.indexOf('notifica√ß√£o') > -1 || tipoLower.indexOf('notificacao') > -1) return 'üì¢';
    if (tipoLower.indexOf('certid√£o') > -1 || tipoLower.indexOf('certidao') > -1) return 'üìú';
    if (tipoLower.indexOf('an√°lise') > -1 || tipoLower.indexOf('analise') > -1) return 'üîç';
    if (tipoLower.indexOf('prorroga√ß√£o') > -1 || tipoLower.indexOf('prorrogacao') > -1) return '‚è≥';
    if (tipoLower.indexOf('auto') > -1) return 'üìã';
    if (tipoLower.indexOf('alvar√°') > -1 || tipoLower.indexOf('alvara') > -1) return '‚úÖ';
    if (tipoLower.indexOf('relat√≥rio') > -1 || tipoLower.indexOf('relatorio') > -1) return 'üìä';
    if (tipoLower.indexOf('of√≠cio') > -1 || tipoLower.indexOf('oficio') > -1) return 'üìÆ';
    return 'üìÑ';
  }

  // Processar cada tipo de documento
  dados.topTipos.forEach(function(item, index) {
    var nomeOriginal = item[0];
    var quantidade = item[1];
    var nomeFormatado = toTitleCase(nomeOriginal);
    if (nomeFormatado.length > 32) {
      nomeFormatado = nomeFormatado.substring(0, 29) + '...';
    }
    var icone = getIconeDocumento(nomeOriginal);
    var estiloBorda = (index < dados.topTipos.length - 1) ? 'border-bottom: 1px solid rgba(0,0,0,0.05);' : '';
    html += '<tr style="' + estiloBorda + '"><td style="padding: 8px 4px;">' + icone + ' ' + nomeFormatado + '</td><td style="text-align: right; font-weight: 600; color: #2c5aa0;">' + quantidade + '</td></tr>';
  });

  // Fechar tabela de tipos
  html += '</table></div>';

  // Data/per√≠odo NO FINAL - Alinhada √† direita
  html += '<div style="margin-top: 20px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.08); text-align: right; font-size: 0.85rem; color: var(--muted);">üìÖ ' + dados.periodoTexto + ' ‚Ä¢ üîÑ Atualizado</div>';

  container.innerHTML = html;
}


if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', carregarIndicadores);
} else {
  carregarIndicadores();
}
</script>

</body>
</html>
