<!DOCTYPE html>
<html lang="pt-BR">
<head>

<link rel="stylesheet" href="./css/design-tokens.css">
  
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta property="og:title" content="Vigil√¢ncia Sanit√°ria de An√°polis">
<meta property="og:description" content="Aplicativo interno da Vigil√¢ncia Sanit√°ria">
<meta property="og:image" content="https://garrado.github.io/VISA/icons/visa-compartilhar.png">
<meta property="og:url" content="https://garrado.github.io/VISA/">
<meta property="og:type" content="website">

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#004aad">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="icons/visa-192.png">

<title>Vigil√¢ncia Sanit√°ria</title>

<!-- PapaParse para CSV -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
:root{
  --input-bg: #ffffff;
  --input-border: rgba(0, 0, 0, 0.23);
  --input-focus: #2c5aa0;
  --input-text: #1a202c;
  --input-placeholder: #a0aec0;
  --input-disabled-bg: #f5f7fa;
  --input-disabled-text: #a0aec0;

  --brand1:#2c5aa0;
  --brand2:#3d6bb3;
  --bg:#f2f4f8;
  --text:#1f2a3a;
  --muted:#5b6b83;
  --card:#ffffff;
  --line:rgba(31,42,58,.10);
  --shadow:0 10px 28px rgba(0,0,0,.08);
  --shadow2:0 6px 16px rgba(0,0,0,.08);
  --warnBg:#fff7dd;
  --warnLine:#d1a000;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(44, 90, 160, 0.95);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  color: white;
}

.loading-spinner {
  border: 5px solid rgba(255,255,255,0.3);
  border-top: 5px solid white;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

header {
  background: var(--card);
  padding: 30px;
  border-radius: 12px;
  margin-bottom: 30px;
  box-shadow: var(--shadow);
}

header h1 {
  color: var(--brand1);
  font-size: 32px;
  margin-bottom: 5px;
}

header p {
  color: var(--muted);
  font-size: 16px;
}

.menu {
  background: var(--card);
  padding: 15px 30px;
  border-radius: 12px;
  margin-bottom: 30px;
  box-shadow: var(--shadow2);
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.menu a, .menu button {
  display: inline-block;
  padding: 10px 20px;
  background: var(--brand1);
  color: white;
  text-decoration: none;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 14px;
}

.menu a:hover, .menu button:hover {
  background: var(--brand2);
  transform: translateY(-2px);
}

.indicadores {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.card {
  background: var(--card);
  padding: 25px;
  border-radius: 12px;
  box-shadow: var(--shadow2);
  transition: transform 0.3s;
}

.card:hover {
  transform: translateY(-5px);
}

.card h3 {
  color: var(--text);
  font-size: 18px;
  margin-bottom: 15px;
  border-bottom: 2px solid var(--brand1);
  padding-bottom: 10px;
}

.card .numero {
  font-size: 42px;
  font-weight: bold;
  color: var(--brand1);
  margin: 15px 0;
}

.card .subtitulo {
  color: var(--muted);
  font-size: 14px;
  margin-top: -10px;
}

.card .lista {
  max-height: 300px;
  overflow-y: auto;
}

.card .lista p {
  padding: 8px 0;
  border-bottom: 1px solid var(--line);
  color: var(--text);
  font-size: 14px;
}

.card .lista p:last-child {
  border-bottom: none;
}

.aviso {
  background: var(--warnBg);
  border-left: 4px solid var(--warnLine);
  padding: 20px;
  border-radius: 8px;
  margin: 20px 0;
}

.aviso h3 {
  color: var(--warnLine);
  margin-bottom: 10px;
}
</style>
</head>
<body>
  
  <div id="loading" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p style="font-size: 18px; margin-top: 10px;">Carregando dados...</p>
  </div>

  <div class="container" style="display: none;" id="conteudo">
    <header>
      <h1>üìä Vigil√¢ncia Sanit√°ria - An√°polis/GO</h1>
      <p>Sistema de Controle e Monitoramento CVS</p>
    </header>
    
    <div class="menu">
      <a href="index.html">üìä Dashboard</a>
      <a href="rpf2.html">üìã Relat√≥rio de Inspe√ß√µes</a>
      <button onclick="atualizarDados()">üîÑ Atualizar</button>
    </div>

    <div class="aviso">
      <h3>‚ö†Ô∏è Feliz 2026</h3>
      <p>Desejamos a todos um Feliz 2026.</p>
      <p><strong>Supervisor de Vigil√¢ncia Sanit√°ria</strong></p>
      <p>Esta p√°gina interna da Ger√™ncia de Vigil√¢ncia Sanit√°ria re√∫ne informa√ß√µes, links e comunicados destinados aos servidores, com o objetivo de apoiar as atividades de fiscaliza√ß√£o sanit√°ria, promovendo a qualidade das a√ß√µes fiscalizat√≥rias e a melhor organiza√ß√£o da comunica√ß√£o e do acesso a dados operacionais.</p>
    </div>
    
    <div class="indicadores">
      <!-- Card 1: Total de Inspe√ß√µes -->
      <div class="card">
        <h3>Inspe√ß√µes do Per√≠odo</h3>
        <div class="numero" id="total-inspecoes">-</div>
        <p class="subtitulo" id="periodo-texto">Calculando...</p>
      </div>
      
      <!-- Card 2: Autos de Infra√ß√£o -->
      <div class="card">
        <h3>Autos de Infra√ß√£o</h3>
        <div class="numero" id="total-autos">-</div>
        <p class="subtitulo">Do per√≠odo</p>
      </div>
      
      <!-- Card 3: Tipos de Documento -->
      <div class="card">
        <h3>Documentos Emitidos</h3>
        <div class="lista" id="tipos-documento">
          <p>Carregando...</p>
        </div>
      </div>
      
      <!-- Card 4: Fiscais -->
      <div class="card">
        <h3>Fiscais Atuantes</h3>
        <div class="lista" id="fiscais-ativos">
          <p>Carregando...</p>
        </div>
      </div>
      
      <!-- Card 5: CNAEs -->
      <div class="card">
        <h3>CNAEs Mais Inspecionados</h3>
        <div class="lista" id="top-cnaes">
          <p>Carregando...</p>
        </div>
      </div>
      
      <!-- Card 6: Modalidades -->
      <div class="card">
        <h3>Modalidades</h3>
        <div class="lista" id="modalidades">
          <p>Carregando...</p>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // ============================================
    // CONFIGURA√á√ÉO CSV
    // ============================================
    const CSV_CONFIG = {
      delimiter: ";",
      header: true,
      skipEmptyLines: true,
      encoding: 'UTF-8',
      transformHeader: function(header) {
        return header.replace(/^\uFEFF/, '');
      }
    };

    // ============================================
    // FUN√á√ïES AUXILIARES
    // ============================================
    function parseDateBR(dateStr) {
      if (!dateStr) return null;
      const partes = String(dateStr).split('.');
      if (partes.length !== 3) return null;
      const [dia, mes, ano] = partes.map(p => parseInt(p, 10));
      if (!dia || !mes || !ano) return null;
      return { day: dia, month: mes, year: ano };
    }

    function keyMesAno(mes, ano) {
      const m = String(mes).padStart(2, '0');
      return `${m}.${ano}`;
    }

    function prevMesAno(mes, ano) {
      if (mes === 1) {
        return { month: 12, year: ano - 1 };
      }
      return { month: mes - 1, year: ano };
    }

    function labelMesAno(mes, ano) {
      const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
      return `${meses[mes - 1]}/${ano}`;
    }

    // ============================================
    // CARREGAR CSV
    // ============================================
    async function carregarInspecoes() {
      try {
        console.log('Carregando inspe√ß√µes...');
        
        const response = await fetch('data/inspecoes.csv');
        if (!response.ok) {
          throw new Error('Erro ao buscar arquivo de inspe√ß√µes');
        }
        
        const csvText = await response.text();
        const parsed = Papa.parse(csvText, CSV_CONFIG);
        
        console.log('Inspe√ß√µes carregadas:', parsed.data.length);
        return parsed.data;
        
      } catch (error) {
        console.error('Erro ao carregar inspe√ß√µes:', error);
        throw error;
      }
    }

    // ============================================
    // REGRA DO M√äS AVALIADO
    // ============================================
    function aplicarRegraDoMes(inspecoes) {
      const hoje = new Date();
      const hojeDia = hoje.getDate();
      const mesAtual = hoje.getMonth() + 1; // 1..12
      const anoAtual = hoje.getFullYear();

      const atualKey = keyMesAno(mesAtual, anoAtual);
      const anterior = prevMesAno(mesAtual, anoAtual);
      const anteriorKey = keyMesAno(anterior.month, anterior.year);

      // Filtra por m√™s atual e anterior
      const rowsMesAtual = inspecoes.filter(insp => 
        insp.DT_VISITA && String(insp.DT_VISITA).includes(atualKey)
      );
      
      const rowsMesAnterior = inspecoes.filter(insp =>
        insp.DT_VISITA && String(insp.DT_VISITA).includes(anteriorKey)
      );

      // Verifica se j√° existe inspe√ß√£o com dia >= 25 no m√™s atual
      const existeDia25ouMaisNoMesAtual = rowsMesAtual.some(insp => {
        const dmy = parseDateBR(insp.DT_VISITA);
        return dmy && dmy.year === anoAtual && dmy.month === mesAtual && dmy.day >= 25;
      });

      // === DECIS√ÉO FINAL ===
      let inspecoesFiltradas;
      let periodoTexto;

      if (hojeDia < 15) {
        // Antes do dia 15: mostra m√™s anterior
        inspecoesFiltradas = rowsMesAnterior;
        periodoTexto = labelMesAno(anterior.month, anterior.year);
      } else {
        // Dia 15 ou depois: verifica se tem inspe√ß√£o >= dia 25 no m√™s atual
        if (existeDia25ouMaisNoMesAtual) {
          inspecoesFiltradas = rowsMesAtual;
          periodoTexto = labelMesAno(mesAtual, anoAtual);
        } else {
          inspecoesFiltradas = rowsMesAnterior;
          periodoTexto = labelMesAno(anterior.month, anterior.year);
        }
      }

      // Fallback: se n√£o achou nada, pega √∫ltimos 1000
      if (!inspecoesFiltradas || inspecoesFiltradas.length === 0) {
        inspecoesFiltradas = inspecoes.slice(-1000);
        periodoTexto = '√öltimos 1000';
      }

      return { inspecoes: inspecoesFiltradas, periodo: periodoTexto };
    }

    // ============================================
    // INICIALIZAR DASHBOARD
    // ============================================
    async function init() {
      try {
        const todasInspecoes = await carregarInspecoes();
        
        // Aplicar regra do m√™s
        const { inspecoes, periodo } = aplicarRegraDoMes(todasInspecoes);
        
        console.log('Per√≠odo avaliado:', periodo);
        console.log('Inspe√ß√µes filtradas:', inspecoes.length);
        
        // 1. TOTAL DE INSPE√á√ïES DO PER√çODO
        document.getElementById('total-inspecoes').textContent = 
          inspecoes.length.toLocaleString('pt-BR');
        document.getElementById('periodo-texto').textContent = periodo;
        
        // 2. AUTOS DE INFRA√á√ÉO
        const autos = inspecoes.filter(insp => 
          insp.TIPO && insp.TIPO.toUpperCase().includes('AUTO')
        ).length;
        document.getElementById('total-autos').textContent = 
          autos.toLocaleString('pt-BR');
        
        // 3. TIPOS DE DOCUMENTO
        const tiposDoc = {};
        inspecoes.forEach(insp => {
          const tipo = insp.TIPO || 'Sem classifica√ß√£o';
          tiposDoc[tipo] = (tiposDoc[tipo] || 0) + 1;
        });
        
        const docHTML = Object.entries(tiposDoc)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10)
          .map(([tipo, qtd]) => 
            `<p><strong>${tipo}:</strong> ${qtd.toLocaleString('pt-BR')}</p>`
          )
          .join('');
        document.getElementById('tipos-documento').innerHTML = docHTML;
        
        // 4. FISCAIS ATIVOS
        const fiscais = {};
        inspecoes.forEach(insp => {
          const fiscal = insp.Fiscal1 || 'Sem fiscal';
          if (fiscal !== 'Sem fiscal') {
            fiscais[fiscal] = (fiscais[fiscal] || 0) + 1;
          }
        });
        
        const fiscalHTML = Object.entries(fiscais)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10)
          .map(([fiscal, qtd]) => 
            `<p><strong>${fiscal}:</strong> ${qtd.toLocaleString('pt-BR')}</p>`
          )
          .join('');
        document.getElementById('fiscais-ativos').innerHTML = fiscalHTML;
        
        // 5. CNAEs
        const cnaeCount = {};
        inspecoes.forEach(insp => {
          const cnae = insp.Atividade || 'Sem CNAE';
          if (cnae !== 'Sem CNAE') {
            cnaeCount[cnae] = (cnaeCount[cnae] || 0) + 1;
          }
        });
        
        const cnaeHTML = Object.entries(cnaeCount)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10)
          .map(([cnae, qtd]) => 
            `<p><strong>${cnae}:</strong> ${qtd.toLocaleString('pt-BR')}</p>`
          )
          .join('');
        document.getElementById('top-cnaes').innerHTML = cnaeHTML;
        
        // 6. MODALIDADES
        const modalidades = {};
        inspecoes.forEach(insp => {
          const modalidade = insp.Modalidade || 'Sem modalidade';
          modalidades[modalidade] = (modalidades[modalidade] || 0) + 1;
        });
        
        const modalidadeHTML = Object.entries(modalidades)
          .sort((a, b) => b[1] - a[1])
          .map(([mod, qtd]) => 
            `<p><strong>${mod}:</strong> ${qtd.toLocaleString('pt-BR')}</p>`
          )
          .join('');
        document.getElementById('modalidades').innerHTML = modalidadeHTML;
        
        // Esconder loading e mostrar conte√∫do
        document.getElementById('loading').style.display = 'none';
        document.getElementById('conteudo').style.display = 'block';
        
      } catch (error) {
        document.getElementById('loading').innerHTML = 
          `<div style="background: #ff4444; padding: 30px; border-radius: 12px; max-width: 500px;">
            <h2 style="margin-bottom: 15px;">‚ö†Ô∏è Erro ao carregar</h2>
            <p>${error.message}</p>
          </div>`;
      }
    }

    function atualizarDados() {
      location.reload();
    }
    
    // Iniciar
    init();
  </script>
</body>
</html>
