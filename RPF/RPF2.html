<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Inspe√ß√µes por Fiscal - VISAM An√°polis</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- DataTables CSS e JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    <!-- PapaParse para ler CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Biblioteca para SHA-256 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Modal de Autentica√ß√£o */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .auth-modal {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .auth-modal h2 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        .auth-modal p {
            color: #6c757d;
            margin-bottom: 25px;
        }

        .auth-modal input {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1.1em;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .auth-modal input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-modal button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-modal button:hover {
            transform: translateY(-2px);
        }

        .auth-error {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 10px;
            display: none;
        }

        .main-content {
            display: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .filters {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 150px;
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.95em;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-search {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-search:active {
            transform: translateY(0);
        }

        .results {
            padding: 30px;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .info-box.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        table.dataTable {
            width: 100% !important;
            border-collapse: collapse;
        }

        table.dataTable thead th {
            background: #667eea;
            color: white;
            font-weight: 600;
            padding: 12px 8px;
            text-align: left;
        }

        table.dataTable tbody td {
            padding: 10px 8px;
            border-bottom: 1px solid #dee2e6;
        }

        table.dataTable tbody tr:hover {
            background-color: #f8f9fa;
        }

        .dataTables_wrapper {
            padding: 0;
        }

        @media (max-width: 1024px) {
            .filter-row {
                grid-template-columns: 1fr;
            }
        }
    
        /* === BOT√ïES DE EXPORTA√á√ÉO === */
        .export-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }

        .export-section h3 {
            color: #333;
            font-size: 1em;
            margin-bottom: 12px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-export {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-pdf { background: #dc3545; }
        .btn-excel { background: #28a745; }
        .btn-word { background: #007bff; }
        .btn-html { background: #fd7e14; }
</style>
    <!-- Bibliotecas de Exporta√ß√£o -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>

</head>
<body>
    <!-- Modal de Autentica√ß√£o -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <h2>üîí Acesso Restrito</h2>
            <p>Digite a senha para acessar o sistema</p>
            <input type="password" id="senhaInput" placeholder="Senha" onkeypress="if(event.key==='Enter') verificarSenha()">
            <button onclick="verificarSenha()">Entrar</button>
            <div class="auth-error" id="authError">‚ùå Senha incorreta! Tente novamente.</div>
        </div>
    </div>

    <!-- Conte√∫do Principal -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <div class="header">
                <h1>üè• Relat√≥rio de Produ√ß√£o Fiscal</h1>
                <p>Vigil√¢ncia Sanit√°ria - An√°polis/GO</p>
            </div>

            <div class="filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="fiscal">Fiscal Sanit√°rio:</label>
                        <select id="fiscal">
                            <option value="">-- Selecione um fiscal --</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="dataInicial">Data Inicial:</label>
                        <input type="date" id="dataInicial">
                    </div>
                    <div class="filter-group">
                        <label for="dataFinal">Data Final:</label>
                        <input type="date" id="dataFinal">
                    </div>
                    <div class="filter-group">
                        <button class="btn-search" onclick="buscarInspecoes()">
                            üîç Buscar
                        </button>
                    </div>
                </div>
            </div>

            
            <!-- Bot√µes de Exporta√ß√£o -->
            <div class="export-section" id="exportSection">
                <h3>üì§ Exportar Resultados</h3>
                <div class="export-buttons">
                    <button class="btn-export btn-pdf" onclick="exportarPDF()">üìÑ PDF</button>
                    <button class="btn-export btn-excel" onclick="exportarExcel()">üìä Excel</button>
                    <button class="btn-export btn-word" onclick="exportarWord()">üìù Word</button>
                    <button class="btn-export btn-html" onclick="exportarHTML()">üåê HTML</button>
                </div>
            </div>

<div class="results">
                <div id="infoBox"></div>
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    Processando dados...
                </div>
                <table id="tabelaInspecoes" class="display" style="display: none; width: 100%;">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo de Documento</th>
                            <th>N¬∫ Doc</th>
                            <th>Raz√£o Social</th>
                            <th>CNAE</th>
                            <th>Complexidade</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURA√á√ÉO DE AUTENTICA√á√ÉO ==========
        // Senha em hash SHA-256 (atual: "visam2025")
        // Para mudar a senha, gere um novo hash em: https://emn178.github.io/online-tools/sha256.html
        const SENHA_HASH = '28a65ab773141d575d9edbd73a1049b604dd7b213f99f9c60023c5e02fc6d143';
        const URL_RETORNO = 'index.html'; // P√°gina de retorno se n√£o autorizado
        let tentativasErradas = 0;
        const MAX_TENTATIVAS = 3;

        // Focar no campo de senha ao carregar
        document.getElementById('senhaInput').focus();

        function verificarSenha() {
            const senhaDigitada = document.getElementById('senhaInput').value;
            const hashDigitado = CryptoJS.SHA256(senhaDigitada).toString();

            if (hashDigitado === SENHA_HASH) {
                // Senha correta - liberar acesso
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                popularFiscais();
                carregarArquivos();
            } else {
                // Senha incorreta
                tentativasErradas++;
                document.getElementById('authError').style.display = 'block';
                document.getElementById('senhaInput').value = '';
                document.getElementById('senhaInput').focus();

                if (tentativasErradas >= MAX_TENTATIVAS) {
                    alert('‚õî Acesso negado! Voc√™ ser√° redirecionado.');
                    window.location.href = URL_RETORNO;
                }
            }
        }

        // ========== SISTEMA PRINCIPAL ==========

        // Lista oficial de fiscais da VISAM An√°polis
        const fiscaisOficiais = [
            "ACADIA DE SOUZA VIEIRA SILVA",
            "ADRIANA CRHISTINA DE REZENDE CARNEIRO",
            "ADRIANE PEREIRA GUIMAR√ÉES",
            "ALINE CASTRO DAMASIO",
            "ANA PAULA RODRIGUES CORR√äA GUIMAR√ÉES",
            "ANGELA RIBEIRO NEVES",
            "ARIANNE FERREIRA VIEIRA",
            "C√âSIO MALAQUIAS",
            "CL√ÅUDIO NASCIMENTO SILVA",
            "CL√ìVIS RAFAEL BORGES FERREIRA",
            "DANIEL SOARES BARBOSA",
            "DANIELA DE ALMEIDA CASTRO",
            "EDSON ARANTES FARIA FILHO",
            "EDUARDO LUCAS MAGALH√ÉES CASTRO",
            "FAB√çOLA PEDROSA PEIXOTO MARQUES",
            "GERALDO EDSON ROSA",
            "GLEICIANE MARIA JOS√â DA SILVA",
            "G√öBIO DIAS PEREIRA",
            "JO√ÉO BATISTA LUCAS DA SILVA REIS",
            "JOSE LUIZ RIBEIRO",
            "JULIANA FERREIRA VITURINO",
            "JULIANA K√äNIA MARTINS DA SILVA",
            "JULIO C√âSAR TELES SPINDOLA",
            "KAMILLA CHRYSTINE ROLIM D. SANTOS GARC√äS",
            "LIDIANE SIM√ïES",
            "LIVIA BRITO",
            "LUCIANA CONSOLA√á√ÉO DOS SANTOS",
            "LUCIANA SANTANA DA ROCHA",
            "LUCIENE DE SOUZA BARBOSA GOMES SILVA",
            "MARCIO HENRIQUE GOMES RODOVALHO",
            "MARIA EDWIGES PINHEIRO DE SOUZA CHAVES",
            "MARINA PERILLO NAVARRETE LAVERS",
            "PATR√çCIA CORDEIRO DE MORAES E SOUZA",
            "PEDRO HENRIQUE AIRES RIBEIRO",
            "RODRIGO ALESSANDRO T√îGO SANTOS",
            "R√öBIA MARA DE FREITAS",
            "SILVIA MARQUES NAVES DA MOTA SOUZA",
            "SIMONE DUARTE GROSSI",
            "TATHIANE PESSOA DE SOUZA",
            "THIAGO GOMES GOBO",
            "VANESSA SANTANA",
            "VIVIANE MANOEL DA SILVA BORGES",
            "VIVIANE MIYADA",
            "WANESSA DE BRITO JORGE"
        ];

        // Vari√°veis globais para armazenar os dados
        let dadosCNAE = [];
        let dadosRegulados = [];
        let dadosInspecoes = [];
        let dataTable = null;

        function popularFiscais() {
            const select = $('#fiscal');
            fiscaisOficiais.forEach(fiscal => {
                select.append(`<option value="${fiscal}">${fiscal}</option>`);
            });
        }

        function carregarArquivos() {
            let arquivosCarregados = 0;
            const totalArquivos = 3;

            // Carregar CNAE
            Papa.parse('CNAE.cvs', {
                download: true,
                header: true,
                delimiter: ';',
                encoding: 'UTF-8',
                complete: function(results) {
                    dadosCNAE = results.data;
                    arquivosCarregados++;
                    verificarCarregamento(arquivosCarregados, totalArquivos);
                }
            });

            // Carregar Regulados
            Papa.parse('Regulados.cvs', {
                download: true,
                header: true,
                delimiter: ';',
                encoding: 'UTF-8',
                complete: function(results) {
                    dadosRegulados = results.data;
                    arquivosCarregados++;
                    verificarCarregamento(arquivosCarregados, totalArquivos);
                }
            });

            // Carregar Inspe√ß√µes
            Papa.parse('inspecoes.cvs', {
                download: true,
                header: true,
                delimiter: ';',
                encoding: 'UTF-8',
                complete: function(results) {
                    dadosInspecoes = results.data;
                    arquivosCarregados++;
                    verificarCarregamento(arquivosCarregados, totalArquivos);
                }
            });
        }

        function verificarCarregamento(carregados, total) {
            if (carregados === total) {
                mostrarInfo('‚úÖ Dados carregados com sucesso! Selecione um fiscal e o per√≠odo para consultar.', 'success');
            }
        }

        function mostrarInfo(mensagem, tipo) {
            const infoBox = $('#infoBox');
            infoBox.removeClass('info-box warning success');
            infoBox.addClass('info-box ' + tipo);
            infoBox.html(mensagem);
            infoBox.show();
        }

        function converterData(dataStr) {
            // Converte dd.mm.yyyy para yyyy-mm-dd
            if (!dataStr || dataStr.trim() === '') return null;
            const partes = dataStr.split('.');
            if (partes.length === 3) {
                return `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
            }
            return null;
        }

        function buscarInspecoes() {
            const fiscalSelecionado = $('#fiscal').val();
            const dataInicial = $('#dataInicial').val();
            const dataFinal = $('#dataFinal').val();

            if (!fiscalSelecionado) {
                mostrarInfo('‚ö†Ô∏è Por favor, selecione um fiscal.', 'warning');
                return;
            }

            if (!dataInicial || !dataFinal) {
                mostrarInfo('‚ö†Ô∏è Por favor, selecione o per√≠odo (data inicial e final).', 'warning');
                return;
            }

            $('#loading').show();
            $('#tabelaInspecoes').hide();
            $('#infoBox').hide();

            // Processar em segundo plano
            setTimeout(() => {
                const resultados = processarInspecoes(fiscalSelecionado, dataInicial, dataFinal);
                exibirResultados(resultados, fiscalSelecionado, dataInicial, dataFinal);
            }, 100);
        }

        function processarInspecoes(fiscal, dataIni, dataFim) {
            const resultados = [];

            dadosInspecoes.forEach(insp => {
                // Verificar se o fiscal participou
                const participou = insp.Fiscal1 === fiscal || 
                                  insp.Fiscal2 === fiscal || 
                                  insp.Fiscal3 === fiscal;

                if (!participou) return;

                // Verificar per√≠odo
                const dataInspecao = converterData(insp.DT_VISITA);
                if (!dataInspecao || dataInspecao < dataIni || dataInspecao > dataFim) return;

                // Buscar dados do regulado
                const regulado = dadosRegulados.find(r => r.CODIGO === insp.CODIGO);
                const razaoSocial = regulado ? regulado.RAZAO : '';

                // Buscar dados do CNAE
                let cnaeSubclasse = '';
                let complexidade = '';

                if (insp.Atividade && insp.Atividade.trim() !== '') {
                    const cnae = dadosCNAE.find(c => c.Subclasse === insp.Atividade.trim());
                    if (cnae) {
                        cnaeSubclasse = cnae.Subclasse;
                        complexidade = cnae.Complexidade;
                    }
                }

                resultados.push({
                    data: dataInspecao,
                    tipo: insp.TIPO || '',
                    numero: insp.NUMERO || '',
                    razao: razaoSocial,
                    cnae: cnaeSubclasse,
                    complexidade: complexidade
                });
            });

            return resultados;
        }

        function exibirResultados(resultados, fiscal, dataIni, dataFim) {
            $('#loading').hide();

            if (resultados.length === 0) {
                mostrarInfo(`‚ùå Nenhuma inspe√ß√£o encontrada para <strong>${fiscal}</strong> no per√≠odo de ${formatarDataBR(dataIni)} a ${formatarDataBR(dataFim)}.`, 'warning');
                $('#tabelaInspecoes').hide();
                return;
            }

            mostrarInfo(`‚úÖ Encontradas <strong>${resultados.length}</strong> inspe√ß√µes de <strong>${fiscal}</strong> no per√≠odo de ${formatarDataBR(dataIni)} a ${formatarDataBR(dataFim)}.`, 'success');

            // Destruir DataTable anterior se existir
            if (dataTable) {
                dataTable.destroy();
            }

            // Limpar tabela
            $('#tabelaInspecoes tbody').empty();

            // Popular tabela
            resultados.forEach(r => {
                $('#tabelaInspecoes tbody').append(`
                    <tr>
                        <td>${formatarDataBR(r.data)}</td>
                        <td>${r.tipo}</td>
                        <td>${r.numero}</td>
                        <td>${r.razao}</td>
                        <td>${r.cnae}</td>
                        <td>${r.complexidade}</td>
                    </tr>
                `);
            });

            // Inicializar DataTable
            $('#tabelaInspecoes').show();
                    document.getElementById('exportSection').style.display = 'block';
            dataTable = $('#tabelaInspecoes').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
                },
                order: [[0, 'desc']],
                pageLength: 25
            });
        }

        function formatarDataBR(dataISO) {
            if (!dataISO) return '';
            const partes = dataISO.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }
    

        // ========== FUN√á√ïES DE EXPORTA√á√ÉO ==========

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            const fiscal = document.getElementById('fiscal').options[document.getElementById('fiscal').selectedIndex].text;
            const dataInicial = document.getElementById('dataInicial').value || 'N/A';
            const dataFinal = document.getElementById('dataFinal').value || 'N/A';
            const hoje = new Date().toISOString().split('T')[0];

            doc.setFontSize(16);
            doc.text('Relat√≥rio de Produ√ß√£o Fiscal - VISAM An√°polis', 14, 15);
            doc.setFontSize(11);
            doc.text(`Fiscal: ${fiscal}`, 14, 22);
            doc.text(`Per√≠odo: ${dataInicial} a ${dataFinal}`, 14, 28);

            const table = $('#tabelaInspecoes').DataTable();
            const dados = table.rows({search: 'applied'}).data().toArray();

            const dadosTabela = dados.map(row => [row[0], row[1], row[2], row[3], row[4], row[5]]);

            doc.autoTable({
                head: [['Data', 'Tipo Doc', 'N¬∫ Doc', 'Raz√£o Social', 'CNAE', 'Complexidade']],
                body: dadosTabela,
                startY: 32,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [102, 126, 234] }
            });

            doc.save(`RPF-${hoje}.pdf`);
        }

        function exportarExcel() {
            const fiscal = document.getElementById('fiscal').options[document.getElementById('fiscal').selectedIndex].text;
            const dataInicial = document.getElementById('dataInicial').value || 'N/A';
            const dataFinal = document.getElementById('dataFinal').value || 'N/A';
            const hoje = new Date().toISOString().split('T')[0];

            const table = $('#tabelaInspecoes').DataTable();
            const dados = table.rows({search: 'applied'}).data().toArray();

            const dadosExcel = [
                ['Relat√≥rio de Produ√ß√£o Fiscal - VISAM An√°polis'],
                [`Fiscal: ${fiscal}`],
                [`Per√≠odo: ${dataInicial} a ${dataFinal}`],
                [],
                ['Data', 'Tipo Documento', 'N¬∫ Doc', 'Raz√£o Social', 'CNAE', 'Complexidade']
            ];

            dados.forEach(row => {
                dadosExcel.push([row[0], row[1], row[2], row[3], row[4], row[5]]);
            });

            const ws = XLSX.utils.aoa_to_sheet(dadosExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Inspe√ß√µes');

            XLSX.writeFile(wb, `RPF-${hoje}.xlsx`);
        }

        function exportarWord() {
            const fiscal = document.getElementById('fiscal').options[document.getElementById('fiscal').selectedIndex].text;
            const dataInicial = document.getElementById('dataInicial').value || 'N/A';
            const dataFinal = document.getElementById('dataFinal').value || 'N/A';
            const hoje = new Date().toISOString().split('T')[0];

            const table = $('#tabelaInspecoes').DataTable();
            const dados = table.rows({search: 'applied'}).data().toArray();

            const rows = dados.map(row => {
                return new docx.TableRow({
                    children: [
                        new docx.TableCell({ children: [new docx.Paragraph(row[0])] }),
                        new docx.TableCell({ children: [new docx.Paragraph(row[1])] }),
                        new docx.TableCell({ children: [new docx.Paragraph(row[2])] }),
                        new docx.TableCell({ children: [new docx.Paragraph(row[3])] }),
                        new docx.TableCell({ children: [new docx.Paragraph(row[4])] }),
                        new docx.TableCell({ children: [new docx.Paragraph(row[5])] })
                    ]
                });
            });

            const tableWord = new docx.Table({
                rows: [
                    new docx.TableRow({
                        children: [
                            new docx.TableCell({ children: [new docx.Paragraph('Data')] }),
                            new docx.TableCell({ children: [new docx.Paragraph('Tipo Doc')] }),
                            new docx.TableCell({ children: [new docx.Paragraph('N¬∫ Doc')] }),
                            new docx.TableCell({ children: [new docx.Paragraph('Raz√£o Social')] }),
                            new docx.TableCell({ children: [new docx.Paragraph('CNAE')] }),
                            new docx.TableCell({ children: [new docx.Paragraph('Complexidade')] })
                        ]
                    }),
                    ...rows
                ]
            });

            const doc = new docx.Document({
                sections: [{
                    properties: {},
                    children: [
                        new docx.Paragraph({
                            text: 'Relat√≥rio de Produ√ß√£o Fiscal - VISAM An√°polis',
                            heading: docx.HeadingLevel.HEADING_1
                        }),
                        new docx.Paragraph(`Fiscal: ${fiscal}`),
                        new docx.Paragraph(`Per√≠odo: ${dataInicial} a ${dataFinal}`),
                        new docx.Paragraph(''),
                        tableWord
                    ]
                }]
            });

            docx.Packer.toBlob(doc).then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `RPF-${hoje}.docx`;
                a.click();
            });
        }

        function exportarHTML() {
            const fiscal = document.getElementById('fiscal').options[document.getElementById('fiscal').selectedIndex].text;
            const dataInicial = document.getElementById('dataInicial').value || 'N/A';
            const dataFinal = document.getElementById('dataFinal').value || 'N/A';
            const hoje = new Date().toISOString().split('T')[0];

            const table = $('#tabelaInspecoes').DataTable();
            const dados = table.rows({search: 'applied'}).data().toArray();

            let html = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio de Produ√ß√£o Fiscal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #667eea; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #667eea; color: white; padding: 10px; text-align: left; }
        td { border: 1px solid #ddd; padding: 8px; }
        tr:nth-child(even) { background: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Relat√≥rio de Produ√ß√£o Fiscal - VISAM An√°polis</h1>
    <p><strong>Fiscal:</strong> ${fiscal}</p>
    <p><strong>Per√≠odo:</strong> ${dataInicial} a ${dataFinal}</p>
    <table>
        <thead>
            <tr>
                <th>Data</th>
                <th>Tipo Documento</th>
                <th>N¬∫ Doc</th>
                <th>Raz√£o Social</th>
                <th>CNAE</th>
                <th>Complexidade</th>
            </tr>
        </thead>
        <tbody>`;

            dados.forEach(row => {
                html += `
            <tr>
                <td>${row[0]}</td>
                <td>${row[1]}</td>
                <td>${row[2]}</td>
                <td>${row[3]}</td>
                <td>${row[4]}</td>
                <td>${row[5]}</td>
            </tr>`;
            });

            html += `
        </tbody>
    </table>
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RPF-${hoje}.html`;
            a.click();
        }

    </script>
</body>
</html>
