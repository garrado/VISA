<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Ordens de Serviço — Vigilância Sanitária</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <!-- CSS GLOBAL PADRÃO -->
  <link rel="stylesheet" href="/VISA/css/regulados.css">
</head>

<body>

  <!-- TOPBAR PADRÃO (IGUAL AO regulados.html) -->
  <header class="topbar">
    <div class="wrap topbar__inner">
      <div class="brand">
        <div class="brand__title">Ordens de Serviço</div>
        <div class="brand__subtitle">
          Consulta de Ordens de Serviço • Vigilância Sanitária
        </div>
      </div>
      <div class="actions">
        <a class="btn btn--ghost" href="/VISA/index.html" aria-label="Voltar ao início">
          ⬅ Voltar
        </a>
      </div>
    </div>
  </header>

  <!-- CONTEÚDO -->
  <main class="wrap">

    <section class="card panel">

      <div class="panel__row">
        <div class="field">
          <label class="label" for="fiscalSelect">Fiscal</label>
          <select id="fiscalSelect" class="input">
            <option value="">(Todos)</option>
          </select>
        </div>

        <div class="field field--grow">
          <label class="label" for="searchInput">
            Busca rápida (OS / Razão Social / CNPJ / Protocolo / IM)
          </label>
          <input id="searchInput" class="input input--big" type="search" placeholder="Digite para filtrar...">
        </div>

        <div class="field">
          <label class="label">&nbsp;</label>
          <button id="clearBtn" class="btn btn--light" type="button">
            Limpar
          </button>
        </div>

        <div class="field">
          <label class="label">&nbsp;</label>
          <button id="exportBtn" class="btn btn--light" type="button">
            Exportar CSV
          </button>
        </div>
      </div>

      <div class="panel__meta">
        <div>
          <span class="badge" id="countBadge">0</span> OS exibidas
        </div>
        <div class="small muted">
          Arquivo gerado a partir do PDF “OS PORTAL SIM”.
        </div>
      </div>

      <div class="tableWrap">
        <table class="table" id="osTable">
          <thead>
            <tr>
              <th>Fiscal</th>
              <th>OS</th>
              <th>Razão Social</th>
              <th>CNPJ</th>
              <th>IM</th>
              <th>Protocolo</th>
              <th>Data</th>
              <th>Limite</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p class="small muted">
        Dica: selecione o fiscal ou utilize a busca rápida. É possível exportar
        apenas os resultados filtrados.
      </p>

    </section>

  </main>

<script>
const data = /* === DADOS MANTIDOS EXATAMENTE COMO NO ARQUIVO ORIGINAL === */ [];
</script>

<script>
/* ===== LÓGICA ORIGINAL (INALTERADA) ===== */
const fiscalSelect = document.getElementById("fiscalSelect");
const searchInput  = document.getElementById("searchInput");
const tbody        = document.querySelector("#osTable tbody");
const countBadge   = document.getElementById("countBadge");

function uniq(arr) {
  return [...new Set(arr)]
    .filter(x => x && x.toString().trim().length>0)
    .sort((a,b)=>a.localeCompare(b,'pt-BR'));
}
function normalize(v) { return (v ?? "").toString().toLowerCase(); }

function fillFiscalOptions() {
  const fiscais = uniq(data.map(r => r.fiscal));
  fiscais.forEach(f => {
    const opt = document.createElement("option");
    opt.value = f;
    opt.textContent = f;
    fiscalSelect.appendChild(opt);
  });
}

function matches(row, fiscalFilter, textFilter) {
  if (fiscalFilter && row.fiscal !== fiscalFilter) return false;
  if (!textFilter) return true;
  const hay = [
    row.fiscal, row.os, row.razao, row.cnpj, row.protocolo, row.im, row.data, row.limite
  ].map(normalize).join(" | ");
  return hay.includes(textFilter);
}

function render() {
  const fiscalFilter = fiscalSelect.value;
  const textFilter = normalize(searchInput.value).trim();

  tbody.innerHTML = "";
  let shown = 0;

  data.forEach(row => {
    if (!matches(row, fiscalFilter, textFilter)) return;
    shown++;

    const tr = document.createElement("tr");
    tr.innerHTML =
      "<td data-label=\"Fiscal\">" + (row.fiscal || "") + "</td>" +
      "<td data-label=\"OS\"><b>" + (row.os || "") + "</b></td>" +
      "<td data-label=\"Razão Social\">" + (row.razao || "") + "</td>" +
      "<td data-label=\"CNPJ\">" + (row.cnpj || "") + "</td>" +
      "<td data-label=\"IM\">" + (row.im || "") + "</td>" +
      "<td data-label=\"Protocolo\">" + (row.protocolo || "") + "</td>" +
      "<td data-label=\"Data\">" + (row.data || "") + "</td>" +
      "<td data-label=\"Limite\">" + (row.limite || "") + "</td>";
    tbody.appendChild(tr);
  });

  countBadge.textContent = shown.toString();
}

function clearFilters() {
  fiscalSelect.value = "";
  searchInput.value = "";
  render();
}

function exportCSV() {
  const fiscalFilter = fiscalSelect.value;
  const textFilter = normalize(searchInput.value).trim();

  const filtered = data.filter(r => matches(r, fiscalFilter, textFilter));
  const headers = ["Fiscal","OS","Razão Social","CNPJ","IM","Protocolo","Data","Limite"];
  const lines = [headers.join(";")];

  filtered.forEach(r => {
    const line = [
      r.fiscal, r.os, r.razao, r.cnpj, r.im, r.protocolo, r.data, r.limite
    ].map(v => '"' + (v ?? "").toString().replaceAll('"','""') + '"').join(";");
    lines.push(line)
