<!DOCTYPE html>
<html lang="pt-BR">
<head>
<!-- ===================================================================
     CSS EXTERNOS - Sistema de Design VISA An√°polis
     Ordem cr√≠tica: tokens ‚Üí base ‚Üí components ‚Üí layouts
     ================================================================ -->
<link rel="stylesheet" href="./css/design-tokens.css">
<link rel="stylesheet" href="./css/base.css">
<link rel="stylesheet" href="./css/components.css">
<link rel="stylesheet" href="./css/layouts.css">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta property="og:title" content="Vigil√¢ncia Sanit√°ria de An√°polis">
<meta property="og:description" content="Aplicativo interno da Vigil√¢ncia Sanit√°ria">
<meta property="og:image" content="https://garrado.github.io/VISA/icons/visa-compartilhar.png">
<meta property="og:url" content="https://garrado.github.io/VISA/">
<meta property="og:type" content="website">

<meta property="og:image:width" content="https://garrado.github.io/VISA/icons/visa-compartilhar.png">
<meta property="og:image:height" content="https://garrado.github.io/VISA/icons/visa-compartilhar.png">
<meta name="apple-touch-icon" content="icons/visa-compartilhar.png">

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#004aad">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icons/visa-192.png">

<title>Vigil√¢ncia Sanit√°ria - An√°polis</title>

<style>
:root{
  
  /* === INPUTS E FORMUL√ÅRIOS (CR√çTICO!) === */
  --input-bg: #ffffff;
  --input-border: rgba(0, 0, 0, 0.23);
  --input-focus: #2c5aa0;
  --input-text: #1a202c;
  --input-placeholder: #a0aec0;
  --input-disabled-bg: #f5f7fa;
  --input-disabled-text: #a0aec0;

  --brand1:#2c5aa0;
  --brand2:#3d6bb3;
  --bg:#f2f4f8;
  --text:#1f2a3a;
  --muted:#5b6b83;
  --card:#ffffff;
  --line:rgba(31,42,58,.10);
  --shadow:0 10px 28px rgba(0,0,0,.08);
  --shadow2:0 6px 16px rgba(0,0,0,.08);
  --warnBg:#fff7dd;
  --warnLine:#d1a000;
  
  --space-1:4px;
  --space-2:8px;
  --space-3:12px;
  --space-4:16px;
  --space-5:20px;
  --space-6:24px;
  --space-8:32px;
  --space-10:40px;
  --radius-sm:4px;
  --radius-md:8px;
  --radius-lg:12px;
  --radius-xl:16px;
  --font-sans:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
  --leading-normal:1.5;
  --leading-tight:1.25;
  --leading-none:1;
  --font-normal:400;
  --font-semibold:600;
  --font-bold:700;
  --font-black:900;
  --transition-fast:150ms cubic-bezier(0.4,0,0.2,1);
  --transition-base:250ms cubic-bezier(0.4,0,0.2,1);
  --transition-slow:350ms cubic-bezier(0.4,0,0.2,1);
}

/* ================================================================
   GARANTIR MAX-WIDTH DO CONTAINER
   O layouts.css j√° tem, mas refor√ßamos para seguran√ßa
   =============================================================== */
.container {
  max-width: 1200px !important;
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{min-height:100vh;font-family:var(--font-sans);background:var(--bg);color:var(--text);line-height:var(--leading-normal);-webkit-font-smoothing:antialiased;}

.header{background:linear-gradient(135deg,#5b8fd9,#7ba7e3);color:#1f2a3a;padding:24px 16px;text-align:center;box-shadow:var(--shadow2);margin-bottom:24px;}
.header h1{font-size:clamp(1.5rem,2.4vw,2rem);font-weight:700;margin:0;letter-spacing:-0.02em;line-height:1.2;}
.header p{margin:8px 0 0;font-size:clamp(0.875rem,1.5vw,1rem);font-weight:400;opacity:.9;color:rgba(31,42,58,.85);line-height:1.3;}

.container{width:100%;max-width:1200px;margin:0 auto;padding:0 16px;}

.filters-card{background:var(--card);border-radius:var(--radius-lg);padding:20px;margin-bottom:20px;box-shadow:var(--shadow);}
.filter-row{display:flex;gap:12px;margin-bottom:12px;}
.filter-row input{flex:1;padding:10px 14px;border:1px solid var(--line);border-radius:var(--radius-md);font-size:15px;background:var(--card);color:var(--text);transition:all var(--transition-fast);}
.filter-row input:focus{outline:none;border-color:var(--brand1);box-shadow:0 0 0 3px rgba(44,90,160,.1);}
.filter-row button{padding:10px 20px;background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff;border:none;border-radius:var(--radius-md);font-weight:600;cursor:pointer;transition:all var(--transition-fast);min-width:120px;}
.filter-row button:hover{transform:translateY(-2px);box-shadow:var(--shadow2);}
.filter-row button:active{transform:translateY(0);}

.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;}
.stat-card{background:linear-gradient(135deg,#f8f9fb,#ffffff);border:1px solid rgba(44,90,160,.15);border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px;text-align:left;}
.stat-icon{font-size:1.6rem;flex-shrink:0;}
.stat-numero{font-size:1.1rem !important;font-weight:700;background:linear-gradient(135deg,var(--brand1),var(--brand2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;margin:4px 0;}
.stat-label{font-size:0.75rem;color:var(--text);font-weight:700;margin:2px 0;}
.stat-detalhe{font-size:0.7rem;color:var(--muted);}
.tipos-table-container h4{margin:16px 0 10px 0;font-size:0.85rem;color:var(--brand1);font-weight:700;text-transform:uppercase;}
.tipos-table{width:100%;border-collapse:collapse;}
.tipos-table td{padding:8px 4px;font-size:0.85rem;}
.tipos-table td:first-child{font-weight:500;}
.tipos-table td:last-child{text-align:right;font-weight:700;color:var(--brand1);min-width:60px;}
.tipo-barra{height:6px;background:rgba(44,90,160,.1);border-radius:3px;margin-top:4px;overflow:hidden;}
.tipo-barra-fill{height:100%;background:linear-gradient(90deg,var(--brand1),var(--brand2));transition:width 0.6s ease;}
.update-info{text-align:center;font-size:0.7rem;color:var(--muted);margin-top:12px;padding-top:10px;border-top:1px solid rgba(0,0,0,0.05);}

@media(max-width:480px){
  .stats-grid{grid-template-columns:1fr;gap:8px;}
  .stat-card{display:flex;align-items:center;gap:12px;text-align:left;}
  .stat-icon{font-size:2rem;}
  .stat-numero{font-size:1.1rem !important;}
}

@media(min-width:481px) and (max-width:768px){
  .stats-grid{grid-template-columns:repeat(2,1fr);gap:8px;}
}

.result-container{background:var(--card);border-radius:var(--radius-lg);padding:20px;box-shadow:var(--shadow);margin-bottom:24px;min-height:200px;}
.loading{text-align:center;padding:40px;color:var(--muted);font-size:0.9rem;}
.loading::before{content:"";display:inline-block;width:20px;height:20px;border:2px solid rgba(44,90,160,.2);border-top-color:var(--brand1);border-radius:50%;animation:spin 0.6s linear infinite;margin-right:8px;}
@keyframes spin{to{transform:rotate(360deg);}}

.warning{background:var(--warnBg);border:1px solid var(--warnLine);border-radius:var(--radius-md);padding:16px;margin-bottom:20px;font-size:0.9rem;color:#856404;}
.warning strong{color:#856404;}

.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-top:24px;}
.menu-item{background:var(--card);border-radius:var(--radius-lg);padding:16px;text-align:center;text-decoration:none;color:var(--text);box-shadow:var(--shadow);transition:all var(--transition-fast);display:flex;flex-direction:column;align-items:center;gap:8px;}
.menu-item:hover{transform:translateY(-4px);box-shadow:var(--shadow2);}
.menu-item .icon{font-size:2rem;}
.menu-item .label{font-size:0.85rem;font-weight:600;}

footer{text-align:center;padding:24px;color:var(--muted);font-size:0.8rem;border-top:1px solid var(--line);margin-top:40px;}

.institucional-banner{background:linear-gradient(135deg,rgba(91,143,217,.95),rgba(123,167,227,.95));color:#1a202c;padding:16px 20px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,.08);width:100%;max-width:100%;box-sizing:border-box;}
.institucional-banner h2{font-size:1.1rem;font-weight:700;margin:0 0 8px 0;color:#1a202c;}
.institucional-banner p{font-size:0.9rem;line-height:1.5;margin:0;color:rgba(26,32,44,.85);}
.institucional-banner p strong{font-weight:700;color:#1a202c;}
</style>

</head>
<body>

<div class="header">
  <h1>üè• Vigil√¢ncia Sanit√°ria</h1>
  <p>Diretoria de Vigil√¢ncia em Sa√∫de ‚Äì An√°polis</p>
</div>

<div class="container">
  
  <div class="institucional-banner">
    <h2>üìã Sistema Integrado de Gest√£o - VISA An√°polis</h2>
    <p>
      <strong>Bem-vindo ao sistema oficial de gerenciamento da Vigil√¢ncia Sanit√°ria de An√°polis.</strong><br>
      Aqui voc√™ encontra relat√≥rios de inspe√ß√µes, dados de regulados, checklists, legisla√ß√£o e ferramentas essenciais para o trabalho da VISA.
    </p>
  </div>

  <div class="filters-card">
    <div class="filter-row">
      <input type="date" id="dataInicio" placeholder="Data In√≠cio">
      <input type="date" id="dataFim" placeholder="Data Fim">
      <button onclick="buscarInspecoes()">üîç Buscar Inspe√ß√µes</button>
    </div>
  </div>

  <div id="avisoContainer"></div>
  <div id="indicadoresContainer" class="result-container"></div>

  <div class="menu-grid">
    <a href="./RPF/RPF2.html" class="menu-item">
      <span class="icon">üìä</span>
      <span class="label">Relat√≥rio RPF</span>
    </a>
    <a href="./regulados.html" class="menu-item">
      <span class="icon">üè¢</span>
      <span class="label">Regulados</span>
    </a>
    <a href="./legislacao.html" class="menu-item">
      <span class="icon">üìú</span>
      <span class="label">Legisla√ß√£o</span>
    </a>
    <a href="./checklists.html" class="menu-item">
      <span class="icon">‚úÖ</span>
      <span class="label">Checklists</span>
    </a>
  </div>

</div>

<footer>
  <p>¬© 2025 Vigil√¢ncia Sanit√°ria de An√°polis | Desenvolvido internamente</p>
</footer>

<!-- ===================================================================
     JAVASCRIPT - Platform Detector + L√≥gica do Index
     ================================================================ -->

<!-- Platform Detector (responsividade iOS/Android/Desktop) -->
<script src="./js/platform-detector.js"></script>

<!-- ‚ö†Ô∏è N√ÉO INCLUIR: -->
<!-- guard.js (index √© p√∫blico, sem autentica√ß√£o) -->
<!-- header-loader.js (header √© manual no index) -->
<!-- regulados.js (espec√≠fico de outra p√°gina) -->

<!-- Script principal do index -->
<script>
const CSV_URL = "./DATA/inspecoes.csv";

const avisoEl = document.getElementById("avisoContainer");
const indicadoresEl = document.getElementById("indicadoresContainer");
const dtInicioEl = document.getElementById("dataInicio");
const dtFimEl = document.getElementById("dataFim");

async function carregarCSV(url){
  const r = await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("Erro ao carregar CSV");
  const txt = await r.text();
  return txt.split('\n').map(line => {
    const arr=[];
    let atual='';
    let dentroAspas=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){
        dentroAspas=!dentroAspas;
      }else if(c===','&&!dentroAspas){
        arr.push(atual.trim());
        atual='';
      }else{
        atual+=c;
      }
    }
    arr.push(atual.trim());
    return arr;
  });
}

function parseDMY(str){
  if(!str) return null;
  const m=String(str).trim().match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})/);
  if(!m) return null;
  const day=parseInt(m[1],10);
  const month=parseInt(m[2],10);
  let year=parseInt(m[3],10);
  if(year<100) year+=2000;
  if(!(day>=1&&day<=31&&month>=1&&month<=12)) return null;
  return{day,month,year};
}

function toDateObj(dmy){
  if(!dmy) return null;
  return new Date(dmy.year,dmy.month-1,dmy.day);
}

function filtrarPorPeriodo(rows,inicio,fim){
  const dIni=inicio?toDateObj(parseDMY(inicio)):null;
  const dFim=fim?toDateObj(parseDMY(fim)):null;
  return rows.filter(row=>{
    const dtStr=row[2];
    if(!dtStr) return false;
    const dmy=parseDMY(dtStr);
    if(!dmy) return false;
    const d=toDateObj(dmy);
    if(!d) return false;
    if(dIni&&d<dIni) return false;
    if(dFim&&d>dFim) return false;
    return true;
  });
}

async function buscarInspecoes(){
  const ini=dtInicioEl.value.trim();
  const fim=dtFimEl.value.trim();

  avisoEl.innerHTML="";
  indicadoresEl.innerHTML='<div class="loading">Carregando dados...</div>';

  try{
    const data=await carregarCSV(CSV_URL);
    if(!data||data.length<2){
      indicadoresEl.innerHTML='<div class="warning"><strong>Aviso:</strong> Nenhum dado encontrado no CSV.</div>';
      return;
    }

    let rows=data.slice(1);
    if(!ini&&!fim){
      avisoEl.innerHTML='<div class="warning"><strong>Aten√ß√£o:</strong> Nenhuma data informada. Exibindo per√≠odo autom√°tico.</div>';
      processarDados(data,indicadoresEl);
    }else{
      const filtradas=filtrarPorPeriodo(rows,ini,fim);
      if(filtradas.length===0){
        indicadoresEl.innerHTML='<div class="warning"><strong>Aviso:</strong> Nenhuma inspe√ß√£o encontrada no per√≠odo informado.</div>';
        return;
      }
      const newData=[data[0],...filtradas];
      processarDados(newData,indicadoresEl);
    }
  }catch(e){
    indicadoresEl.innerHTML='<div class="warning"><strong>Erro:</strong> '+e.message+'</div>';
  }
}

function processarDados(data, container) {
  const rows = data.slice(1);

  // ===== Helpers =====
  const mesesPt = [
    'Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho',
    'Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'
  ];

  const pad2 = (n) => String(n).padStart(2, '0');

  // Extrai {day, month, year} de "DD.MM.YYYY" ou "DD/MM/YYYY" (ou com "-")
  function parseDMY(str) {
    if (!str) return null;
    const m = String(str).trim().match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})/);
    if (!m) return null;
    const day = parseInt(m[1], 10);
    const month = parseInt(m[2], 10);
    let year = parseInt(m[3], 10);
    if (year < 100) year += 2000; // caso venha "26" em vez de "2026"
    if (!(day >= 1 && day <= 31 && month >= 1 && month <= 12)) return null;
    return { day, month, year };
  }

  function labelMesAno(month, year) {
    return `${mesesPt[month - 1]} ${year}`;
  }

  function prevMesAno(month, year) {
    if (month === 1) return { month: 12, year: year - 1 };
    return { month: month - 1, year };
  }

  function keyMesAno(month, year) {
    return `${pad2(month)}.${year}`; // ex: "01.2026"
  }

  // ===== Regra do m√™s avaliado =====
  const hoje = new Date(); // data do dispositivo (web/pwa)
  const hojeDia = hoje.getDate();
  const mesAtual = hoje.getMonth() + 1; // 1..12
  const anoAtual = hoje.getFullYear();

  const atualKey = keyMesAno(mesAtual, anoAtual);
  const anterior = prevMesAno(mesAtual, anoAtual);
  const anteriorKey = keyMesAno(anterior.month, anterior.year);

  // Filtra linhas do m√™s atual e do m√™s anterior (baseado no "MM.AAAA" presente na data)
  const rowsMesAtual = rows.filter(row => row[2] && String(row[2]).includes(atualKey));
  const rowsMesAnterior = rows.filter(row => row[2] && String(row[2]).includes(anteriorKey));

  // Verifica se no m√™s atual j√° existem inspe√ß√µes "a partir do dia 25" (>= 25)
  const existeDia25ouMaisNoMesAtual = rowsMesAtual.some(row => {
    const dmy = parseDMY(row[2]);
    return dmy && dmy.year === anoAtual && dmy.month === mesAtual && dmy.day >= 25;
  });

  // === Decis√£o final ===
  // 1) Enquanto N√ÉO chegar no dia 25 do m√™s corrente, mostra m√™s anterior.
  // 2) Depois do dia 25, s√≥ troca para o m√™s corrente se j√° existirem inspe√ß√µes com dia >= 25 nesse m√™s.
  let inspecoesFiltradas;
  let periodoTexto;

  if (hojeDia < 15) {
    inspecoesFiltradas = rowsMesAnterior;
    periodoTexto = labelMesAno(anterior.month, anterior.year);
  } else {
    if (existeDia25ouMaisNoMesAtual) {
      inspecoesFiltradas = rowsMesAtual;
      periodoTexto = labelMesAno(mesAtual, anoAtual);
    } else {
      inspecoesFiltradas = rowsMesAnterior;
      periodoTexto = labelMesAno(anterior.month, anterior.year);
    }
  }

  // Fallback final: se n√£o achou nada no m√™s anterior (muito raro), pega √∫ltimos 1000
  if (!inspecoesFiltradas || inspecoesFiltradas.length === 0) {
    inspecoesFiltradas = rows.slice(-1000);
    periodoTexto = '√öltimos 1000';
  }

  // ===== segue seu c√°lculo original =====
  const totalInspecoes = inspecoesFiltradas.length;
  const autos = inspecoesFiltradas.filter(row => row[6] && row[6].includes('AUTO DE IMPOSI√á√ÉO')).length;

  const fiscaisSet = new Set();
  inspecoesFiltradas.forEach(row => {
    if (row[17] && row[17].trim()) fiscaisSet.add(row[17].trim());
  });
  const totalFiscais = fiscaisSet.size;

  // === CONTAR OS (ORDENS DE SERVI√áO) √öNICAS ===
  const osSet = new Set();
  inspecoesFiltradas.forEach(row => {
    // Modalidade: Den√∫ncia ‚Üí Campo CSV: Denuncia [11]
    if (row[11] && row[11].trim() !== '') {
      osSet.add(row[11].trim());
    }
    // Modalidade: Requerimento ‚Üí Campo CSV: OS [12]
    if (row[12] && row[12].trim() !== '') {
      osSet.add(row[12].trim());
    }
    // Modalidade: Of√≠cio ‚Üí Campo CSV: Oficio [13]
    if (row[13] && row[13].trim() !== '') {
      osSet.add(row[13].trim());
    }
    // Modalidade: Protocolo ‚Üí Campo CSV: Protocolo [14]
    if (row[14] && row[14].trim() !== '') {
      osSet.add(row[14].trim());
    }
  });
  const totalOSUnicas = osSet.size;

  const tiposDocumentos = {};
  inspecoesFiltradas.forEach(row => {
    if (row[6] && row[6].trim()) {
      tiposDocumentos[row[6].trim()] = (tiposDocumentos[row[6].trim()] || 0) + 1;
    }
  });

  const topTipos = Object.entries(tiposDocumentos).sort((a, b) => b[1] - a[1]).slice(0, 5);
  const mediaPorFiscal = totalFiscais > 0 ? Math.round(totalInspecoes / totalFiscais) : 0;
  const taxaAutos = totalInspecoes > 0 ? ((autos / totalInspecoes) * 100).toFixed(1) : 0;

  renderizarIndicadores(container, {
    totalInspecoes, autos, totalFiscais, totalOSUnicas, mediaPorFiscal, taxaAutos, topTipos, periodoTexto
  });
}



function renderizarIndicadores(container, dados) {
  let html = '<div class="stats-grid">' +
    '<div class="stat-card"><div class="stat-icon">üìä</div><div><div class="stat-numero">' + dados.totalInspecoes + '</div><div class="stat-label">Inspe√ß√µes</div><div class="stat-detalhe">M√©dia ' + dados.mediaPorFiscal + '/fiscal</div></div></div>' +
    '<div class="stat-card"><div class="stat-icon">üìã</div><div><div class="stat-numero">' + dados.autos + '</div><div class="stat-label">Autos</div><div class="stat-detalhe">Taxa ' + dados.taxaAutos + '%</div></div></div>' +
    '<div class="stat-card"><div class="stat-icon">üë•</div><div><div class="stat-numero">' + dados.totalFiscais + '</div><div class="stat-label">Fiscais</div><div class="stat-detalhe">Ativos</div></div></div>' +
    '<div class="stat-card"><div class="stat-icon">üìù</div><div><div class="stat-numero">' + dados.totalOSUnicas + '</div><div class="stat-label">OS</div><div class="stat-detalhe">Atendidas</div></div></div>' +
    '</div><br>' +
    '<div class="tipos-table-container"><h4>üìÑ Tipos de Documentos</h4><table class="tipos-table">';
  
  dados.topTipos.forEach(function(item) {
    const porcentagem = ((item[1] / dados.totalInspecoes) * 100).toFixed(0);
    let nome = item[0];
    if (nome.length > 28) nome = nome.substring(0, 25) + '...';
    html += '<tr><td>' + nome + '<div class="tipo-barra"><div class="tipo-barra-fill" style="width:' + porcentagem + '%;"></div></div></td><td style="padding-left:40px !important">' + item[1] + '</td></tr>';
  });

  html += '</table></div><div class="update-info">üìÖ ' + dados.periodoTexto + ' ‚Ä¢ üîÑ Atualizado</div>';
  container.innerHTML = html;
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => buscarInspecoes());
} else {
  buscarInspecoes();
}
</script>

</body>
</html>
