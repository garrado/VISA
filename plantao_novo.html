<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escala de Plantão - VISA Anápolis</title>

  <!-- Design System -->
  <link rel="stylesheet" href="./css/design-tokens.css">

  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

  <style>
    body { margin:0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .hero{
      background: linear-gradient(180deg, rgba(26,58,107,.95), rgba(26,58,107,.88));
      border-radius: 16px;
      padding: 16px;
      color: #fff;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
    }
    .heroTop{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .heroTitle{ font-size: 18px; font-weight: 800; margin:0; }
    .heroSub{ margin:6px 0 0; opacity:.92; font-weight:600; }
    .btnOk{
      background:#18a957; color:#fff; border:0; border-radius:12px;
      padding:10px 14px; font-weight:800; cursor:pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,.18); white-space:nowrap;
    }
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      margin-top: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.06);
    }
    .card h2{ margin:0 0 10px; font-size: 15px; }
    .filters{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      align-items: end;
    }
    .fItem label{ display:block; font-size:12px; font-weight:800; margin-bottom:6px; opacity:.9; }
    .fItem input, .fItem select{
      width:100%;
      border:1px solid var(--line);
      background: var(--bg);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
    }
    .hint{ font-size:12px; opacity:.85; margin-top:8px; }
    .tableWrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
    table.dataTable thead th{ white-space:nowrap; }
    .badge{
      display:inline-block; padding:4px 10px; border-radius:999px;
      font-size:12px; font-weight:800; background: rgba(26,58,107,.10);
      border: 1px solid var(--line);
    }
    .noPlantao{ background: rgba(220, 38, 38, 0.06); }
    .noPlantao td{ font-weight:800; }
    .mini{ font-size:12px; opacity:.9; }
    @media (max-width: 860px){
      .filters{ grid-template-columns: 1fr; }
      .heroTop{ gap: 10px; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="hero">
      <div class="heroTop">
        <div>
          <p class="heroTitle">Escala de Plantão — VISA Anápolis</p>
          <p class="heroSub">Consulta mensal com totalização automática (Horário de Brasília – UTC−3)</p>
        </div>
        <button class="btnOk" onclick="goBack()">OK — Voltar</button>
      </div>
    </div>

    <div class="card">
      <h2>Filtros</h2>
      <div class="filters">
        <div class="fItem">
          <label for="mesRef">Mês/Ano</label>
          <input id="mesRef" type="month" />
        </div>
        <div class="fItem">
          <label for="fiscalRef">Fiscal</label>
          <select id="fiscalRef">
            <option value="">(Todos)</option>
          </select>
        </div>
        <div class="fItem">
          <label for="dataRef">Data</label>
          <input id="dataRef" type="date" />
        </div>
      </div>
      <div class="hint">
        Plantão: segunda a sexta. Sem plantão em feriados/pontos facultativos. Sem conflito com veículos.
      </div>
    </div>

    <div class="card">
      <h2>Escala do mês <span id="badgeMes" class="badge"></span></h2>
      <div class="tableWrap">
        <table id="tabelaPlantao" class="display" style="width:100%">
          <thead>
            <tr>
              <th>Data</th>
              <th>Dia</th>
              <th>Matutino (30h)</th>
              <th>Vespertino (30h)</th>
              <th>Dia Todo (40h)</th>
              <th>Obs.</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="mini" style="margin-top:10px;">
        Observação: quando um fiscal fizer <b>2 plantões</b> no mês, manter intervalo mínimo de <b>15 dias</b>.
      </div>
    </div>

    <div class="card">
      <h2>Totalização automática</h2>
      <div class="tableWrap">
        <table id="tabelaTotal" class="display" style="width:100%">
          <thead>
            <tr>
              <th>Fiscal</th>
              <th>Qtd. Plantões</th>
              <th>Datas</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="mini" style="margin-top:10px;">
        Regra anual: os fiscais que fizerem <b>mais de 1 plantão</b> no mês devem ser <b>revezados</b> no mês subsequente (evitar sempre os mesmos).
      </div>
    </div>

    <div class="card">
      <h2>Regras (base executável)</h2>
      <details>
        <summary style="cursor:pointer; font-weight:800;">Exibir regras</summary>
        <div style="margin-top:10px; line-height:1.45;">
          <ol>
            <li><b>Escopo:</b> Plantão somente de segunda a sexta; excluir feriados e pontos facultativos.</li>
            <li><b>Configuração:</b> adicionar feriados municipais e pontos facultativos extras via variáveis internas.</li>
            <li><b>Elegibilidade:</b> todos os fiscais aptos devem fazer pelo menos 1 plantão no mês, exceto quem tiver <b>mais de 20 dias de férias</b> no mês. <b>Thiago</b> não entra na escala (função administrativa).</li>
            <li><b>30h:</b> fazem <b>apenas 1 plantão</b> no mês (sem repetição). Matutino: Arianne, Júlio, Kamilla, Sílvia. Vespertino: Edson, Geraldo, José Luiz, Márcio, Rodrigo, Tathiane.</li>
            <li><b>Composição dominante:</b> na maioria dos dias, <b>2 fiscais 40h</b> (Dia Todo).</li>
            <li><b>Economia de 40h:</b> quando necessário e possível, usar <b>1 (30h Mat) + 1 (30h Vesp)</b> no mesmo dia para reduzir a necessidade de um 40h.</li>
            <li><b>Intervalo:</b> se algum fiscal fizer 2 plantões no mês, manter <b>mínimo de 15 dias</b> entre eles.</li>
            <li><b>Áreas:</b> qualquer combinação é válida, desde que <b>não repita a mesma área no mesmo dia</b>.</li>
            <li><b>Sem conflito com veículos:</b> não escalar fiscal em dia em que ele esteja escalado na escala de veículos.</li>
            <li><b>Revezamento anual:</b> os fiscais que fizerem mais de 1 plantão no mês devem ser revezados no mês subsequente.</li>
          </ol>
          <p class="mini"><b>Variáveis internas</b>: <code>feriadosMunicipais</code>, <code>pontosFacultativosExtras</code>.</p>
        </div>
      </details>
    </div>

  </div>

<script>
  // =============================
  // Configuração de feriados
  // =============================
  // Formato ISO: YYYY-MM-DD
  const feriadosMunicipais = [];
  const pontosFacultativosExtras = [];

  // Pontos facultativos padronizados já definidos
  const pontosFacultativosPadrao = [
    "2026-02-16", // Carnaval
    "2026-02-17"  // Carnaval
  ];

  function feriadosNacionaisFixos(ano){
    return [
      `${ano}-01-01`,
      `${ano}-04-21`,
      `${ano}-05-01`,
      `${ano}-09-07`,
      `${ano}-10-12`,
      `${ano}-11-02`,
      `${ano}-11-15`,
      `${ano}-12-25`
    ];
  }

  // Cálculo da Páscoa (algoritmo de Meeus/Jones/Butcher)
  function easterDate(ano){
    const a = ano % 19;
    const b = Math.floor(ano / 100);
    const c = ano % 100;
    const d = Math.floor(b / 4);
    const e = b % 4;
    const f = Math.floor((b + 8) / 25);
    const g = Math.floor((b - f + 1) / 3);
    const h = (19 * a + b - d - g + 15) % 30;
    const i = Math.floor(c / 4);
    const k = c % 4;
    const l = (32 + 2 * e + 2 * i - h - k) % 7;
    const m = Math.floor((a + 11 * h + 22 * l) / 451);
    const month = Math.floor((h + l - 7 * m + 114) / 31);
    const day = ((h + l - 7 * m + 114) % 31) + 1;
    return new Date(ano, month - 1, day);
  }
  function dateToISO(d){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function paixaoDeCristoISO(ano){
    const pascoa = easterDate(ano);
    const sexta = new Date(pascoa);
    sexta.setDate(pascoa.getDate() - 2);
    return dateToISO(sexta);
  }
  function isDiaSemPlantao(iso){
    const ano = Number(iso.slice(0,4));
    const set = new Set([
      ...feriadosNacionaisFixos(ano),
      paixaoDeCristoISO(ano),
      ...feriadosMunicipais,
      ...pontosFacultativosPadrao,
      ...pontosFacultativosExtras
    ]);
    return set.has(iso);
  }

  // =============================
  // Dados (cadastro)
  // =============================
  const fiscaisOrdem = ["Acádia de Souza Vieira Silva", "Adriana Christina de Rezende Carneiro", "Adriane Pereira Guimaraes", "Aline Castro Damásio de Lima", "Ana Paula Rodrigues Correa Guimaraes", "Angela Ribeiro Neves", "Arianne Ferreira Vieira", "Clóvis Rafael Borges Ferreira", "Daniela de Almeida Castro", "Edson Arantes Faria Filho", "Eduardo Lucas Magalhães Castro", "Fabíola Pedrosa Peixoto Marques", "Geraldo Edson Rosa", "Gleiciane Maria José da Silva", "Gúbio Dias Pereira", "José Luiz Ribeiro", "João Batista Lucas da Silva Reis", "Juliana Kênia Martins da Silva", "Juliana Ferreira Viturino", "Júlio César Teles Spindola", "Kamilla Chrystine Rolim dos Santos", "Lidiane Simoes Aires Campos", "Lívia Brito Ribeiro", "Luciana Consolação dos Santos", "Luciana Santana da Rocha", "Luciene de Souza Barbosa Gomes Silva", "Maria Edwiges Pinheiro de Souza Chaves", "Marina Perillo Navarrete Lavers", "Márcio Henrique Gomes Rodovalho", "Patrícia Cordeiro de Morais e Souza", "Pedro Henrique Aires Ribeiro", "Rodrigo Alessandro Tôgo Santos", "Rúbia Mara de Freitas", "Simone Duarte Grossi", "Silvia Marques Naves da Mota Souza", "Tathiane Pessoa de Souza", "Thiago", "Vanessa Santana", "Viviane Manoel da Silva Borges", "Viviane Miyada", "Wanessa de Brito Jorge"];
  const shortToFull = {"Acádia": "Acádia de Souza Vieira Silva", "Adriana": "Adriana Christina de Rezende Carneiro", "Adriane": "Adriane Pereira Guimaraes", "Aline": "Aline Castro Damásio de Lima", "Ana Paula": "Ana Paula Rodrigues Correa Guimaraes", "Angela": "Angela Ribeiro Neves", "Arianne": "Arianne Ferreira Vieira", "Clóvis": "Clóvis Rafael Borges Ferreira", "Daniela": "Daniela de Almeida Castro", "Edson": "Edson Arantes Faria Filho", "Eduardo": "Eduardo Lucas Magalhães Castro", "Fabíola": "Fabíola Pedrosa Peixoto Marques", "Geraldo": "Geraldo Edson Rosa", "Gleiciane": "Gleiciane Maria José da Silva", "Gúbio": "Gúbio Dias Pereira", "José Luiz": "José Luiz Ribeiro", "João Batista": "João Batista Lucas da Silva Reis", "Juliana Kênia": "Juliana Kênia Martins da Silva", "Juliana Viturino": "Juliana Ferreira Viturino", "Júlio": "Júlio César Teles Spindola", "Kamilla": "Kamilla Chrystine Rolim dos Santos", "Lidiane": "Lidiane Simoes Aires Campos", "Lívia Brito": "Lívia Brito Ribeiro", "Luciana Consolação": "Luciana Consolação dos Santos", "Luciana Santana": "Luciana Santana da Rocha", "Luciene": "Luciene de Souza Barbosa Gomes Silva", "Maria Edwiges": "Maria Edwiges Pinheiro de Souza Chaves", "Marina": "Marina Perillo Navarrete Lavers", "Márcio": "Márcio Henrique Gomes Rodovalho", "Patrícia": "Patrícia Cordeiro de Morais e Souza", "Pedro": "Pedro Henrique Aires Ribeiro", "Rodrigo": "Rodrigo Alessandro Tôgo Santos", "Rúbia": "Rúbia Mara de Freitas", "Simone": "Simone Duarte Grossi", "Silvia": "Silvia Marques Naves da Mota Souza", "Tathiane": "Tathiane Pessoa de Souza", "Thiago": "Thiago", "Vanessa Santana": "Vanessa Santana", "Viviane Manoel": "Viviane Manoel da Silva Borges", "Viviane Miyada": "Viviane Miyada", "Wanessa Brito": "Wanessa de Brito Jorge"};
  const escalaPorMes = {
    "2026-02": [{"date": "2026-02-02", "dow": "Seg", "mat30": "", "vesp30": "", "f40": ["Daniela", "Marina"], "note": ""}, {"date": "2026-02-03", "dow": "Ter", "mat30": "Kamilla", "vesp30": "Edson", "f40": ["Pedro"], "note": ""}, {"date": "2026-02-04", "dow": "Qua", "mat30": "", "vesp30": "", "f40": ["Acádia", "Gúbio"], "note": ""}, {"date": "2026-02-05", "dow": "Qui", "mat30": "Sílvia", "vesp30": "Márcio", "f40": ["Gleiciane"], "note": ""}, {"date": "2026-02-06", "dow": "Sex", "mat30": "", "vesp30": "", "f40": ["Viviane Manoel", "Luciana Santana"], "note": ""}, {"date": "2026-02-09", "dow": "Seg", "mat30": "", "vesp30": "", "f40": ["Eduardo", "Ana Paula"], "note": ""}, {"date": "2026-02-10", "dow": "Ter", "mat30": "", "vesp30": "Rodrigo", "f40": ["Angela", "Simone"], "note": ""}, {"date": "2026-02-11", "dow": "Qua", "mat30": "", "vesp30": "", "f40": ["João Batista", "Luciene"], "note": ""}, {"date": "2026-02-12", "dow": "Qui", "mat30": "", "vesp30": "Tathiane", "f40": ["Maria Edwiges", "Patrícia"], "note": ""}, {"date": "2026-02-13", "dow": "Sex", "mat30": "", "vesp30": "", "f40": ["Adriana", "Viviane Miyada"], "note": ""}, {"date": "2026-02-16", "dow": "Seg", "mat30": "", "vesp30": "", "f40": [], "note": "Ponto Facultativo (Carnaval)"}, {"date": "2026-02-17", "dow": "Ter", "mat30": "", "vesp30": "", "f40": [], "note": "Ponto Facultativo (Carnaval)"}, {"date": "2026-02-18", "dow": "Qua", "mat30": "", "vesp30": "", "f40": ["Juliana Viturino", "Luciana Consolação"], "note": ""}, {"date": "2026-02-19", "dow": "Qui", "mat30": "", "vesp30": "", "f40": ["Fabíola", "Vanessa Santana"], "note": ""}, {"date": "2026-02-20", "dow": "Sex", "mat30": "Arianne", "vesp30": "José Luiz", "f40": ["Gúbio"], "note": ""}, {"date": "2026-02-23", "dow": "Seg", "mat30": "", "vesp30": "", "f40": ["Acádia", "Wanessa Brito"], "note": ""}, {"date": "2026-02-24", "dow": "Ter", "mat30": "Júlio", "vesp30": "Geraldo", "f40": ["Rúbia"], "note": ""}, {"date": "2026-02-25", "dow": "Qua", "mat30": "", "vesp30": "", "f40": ["Lívia Brito", "Clóvis"], "note": ""}, {"date": "2026-02-26", "dow": "Qui", "mat30": "", "vesp30": "", "f40": ["Daniela", "Juliana Kênia"], "note": ""}, {"date": "2026-02-27", "dow": "Sex", "mat30": "", "vesp30": "", "f40": ["Aline", "Adriane"], "note": ""}]
  };

  // =============================
  // Utilitários
  // =============================
  function goBack(){
    window.location.href = "index.html";
  }
  function isoToBR(iso){
    const [y,m,d] = iso.split("-");
    return `${d}/${m}/${y}`;
  }
  function safeName(shortName){
    return shortToFull[shortName] || shortName || "";
  }
  function localeSortPT(a,b){
    return a.localeCompare(b, "pt-BR", { sensitivity:"base" });
  }

  // =============================
  // Renderização
  // =============================
  let dtPlantao = null;
  let dtTotal = null;

  function buildSelectFiscais(){
    const sel = document.getElementById("fiscalRef");
    fiscaisOrdem
      .slice()
      .sort(localeSortPT)
      .forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
      });
  }

  function applyFilters(rows){
    const fiscal = document.getElementById("fiscalRef").value;
    const data = document.getElementById("dataRef").value;

    return rows.filter(r => {
      if(data && r.date !== data) return false;

      if(fiscal){
        const f40full = (r.f40||[]).map(safeName);
        const mat = r.mat30 ? safeName(r.mat30) : "";
        const vesp = r.vesp30 ? safeName(r.vesp30) : "";
        const all = [mat, vesp, ...f40full].filter(Boolean);
        if(!all.includes(fiscal)) return false;
      }
      return true;
    });
  }

  function toRow(r){
    const noPlantao = isDiaSemPlantao(r.date) || (r.note && r.note.toLowerCase().includes("ponto facultativo"));
    const mat = r.mat30 ? `${safeName(r.mat30)} (Mat)` : "";
    const vesp = r.vesp30 ? `${safeName(r.vesp30)} (Vesp)` : "";
    const f40 = (r.f40||[]).map(safeName).join(", ");
    return {
      dataBR: isoToBR(r.date),
      dow: r.dow || "",
      mat30: mat,
      vesp30: vesp,
      f40: f40,
      obs: r.note || "",
      _noPlantao: noPlantao
    };
  }

  function renderMes(mesKey){
    document.getElementById("badgeMes").textContent = mesKey || "";

    const base = (escalaPorMes[mesKey] || []).slice();

    // Se for dia sem plantão, zera alocações e mantém observação
    const normalized = base.map(r => {
      const no = isDiaSemPlantao(r.date) || (r.note && r.note.toLowerCase().includes("ponto facultativo"));
      if(no){
        return {...r, mat30:"", vesp30:"", f40:[], note: r.note || "Sem plantão"};
      }
      return r;
    });

    const filtered = applyFilters(normalized).map(toRow);

    // tabela principal
    if(dtPlantao) dtPlantao.destroy();
    const tbody = document.querySelector("#tabelaPlantao tbody");
    tbody.innerHTML = "";
    for(const row of filtered){
      const tr = document.createElement("tr");
      if(row._noPlantao) tr.classList.add("noPlantao");
      tr.innerHTML = `
        <td>${row.dataBR}</td>
        <td>${row.dow}</td>
        <td>${row.mat30 || "—"}</td>
        <td>${row.vesp30 || "—"}</td>
        <td>${row.f40 || "—"}</td>
        <td>${row.obs || ""}</td>
      `;
      tbody.appendChild(tr);
    }

    dtPlantao = $("#tabelaPlantao").DataTable({
      pageLength: 50,
      lengthMenu: [25, 50, 100, -1],
      order: [[0,"asc"]],
      language: { url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json" }
    });

    renderTotalizacao(normalized);
  }

  function renderTotalizacao(rowsMes){
    const totals = new Map();
    for(const f of fiscaisOrdem){
      totals.set(f, {count:0, dates:[]});
    }

    for(const r of rowsMes){
      const no = isDiaSemPlantao(r.date) || (r.note && r.note.toLowerCase().includes("ponto facultativo"));
      if(no) continue;

      const dateBR = isoToBR(r.date);

      const add = (name) => {
        if(!name) return;
        const baseName = name.replace(/\s*\(Mat\)|\s*\(Vesp\)/g,"").trim();
        if(!totals.has(baseName)) totals.set(baseName, {count:0, dates:[]});
        const obj = totals.get(baseName);
        obj.count += 1;
        obj.dates.push(dateBR);
      };

      if(r.mat30) add(`${safeName(r.mat30)} (Mat)`);
      if(r.vesp30) add(`${safeName(r.vesp30)} (Vesp)`);
      (r.f40||[]).forEach(n => add(safeName(n)));
    }

    const body = document.querySelector("#tabelaTotal tbody");
    body.innerHTML = "";

    const ordered = Array.from(totals.entries())
      .map(([name, obj]) => ({name, count: obj.count, dates: obj.dates}))
      .sort((a,b)=> localeSortPT(a.name,b.name));

    for(const it of ordered){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.name}</td>
        <td style="text-align:center; font-weight:800;">${it.count}</td>
        <td>${it.dates.join(", ")}</td>
      `;
      body.appendChild(tr);
    }

    if(dtTotal) dtTotal.destroy();
    dtTotal = $("#tabelaTotal").DataTable({
      pageLength: 50,
      lengthMenu: [25, 50, 100, -1],
      order: [[0,"asc"]],
      language: { url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json" }
    });
  }

  // =============================
  // Boot
  // =============================
  (function init(){
    buildSelectFiscais();

    const mesInput = document.getElementById("mesRef");
    const defaultMes = "2026-02"; // conforme escala aprovada
    mesInput.value = defaultMes;

    mesInput.addEventListener("change", () => renderMes(mesInput.value || ""));
    document.getElementById("fiscalRef").addEventListener("change", () => renderMes(mesInput.value));
    document.getElementById("dataRef").addEventListener("change", () => renderMes(mesInput.value));

    renderMes(defaultMes);
  })();
</script>

<!-- Proteção de página (se existir guard.js no projeto) -->
<script type="module">
  try {
    const mod = await import("./guard.js");
    if(mod && typeof mod.protectPage === "function") {
      const firebaseConfig = {
        apiKey: "AIzaSyDo473puJesZ9rr3IBoX5AWczCIMuKBTrg",
        authDomain: "visam-3a30b.firebaseapp.com",
        projectId: "visam-3a30b",
        messagingSenderId: "308899251430",
        appId: "1:308899251430:web:0053cdbd0bed7f0de76727"
      };
      mod.protectPage({ firebaseConfig });
    }
  } catch(e) {
    // Se não houver guard.js, não quebra a página
  }
</script>

</body>
</html>
