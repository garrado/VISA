<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>√Åreas de Atua√ß√£o ‚Äì Vigil√¢ncia Sanit√°ria</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="./css/design-tokens.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,-apple-system,"Segoe UI",Arial;background:#f6f7fb}

/* ===== HEADER PRINCIPAL ===== */
header{
  background:#1a3a6b;color:#fff;padding:26px 20px;text-align:center;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 4px rgba(0,0,0,.12)
}
header h1{margin:0;font-size:2rem;font-weight:900}
header h2{margin-top:6px;font-weight:500;opacity:.92}

/* Bot√£o OK */
.btn-ok-header{
  position:absolute;top:50%;right:16px;transform:translateY(-50%);
  background:transparent;border:none;color:#34C759;
  font-size:17px;font-weight:700;padding:16px 12px;cursor:pointer;
}

/* ===== SUBHEADER ‚Äì AVISO LEGAL ===== */
.subheader-legal{
  background:#eef2ff;
  border-bottom:1px solid #c7d2fe;
}
.subheader-inner{
  max-width:1100px;
  margin:0 auto;
  padding:8px 16px;
  display:flex;
  justify-content:flex-end;
}
.btn-legal{
  background:#fff3cd;
  border:1px solid #f0ad4e;
  color:#8a1f11;
  font-weight:900;
  padding:8px 14px;
  border-radius:999px;
  cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  font-size:.9rem;
}
@media(max-width:768px){
  .subheader-inner{justify-content:center}
}

/* ===== CONTE√öDO ===== */
.container{max-width:1100px;margin:20px auto;padding:0 16px}
.card{
  background:#fff;border-radius:16px;padding:18px;margin-bottom:16px;
  box-shadow:0 4px 14px rgba(0,0,0,.08)
}

/* ===== FILTROS ===== */
.filters{display:grid;grid-template-columns:2fr 2fr 1fr 140px 140px;gap:12px}
label{font-weight:800;margin-bottom:6px;display:block}
input,select,button{padding:12px;border-radius:10px;border:1px solid #ccc;font-size:1rem}
.btn{background:#2c5aa0;color:#fff;border:none;font-weight:900}
.btn-clear{background:#eef2ff;color:#1a3a6b;border:1px solid #c7d2fe}

/* ===== DICA ===== */
.hint{
  background:rgba(44,90,160,.08);
  border-left:4px solid #2c5aa0;
  padding:10px 12px;
  border-radius:10px;
  font-weight:800;
  margin-top:12px;
}

/* ===== TABELA ===== */
.table-wrap{overflow:auto;border-radius:12px}
table{width:max(100%,1050px);border-collapse:separate;border-spacing:0}
thead th{
  background:#2c5aa0;color:#fff;padding:10px;
  position:sticky;top:0;z-index:2;white-space:nowrap
}
tbody td{padding:10px;border-bottom:1px solid #ddd}
tbody tr:hover td{background:#f1f5ff}

/* Coluna Bairro fixa */
th:first-child,td:first-child{
  position:sticky;left:0;background:#fff;z-index:3;min-width:240px
}
thead th:first-child{background:#2c5aa0;color:#fff;z-index:6}
@media(max-width:768px){
  th:first-child,td:first-child{
    min-width:140px;max-width:160px;font-size:.85rem;
    white-space:normal;word-break:break-word
  }
}

/* ===== DESTAQUES ===== */
.hit{
  background:#ffe066;border-left:4px solid #1a3a6b;
  padding:2px 6px;border-radius:6px;font-weight:900
}
.col-hidden{display:none!important}

/* ===== MODAIS ===== */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;padding:12px}
.modal-box{
  background:#fff;max-width:760px;margin:5vh auto;border-radius:16px;
  padding:20px;max-height:80vh;display:flex;flex-direction:column
}
.modal-scroll{overflow:auto;max-height:60vh;padding-right:8px}
.modal-actions{margin-top:14px;text-align:right}

/* ===== RESPONSIVO HEADER ===== */
@media(max-width:768px){
  header{padding-right:72px}
  header h1{font-size:1.45rem}
  header h2{font-size:.95rem}
}
</style>
</head>

<body>

<header>
  <a class="btn-ok-header" href="index.html">OK</a>
  <h1>Vigil√¢ncia Sanit√°ria</h1>
  <h2>√Åreas de Atua√ß√£o por Bairro</h2>
</header>

<!-- SUBHEADER -->
<div class="subheader-legal">
  <div class="subheader-inner">
    <button class="btn-legal" id="btnAvisoLegal">‚ö†Ô∏è Aviso Legal</button>
  </div>
</div>

<div class="container">

<div class="card">
  <div class="filters">
    <div><label>Bairro</label><input id="qBairro"></div>
    <div><label>Fiscal</label><input id="qFiscal"></div>
    <div><label>√Årea</label><select id="fSigla"></select></div>
    <button class="btn" id="btnBuscar">Buscar</button>
    <button class="btn-clear" id="btnLimpar">Limpar</button>
  </div>
  <div class="hint">üí° Clique na √°rea de atua√ß√£o pra ver CNAEs relacionados.</div>
</div>

<div class="card">
  <div class="table-wrap">
    <table>
      <thead><tr id="thead"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

</div>

<!-- MODAL CNAE -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle"></h3>
    <ul id="modalList" class="modal-scroll"></ul>
    <div class="modal-actions">
      <button class="btn-clear" id="btnFecharModal">Fechar</button>
    </div>
  </div>
</div>

<!-- MODAL AVISO LEGAL -->
<div class="modal" id="avisoLegalModal">
  <div class="modal-box">
    <h3 style="color:#8a1f11">Aviso Legal</h3>
    <div class="modal-scroll">
      <p>Informamos que a divis√£o dos fiscais por √°reas de atua√ß√£o n√£o √© fixa, n√£o gerando direito adquirido ou qualquer forma de vincula√ß√£o permanente.</p>
      <p>Nos termos da Lei Complementar n¬∫ 548/2023, compete ao Secret√°rio Municipal de Sa√∫de a organiza√ß√£o mensal das Ordens de Servi√ßo.</p>
      <p>Essa atribui√ß√£o foi delegada ao Gerente da Vigil√¢ncia Sanit√°ria.</p>
      <p>Altera√ß√µes s√£o legais, leg√≠timas e inerentes √† gest√£o administrativa.</p>
    </div>
    <div class="modal-actions">
      <button class="btn-clear" id="btnFecharAvisoLegal">Fechar</button>
    </div>
  </div>
</div>

<script>
const CSV_BAIRROS="data/bairros.csv",CSV_CNAE="data/cnae.csv";
const IGNORE=new Set(["CODIGO","SETOR","SETORALIMENTO","FU","CONTROLE"]);
const SIGLA_TO_NOME={
 IA:"Ind√∫strias Aliment√≠cias",AG:"Alimentos em Geral",ED:"Ensino",
 OS:"Produtos para Sa√∫de",SS:"Servi√ßos de Sa√∫de",OD:"Servi√ßos Odontol√≥gicos",
 CS:"Cosm√©ticos",AM:"Ambiental",VT:"Veterin√°ria",BI:"Outras √Åreas I",
 LP:"Assist√™ncia √† Sa√∫de",AO:"Outras √Åreas II",TR:"Transporte",
 DR:"Medicamentos",MD:"Medicamentos"
};

const qBairro = document.getElementById("qBairro");
const qFiscal = document.getElementById("qFiscal");
const fSigla  = document.getElementById("fSigla");

const thead=document.getElementById("thead"),tbody=document.getElementById("tbody");
let dados=[],siglas=[],cnaeMap={};

function norm(s){return String(s||"").toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");}
function areaNome(s){return SIGLA_TO_NOME[s]||s;}

function loadCSV(u){return new Promise(r=>Papa.parse(u,{download:true,header:true,complete:x=>r(x.data)}));}

async function init(){
  const [cnae,bairros]=await Promise.all([loadCSV(CSV_CNAE),loadCSV(CSV_BAIRROS)]);
  cnae.forEach(l=>{if(l.Equipe&&l.Atividade){(cnaeMap[l.Equipe]=cnaeMap[l.Equipe]||[]).push(l.Atividade)}});
  dados=bairros;
  siglas=Object.keys(bairros[0]).filter(c=>c!=="NOME"&&!IGNORE.has(c));
  thead.innerHTML="<th>Bairro</th>"+siglas.map(s=>`<th onclick="openModal('${s}')">${areaNome(s)}</th>`).join("");
  fSigla.innerHTML="<option value=''>Todas</option>"+siglas.map(s=>`<option value='${s}'>${areaNome(s)}</option>`).join("");
  render();
}

function render(){
  tbody.innerHTML="";
  const qb=norm(qBairro?.value),qf=norm(qFiscal?.value),fs=fSigla?.value;
  dados.forEach(l=>{
    if(qb&&!norm(l.NOME).includes(qb))return;
    if(fs&&!l[fs])return;
    if(qf&&!siglas.some(s=>norm(l[s]).includes(qf)))return;
    tbody.innerHTML+="<tr><td>"+l.NOME+"</td>"+siglas.map(s=>{
      let v=l[s]||"";if(qf&&norm(v).includes(qf))v="<span class='hit'>"+v+"</span>";
      return "<td>"+v+"</td>";
    }).join("")+"</tr>";
  });
}

function openModal(s){
  modalTitle.textContent="Atividades Econ√¥micas ‚Äì "+areaNome(s);
  modalList.innerHTML=(cnaeMap[s]||["Nenhuma atividade"]).map(a=>"<li>"+a+"</li>").join("");
  modal.style.display="block";
}
btnFecharModal.onclick=()=>modal.style.display="none";

btnAvisoLegal.onclick=()=>avisoLegalModal.style.display="block";
btnFecharAvisoLegal.onclick=()=>avisoLegalModal.style.display="none";

init();
</script>
</body>
</html>
