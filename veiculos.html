<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escala de Uso de Ve√≠culos - VISA An√°polis</title>

  <!-- Design System -->
  <link rel="stylesheet" href="./css/design-tokens.css">

  <!-- jQuery e DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

  <style>
    body{
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin:0;
    }

    header{
      background:#1a3a6b;
      color:#fff;
      padding:28px 20px 26px;
      text-align:center;
      position:sticky;
      top:0;
      z-index:100;
    }

    header h1{margin:0;font-size:clamp(1.4rem,2.4vw,2.3rem);font-weight:900;}
    header h2{margin-top:8px;font-size:clamp(1rem,1.5vw,1.15rem);font-weight:500;opacity:.95;}

    .btn-ok-header{
      position:absolute;
      right:16px;
      top:50%;
      transform:translateY(-50%);
      background:none;
      border:none;
      color:#34C759;
      font-size:17px;
      font-weight:600;
      cursor:pointer;
      text-decoration:none;
    }

    .container{max-width:1400px;margin:22px auto 40px;padding:0 16px;}

    .card{
      background:var(--card);
      border-radius:16px;
      padding:24px;
      border:1px solid var(--line);
      box-shadow:var(--shadow2);
      margin-bottom:20px;
    }

    .card h3{
      color:var(--brand1);
      margin-bottom:16px;
      border-bottom:2px solid var(--brand1);
      padding-bottom:8px;
    }

    .filters{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap:16px;
      align-items:end;
      width:100%;
    }

    .filter-group{display:flex;flex-direction:column;min-width:0;justify-content:flex-end;}
    label{font-weight:600;margin-bottom:6px;display:block;}

    input, select{
      box-sizing:border-box;
      display:block;
      width:100%;
      min-width:0;
      padding:12px;
      border-radius:8px;
      border:1px solid var(--input-border);
      background:var(--input-bg);
      color:var(--input-text);
    }

    .btn-search{
      margin-top:0;
      width:100%;
      padding:12px 24px;
      border-radius:12px;
      border:none;
      background:linear-gradient(135deg,var(--brand1),var(--brand2));
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }

    table.dataTable thead th{background:var(--brand1);color:#fff;white-space:nowrap;}
    .small-muted{font-size:0.85em;color:var(--muted);text-align:center;margin-top:20px;}
    @media(max-width:768px){header{padding-right:70px;}}
    .tag-weekend{opacity:.65}
    .tag-vago{font-weight:800}
  </style>
</head>
<body>

<header>
  <a href="index.html" class="btn-ok-header">OK</a>
  <h1>Vigil√¢ncia Sanit√°ria</h1>
  <h2>Escala de Uso de Ve√≠culos</h2>
</header>

<div class="container">

  <div class="card">
    <h3>üîç Filtros</h3>
    <div class="filters">
      <div class="filter-group">
        <label for="fFiscal">Fiscal</label>
        <input type="text" id="fFiscal" placeholder="Nome do fiscal (ex: LIVIA)">
      </div>

      <div class="filter-group">
        <label for="fData">Data (opcional)</label>
        <input type="date" id="fData">
      </div>

      <div class="filter-group">
        <label for="fTurno">Turno</label>
        <select id="fTurno">
          <option value="">(Todos)</option>
          <option value="Matutino">Matutino</option>
          <option value="Vespertino">Vespertino</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="fVeiculo">Ve√≠culo</label>
        <select id="fVeiculo">
          <option value="">(Todos)</option>
          <option value="Ve√≠culo 1">Ve√≠culo 1</option>
          <option value="Ve√≠culo 2">Ve√≠culo 2</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="fMes">M√™s</label>
        <select id="fMes"></select>
      </div>

      <div class="filter-group">
        <label for="fAno">Ano</label>
        <select id="fAno"></select>
      </div>

      <div class="filter-group">
        <label>&nbsp;</label>
        <button class="btn-search" onclick="aplicarFiltros()">Buscar</button>
      </div>
    </div>
  </div>

  <div class="card">
    <table id="tabelaVeiculos" class="display" style="width:100%">
      <thead>
        <tr>
          <th>Data</th>
          <th>Dia</th>
          <th>Turno</th>
          <th>Ve√≠culo</th>
          <th>Fiscal</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="small-muted">Atualizado automaticamente ‚Äî (Hor√°rio de Bras√≠lia ‚Äì UTC‚àí3)</div>
</div>

<script>
  // =========================================================
  // REGRAS INTERNAS
  // Base fixa por dia da semana e turno (ver regras veiculo.txt).
  // - Se fiscal listado sozinho estiver afastado => VAGO.
  // - Dupla: se um afastar, o outro permanece; s√≥ VAGO se ambos afastados.
  // - A escala mensal respeita esta base; muda apenas o calend√°rio e f√©rias.
  // =========================================================

  // Base semanal com NOMES COMPLETOS (padr√£o do OS)
  const escalaBaseSemanal = {
    // SEG
    "SEG:Matutino": {
      veiculo1: ["JULIO C√âSAR TELES SPINDOLA"],
      veiculo2: ["LUCIENE DE SOUZA BARBOSA GOMES SILVA"]
    },
    "SEG:Vespertino": {
      veiculo1: ["JULIANA K√äNIA MARTINS DA SILVA", "TATHIANE PESSOA DE SOUZA"],
      veiculo2: ["RODRIGO ALESSANDRO T√îGO SANTOS"]
    },

    // TER
    "TER:Matutino": {
      veiculo1: ["FAB√çOLA PEDROSA PEIXOTO MARQUES", "LIDIANE SIM√ïES"],
      veiculo2: ["LUCIANA CONSOLA√á√ÉO DOS SANTOS", "ADRIANA CRHISTINA DE REZENDE CARNEIRO"]
    },
    "TER:Vespertino": {
      veiculo1: ["ADRIANE PEREIRA GUIMAR√ÉES", "PATR√çCIA CORDEIRO DE MORAES E SOUZA"],
      veiculo2: ["CL√ìVIS RAFAEL BORGES FERREIRA", "VIVIANE MIYADA"]
    },

    // QUA
    "QUA:Matutino": {
      veiculo1: ["ALINE CASTRO DAMASIO", "ARIANNE FERREIRA VIEIRA"],
      veiculo2: ["VANESSA SANTANA"]
    },
    "QUA:Vespertino": {
      veiculo1: ["JOSE LUIZ RIBEIRO"],
      veiculo2: ["JULIANA K√äNIA MARTINS DA SILVA", "TATHIANE PESSOA DE SOUZA"]
    },

    // QUI
    "QUI:Matutino": {
      veiculo1: ["ADRIANA CRHISTINA DE REZENDE CARNEIRO", "LUCIANA CONSOLA√á√ÉO DOS SANTOS"],
      veiculo2: ["LIVIA BRITO", "PEDRO HENRIQUE AIRES RIBEIRO"]
    },
    "QUI:Vespertino": {
      veiculo1: ["ADRIANE PEREIRA GUIMAR√ÉES", "PATR√çCIA CORDEIRO DE MORAES E SOUZA"],
      veiculo2: ["JOSE LUIZ RIBEIRO"]
    },

    // SEX
    "SEX:Matutino": {
      veiculo1: ["JO√ÉO BATISTA LUCAS DA SILVA REIS"],
      veiculo2: ["VANESSA SANTANA"]
    },
    "SEX:Vespertino": {
      veiculo1: ["JO√ÉO BATISTA LUCAS DA SILVA REIS"],
      veiculo2: ["RODRIGO ALESSANDRO T√îGO SANTOS"]
    }
  };

  // ‚úÖ Fonte √∫nica de f√©rias: ferias.html (mesma pasta)
  // L√™ a tabela <tr><td>Funcion√°rio</td><td>In√≠cio</td><td>Final</td></tr> e converte para ISO.
  // Se ferias.html n√£o carregar, a escala roda sem aplicar f√©rias.
  let ferias = [];

  function ddmmyyyyToISO(s){
    if(!s) return "";
    const p = s.trim().split("/");
    if(p.length !== 3) return "";
    const dd = p[0].padStart(2,"0");
    const mm = p[1].padStart(2,"0");
    const yy = p[2];
    return `${yy}-${mm}-${dd}`;
  }

  async function carregarFeriasDeHTML(){
    try{
      const bust = Date.now();
      const resp = await fetch(`./ferias.html?v=${bust}`, { cache: "no-store" });
      if(!resp.ok) throw new Error("HTTP " + resp.status);
      const html = await resp.text();
      const doc = new DOMParser().parseFromString(html, "text/html");

      const table = doc.querySelector("table");
      if(!table) throw new Error("Tabela n√£o encontrada em ferias.html");

      const rows = Array.from(table.querySelectorAll("tr")).slice(1); // pula cabe√ßalho
      const lista = [];

      rows.forEach(tr => {
        const tds = tr.querySelectorAll("td");
        if(tds.length < 3) return;
        const nome = (tds[0].textContent || "").trim().replace(/\s+/g," ");
        const iniBR = (tds[1].textContent || "").trim();
        const fimBR = (tds[2].textContent || "").trim();

        const ini = ddmmyyyyToISO(iniBR);
        const fim = ddmmyyyyToISO(fimBR);

        if(nome && ini && fim){
          lista.push({ nome, inicio: ini, fim: fim });
        }
      });

      ferias = lista;
      console.log(`‚úÖ F√©rias carregadas de ferias.html: ${ferias.length} registros`);
    }catch(err){
      console.warn("‚ö†Ô∏è N√£o foi poss√≠vel carregar ferias.html. Escala seguir√° sem aplicar f√©rias.", err);
      ferias = [];
    }
  }

  
  // =========================================================
  // Feriados (Nacionais + Municipais/Facultativos configur√°veis)
  // =========================================================
  // ‚úÖ NACIONAIS FIXOS (Brasil)
  // Formato ISO: YYYY-MM-DD
  function feriadosNacionaisFixos(ano){
    const pad = (n) => String(n).padStart(2,'0');
    return [
      `${ano}-01-01`, // Confraterniza√ß√£o Universal
      `${ano}-04-21`, // Tiradentes
      `${ano}-05-01`, // Dia do Trabalhador
      `${ano}-09-07`, // Independ√™ncia do Brasil
      `${ano}-10-12`, // Nossa Senhora Aparecida
      `${ano}-11-02`, // Finados
      `${ano}-11-15`, // Proclama√ß√£o da Rep√∫blica
      `${ano}-12-25`  // Natal
    ];
  }

  // ‚úÖ NACIONAL M√ìVEL (Paix√£o de Cristo = Sexta-feira Santa)
  // Calcula a P√°scoa (algoritmo de Meeus/Jones/Butcher) e deriva a Sexta-feira Santa.
  function easterDate(ano){
    const a = ano % 19;
    const b = Math.floor(ano / 100);
    const c = ano % 100;
    const d = Math.floor(b / 4);
    const e = b % 4;
    const f = Math.floor((b + 8) / 25);
    const g = Math.floor((b - f + 1) / 3);
    const h = (19 * a + b - d - g + 15) % 30;
    const i = Math.floor(c / 4);
    const k = c % 4;
    const l = (32 + 2 * e + 2 * i - h - k) % 7;
    const m = Math.floor((a + 11 * h + 22 * l) / 451);
    const month = Math.floor((h + l - 7 * m + 114) / 31); // 3=Mar, 4=Abr
    const day = ((h + l - 7 * m + 114) % 31) + 1;
    return new Date(ano, month - 1, day);
  }

  function dateToISO(d){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function paixaoDeCristoISO(ano){
    const pascoa = easterDate(ano);
    const sextaSanta = new Date(pascoa);
    sextaSanta.setDate(pascoa.getDate() - 2);
    return dateToISO(sextaSanta);
  }

  // ‚úÖ CONFIGURE AQUI OS FERIADOS MUNICIPAIS E PONTOS FACULTATIVOS
  // Coloque no formato ISO: 'YYYY-MM-DD'
  // Exemplos (APAGUE/EDITE):
  // const feriadosMunicipais = ['2026-07-31']; // ex.: anivers√°rio do munic√≠pio
  // const pontosFacultativos = ['2026-02-16','2026-02-17']; // ex.: carnaval
  const feriadosMunicipais = [];

// Pontos facultativos padronizados (j√° configurados)
const pontosFacultativos = [
  '2026-02-16', // Carnaval
  '2026-02-17', // Carnaval
  '2026-06-04'  // Corpus Christi
];

  function isDiaSemEscala(iso, ano){
    const set = new Set([
      ...feriadosNacionaisFixos(ano),
      paixaoDeCristoISO(ano),
      ...feriadosMunicipais,
      ...pontosFacultativos
    ]);
    return set.has(iso);
  }


// =========================================================
  // Utilit√°rios (normaliza√ß√£o para casar nomes com seguran√ßa)
  // =========================================================
  const diasPt = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
  const mapDiaKey = { "Seg":"SEG", "Ter":"TER", "Qua":"QUA", "Qui":"QUI", "Sex":"SEX" };

  function norm(s){
    return (s||"")
      .toString()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toUpperCase()
      .replace(/\s+/g," ")
      .trim();
  }

  // Casa por igualdade normalizada; se falhar, tenta "cont√©m" (para varia√ß√µes como LIDIANE SIM√ïES vs LIDIANE SIMOES AIRES CAMPOS)
  function nomeCasaComFerias(nomeEscala, nomeFerias){
    const a = norm(nomeEscala);
    const b = norm(nomeFerias);
    if(!a || !b) return false;
    if(a === b) return true;
    return b.includes(a) || a.includes(b);
  }

  function estaDeFerias(nomeEscala, dateISO){
    const d = new Date(dateISO + "T00:00:00");
    return ferias.some(f => {
      if(!nomeCasaComFerias(nomeEscala, f.nome)) return false;
      const ini = new Date(f.inicio + "T00:00:00");
      const fim = new Date(f.fim + "T23:59:59");
      return d >= ini && d <= fim;
    });
  }

  function isoToBR(iso){
    // iso YYYY-MM-DD
    const p = (iso||"").split("-");
    if(p.length !== 3) return iso || "";
    return `${p[2]}/${p[1]}/${p[0]}`;
  }

  // =========================================================
  // Gera√ß√£o mensal (linhas normalizadas: 1 fiscal por linha)
  // =========================================================
  function gerarEscalaMes(ano, mes){
    const diasNoMes = new Date(ano, mes, 0).getDate();
    const linhas = [];

    for(let dia=1; dia<=diasNoMes; dia++){
      const dt = new Date(ano, mes-1, dia);
      const dow = diasPt[dt.getDay()];
      const iso = dt.toISOString().split("T")[0];

      // Fim de semana OU feriado/ponto facultativo (linhas apenas para refer√™ncia visual)
      if(dow === "S√°b" || dow === "Dom" || isDiaSemEscala(iso, ano)) {
        linhas.push({
          dataISO: iso,
          dataBR: isoToBR(iso),
          diaSemana: dow,
          turno: "‚Äî",
          veiculo: "‚Äî",
          fiscal: "‚Äî",
          isWeekend: true
        });
        continue;
      }

      const keyDia = mapDiaKey[dow];
      ["Matutino","Vespertino"].forEach(turno => {
        const baseKey = keyDia + ":" + turno;
        const cfg = escalaBaseSemanal[baseKey];

        ["Ve√≠culo 1","Ve√≠culo 2"].forEach(v => {
          const lista = cfg ? (v === "Ve√≠culo 1" ? cfg.veiculo1 : cfg.veiculo2) : [];
          const ativos = (lista || []).filter(n => !estaDeFerias(n, iso));

          if(!ativos.length){
            linhas.push({
              dataISO: iso,
              dataBR: isoToBR(iso),
              diaSemana: dow,
              turno,
              veiculo: v,
              fiscal: "VAGO",
              isWeekend: false
            });
          }else{
            // ‚úÖ 1 fiscal por linha
            ativos.forEach(nomeCompleto => {
              linhas.push({
                dataISO: iso,
                dataBR: isoToBR(iso),
                diaSemana: dow,
                turno,
                veiculo: v,
                fiscal: nomeCompleto,
                isWeekend: false
              });
            });
          }
        });
      });
    }

    return linhas;
  }

  // =========================================================
  // UI / DataTable
  // =========================================================
  let tabela;
  let dadosMes = [];

  function initMesAno(){
    const mesSel = document.getElementById("fMes");
    const anoSel = document.getElementById("fAno");
    const hoje = new Date();

    for(let m=0; m<12; m++){
      const opt = document.createElement("option");
      opt.value = m+1;
      opt.text = new Date(2000, m, 1).toLocaleString("pt-BR", { month: "long" });
      if(m === hoje.getMonth()) opt.selected = true;
      mesSel.appendChild(opt);
    }

    for(let a=2024; a<=2030; a++){
      const opt = document.createElement("option");
      opt.value = a;
      opt.text = a;
      if(a === hoje.getFullYear()) opt.selected = true;
      anoSel.appendChild(opt);
    }
  }

  function carregarTabela(){
    tabela = $("#tabelaVeiculos").DataTable({
      language: { url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json" },
      pageLength: 50,
      lengthMenu: [25, 50, 100, -1],
      order: [[0, "asc"], [2, "asc"], [3, "asc"], [4, "asc"]],
      data: [],
      columns: [
        { data: "dataISO", render: d => isoToBR(d) }, // ‚úÖ dd/mm/aaaa
        { data: "diaSemana" },
        { data: "turno" },
        { data: "veiculo" },
        { data: "fiscal" }
      ],
      createdRow: function(row, data){
        if(data.isWeekend) $(row).addClass("tag-weekend");
        if(data.fiscal === "VAGO") $(row).addClass("tag-vago");
      }
    });
  }

  function aplicarFiltros(){
    const nome = norm(document.getElementById("fFiscal").value);
    const dataStr = document.getElementById("fData").value; // YYYY-MM-DD
    const turno = document.getElementById("fTurno").value;
    const veiculo = document.getElementById("fVeiculo").value;
    const mes = parseInt(document.getElementById("fMes").value);
    const ano = parseInt(document.getElementById("fAno").value);

    dadosMes = gerarEscalaMes(ano, mes);
    let filtrado = dadosMes;

    if(dataStr){
      filtrado = filtrado.filter(l => l.dataISO === dataStr);
    }

    if(turno){
      filtrado = filtrado.filter(l => l.turno === turno);
    }

    if(veiculo){
      filtrado = filtrado.filter(l => l.veiculo === veiculo);
    }

    if(nome){
      filtrado = filtrado.filter(l => norm(l.fiscal).includes(nome));
    }

    filtrado.sort((a,b) => {
      if(a.dataISO !== b.dataISO) return a.dataISO.localeCompare(b.dataISO);
      if(a.turno !== b.turno) return a.turno.localeCompare(b.turno, "pt-BR", { sensitivity:"variant" });
      if(a.veiculo !== b.veiculo) return a.veiculo.localeCompare(b.veiculo, "pt-BR", { sensitivity:"variant" });
      return a.fiscal.localeCompare(b.fiscal, "pt-BR", { sensitivity:"variant" });
    });

    tabela.clear();
    tabela.rows.add(filtrado).draw();
  }

  document.addEventListener("DOMContentLoaded", async () => {
    initMesAno();
    carregarTabela();
    await carregarFeriasDeHTML();   // ‚úÖ fonte √∫nica
    aplicarFiltros();               // m√™s corrente
  });
</script>

</body>
</html>
