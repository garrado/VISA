<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escala de Uso de Ve√≠culos - VISA An√°polis</title>

  <!-- Design System -->
  <link rel="stylesheet" href="./css/design-tokens.css">

  <!-- jQuery e DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

  <style>
    body{
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin:0;
    }

    header{
      background:#1a3a6b;
      color:#fff;
      padding:28px 20px 26px;
      text-align:center;
      position:sticky;
      top:0;
      z-index:100;
    }

    header h1{margin:0;font-size:clamp(1.4rem,2.4vw,2.3rem);font-weight:900;}
    header h2{margin-top:8px;font-size:clamp(1rem,1.5vw,1.15rem);font-weight:500;opacity:.95;}

    .btn-ok-header{
      position:absolute;
      right:16px;
      top:50%;
      transform:translateY(-50%);
      background:none;
      border:none;
      color:#34C759;
      font-size:17px;
      font-weight:600;
      cursor:pointer;
      text-decoration:none;
    }

    .container{max-width:1400px;margin:22px auto 40px;padding:0 16px;}

    .card{
      background:var(--card);
      border-radius:16px;
      padding:24px;
      border:1px solid var(--line);
      box-shadow:var(--shadow2);
      margin-bottom:20px;
    }

    .card h3{
      color:var(--brand1);
      margin-bottom:16px;
      border-bottom:2px solid var(--brand1);
      padding-bottom:8px;
    }

    .filters{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap:16px;
      align-items:end;
      width:100%;
    }

    .filter-group{display:flex;flex-direction:column;min-width:0;justify-content:flex-end;}

    label{font-weight:600;margin-bottom:6px;display:block;}

    input, select{
      box-sizing:border-box;
      display:block;
      width:100%;
      min-width:0;
      padding:12px;
      border-radius:8px;
      border:1px solid var(--input-border);
      background:var(--input-bg);
      color:var(--input-text);
    }

    .btn-search{
      margin-top:0;
      width:100%;
      padding:12px 24px;
      border-radius:12px;
      border:none;
      background:linear-gradient(135deg,var(--brand1),var(--brand2));
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }

    table.dataTable thead th{background:var(--brand1);color:#fff;white-space:nowrap;}

    .small-muted{font-size:0.85em;color:var(--muted);text-align:center;margin-top:20px;}

    @media(max-width:768px){header{padding-right:70px;}}

    /* Destaque visual opcional */
    .tag-weekend{opacity:.7}
    .tag-vago{font-weight:800}
  </style>
</head>
<body>

<header>
  <a href="index.html" class="btn-ok-header">OK</a>
  <h1>Vigil√¢ncia Sanit√°ria</h1>
  <h2>Escala de Uso de Ve√≠culos</h2>
</header>

<div class="container">

  <div class="card">
    <h3>üîç Filtros</h3>
    <div class="filters">
      <div class="filter-group">
        <label for="fFiscal">Fiscal</label>
        <input type="text" id="fFiscal" placeholder="Nome do fiscal (ex: L√≠via)">
      </div>
      <div class="filter-group">
        <label for="fData">Data (opcional)</label>
        <input type="date" id="fData">
      </div>
      <div class="filter-group">
        <label for="fTurno">Turno</label>
        <select id="fTurno">
          <option value="">(Todos)</option>
          <option value="Matutino">Matutino</option>
          <option value="Vespertino">Vespertino</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="fMes">M√™s</label>
        <select id="fMes"></select>
      </div>
      <div class="filter-group">
        <label for="fAno">Ano</label>
        <select id="fAno"></select>
      </div>
      <div class="filter-group">
        <label>&nbsp;</label>
        <button class="btn-search" onclick="aplicarFiltros()">Buscar</button>
      </div>
    </div>
  </div>

  <div class="card">
    <table id="tabelaVeiculos" class="display" style="width:100%">
      <thead>
        <tr>
          <th>Data</th>
          <th>Dia</th>
          <th>Turno</th>
          <th>Carro 1</th>
          <th>Carro 2</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="small-muted">Atualizado automaticamente ‚Äî (Hor√°rio de Bras√≠lia ‚Äì UTC‚àí3)</div>
</div>

<script>
  // =========================================================
  // REGRAS INTERNAS (Base semanal fixa) + exce√ß√µes por f√©rias
  // Fonte: ‚ÄúEscala Base de Uso de Ve√≠culos (fixa por dia da semana)‚Äù.
  // - Quando fiscal sozinho estiver afastado => VAGO.
  // - Dupla: se um afastar, o outro segue sozinho; s√≥ VAGO se ambos afastados.
  // =========================================================
  // (Anexo: regras veiculo.txt) 
  // =========================================================

  // Base semanal (fixa por dia da semana)
  // Obs.: Os ‚Äúcarros‚Äù aqui representam as 2 linhas da tabela: Carro 1 e Carro 2.
  // Onde existe dupla, usamos "Nome1 & Nome2" (mesma apresenta√ß√£o do seu HTML de janeiro).
  const escalaBaseSemanal = {
    // Segunda
    'SEG:Matutino':  {carro1:['J√∫lio'], carro2:['Luciene']},
    'SEG:Vespertino':{carro1:['Juliana K√™nia','Tathiane'], carro2:['Rodrigo']},

    // Ter√ßa
    'TER:Matutino':  {carro1:['Fab√≠ola','Lidiane'], carro2:['Luciana Consola√ß√£o','Adriana']},
    'TER:Vespertino':{carro1:['Adriane','Patr√≠cia'], carro2:['Cl√≥vis','Viviane Miyada']},

    // Quarta
    'QUA:Matutino':  {carro1:['Aline','Ariane'], carro2:['Vanessa Santana']},
    'QUA:Vespertino':{carro1:['Jos√© Luiz'], carro2:['Juliana K√™nia','Tathiane']},

    // Quinta
    'QUI:Matutino':  {carro1:['Adriana','Luciana Consola√ß√£o'], carro2:['L√≠via Brito','Pedro']},
    'QUI:Vespertino':{carro1:['Adriane','Patr√≠cia'], carro2:['Jos√© Luiz']},

    // Sexta
    'SEX:Matutino':  {carro1:['Jo√£o Batista'], carro2:['Vanessa Santana']},
    'SEX:Vespertino':{carro1:['Jo√£o Batista'], carro2:['Rodrigo']},
  };

  // F√©rias
  // ‚úÖ Fonte √∫nica: ferias.html (mesma pasta). Assim voc√™ atualiza em um lugar s√≥.
  // L√™ a tabela <tr><td>Funcion√°rio</td><td>In√≠cio</td><td>Final</td></tr> e converte para ISO.
  // (Se ferias.html n√£o carregar, a escala roda sem aplicar f√©rias.)
  let ferias = [];

  function ddmmyyyyToISO(s){
    if(!s) return '';
    const p = s.trim().split('/');
    if(p.length !== 3) return '';
    const dd = p[0].padStart(2,'0');
    const mm = p[1].padStart(2,'0');
    const yy = p[2];
    return `${yy}-${mm}-${dd}`;
  }

  async function carregarFeriasDeHTML(){
    try{
      const bust = Date.now();
      const resp = await fetch(`./ferias.html?v=${bust}`, { cache: 'no-store' });
      if(!resp.ok) throw new Error('HTTP ' + resp.status);
      const html = await resp.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');

      // O ferias.html atual tem uma tabela com 3 colunas: Funcion√°rio, In√≠cio, Final
      const table = doc.querySelector('table');
      if(!table) throw new Error('Tabela n√£o encontrada em ferias.html');

      const rows = Array.from(table.querySelectorAll('tr')).slice(1); // pula cabe√ßalho
      const lista = [];

      rows.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if(tds.length < 3) return;
        const nome = (tds[0].textContent || '').trim();
        const iniBR = (tds[1].textContent || '').trim();
        const fimBR = (tds[2].textContent || '').trim();
        const ini = ddmmyyyyToISO(iniBR);
        const fim = ddmmyyyyToISO(fimBR);
        if(nome && ini && fim){
          lista.push({ nome, inicio: ini, fim: fim });
        }
      });

      ferias = lista;
      console.log(`‚úÖ F√©rias carregadas de ferias.html: ${ferias.length} registros`);
    }catch(err){
      console.warn('‚ö†Ô∏è N√£o foi poss√≠vel carregar ferias.html. Escala seguir√° sem aplicar f√©rias.', err);
      ferias = [];
    }
  }

  // =========================================================
  // Utilit√°rios
  // =========================================================
  const diasPt = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
  const mapDiaKey = { 'Seg':'SEG', 'Ter':'TER', 'Qua':'QUA', 'Qui':'QUI', 'Sex':'SEX' };

  function norm(s){
    return (s||'')
      .toString()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .replace(/\s+/g,' ')
      .trim();
  }

  // Tentativa segura de casar "apelido" da escala com nome completo das f√©rias.
  // Ex.: "Luciene" casa com "Luciene de Souza Barbosa...".
  function nomeCasaComFerias(nomeEscala, nomeFerias){
    const a = norm(nomeEscala);
    const b = norm(nomeFerias);
    if (!a || !b) return false;

    // Se um cont√©m o outro, j√° resolve (ex.: "luciene" dentro do nome completo)
    if (b.includes(a) || a.includes(b)) return true;

    // Token match: todos os tokens de a devem aparecer em b
    const toks = a.split(' ').filter(t => t.length >= 3);
    if (!toks.length) return false;
    return toks.every(t => b.includes(t));
  }

  function estaDeFerias(nomeEscala, dateISO){
    const d = new Date(dateISO + 'T00:00:00');
    return ferias.some(f => {
      if (!nomeCasaComFerias(nomeEscala, f.nome)) return false;
      const ini = new Date(f.inicio + 'T00:00:00');
      const fim = new Date(f.fim + 'T23:59:59');
      return d >= ini && d <= fim;
    });
  }

  function formatarDuplaOuSolo(pessoas){
    if (!pessoas || !pessoas.length) return 'VAGO';

    // remove quem est√° de f√©rias (regra: se dupla e 1 afastado, o outro segue)
    const ativos = pessoas.filter(n => !window.__dataParaChecagem || !estaDeFerias(n, window.__dataParaChecagem));

    if (!ativos.length) return 'VAGO';
    if (ativos.length === 1) return ativos[0];
    return ativos.join(' & ');
  }

  // =========================================================
  // Gera√ß√£o da escala mensal (mesmo dia da semana, muda o calend√°rio)
  // =========================================================
  function gerarEscalaMes(ano, mes){
    // mes: 1-12
    const diasNoMes = new Date(ano, mes, 0).getDate();
    const linhas = [];

    for (let dia = 1; dia <= diasNoMes; dia++) {
      const dt = new Date(ano, mes - 1, dia);
      const dow = diasPt[dt.getDay()];
      const iso = dt.toISOString().split('T')[0];

      // Fim de semana
      if (dow === 'S√°b' || dow === 'Dom') {
        linhas.push({
          dataISO: iso,
          dataBR: String(dia).padStart(2,'0') + '/' + String(mes).padStart(2,'0') + '/' + ano,
          diaSemana: dow,
          turno: '‚Äî',
          carro1: '‚Äî',
          carro2: '‚Äî',
          isWeekend: true
        });
        continue;
      }

      // Dias √∫teis: Matutino e Vespertino
      const keyDia = mapDiaKey[dow];
      ['Matutino','Vespertino'].forEach(turno => {
        const baseKey = keyDia + ':' + turno;
        const cfg = escalaBaseSemanal[baseKey];

        // Guardar data global para checagem de f√©rias dentro do formatter
        window.__dataParaChecagem = iso;

        const carro1 = cfg ? formatarDuplaOuSolo(cfg.carro1) : '‚Äî';
        const carro2 = cfg ? formatarDuplaOuSolo(cfg.carro2) : '‚Äî';

        linhas.push({
          dataISO: iso,
          dataBR: String(dia).padStart(2,'0') + '/' + String(mes).padStart(2,'0') + '/' + ano,
          diaSemana: dow,
          turno,
          carro1,
          carro2,
          isWeekend: false
        });
      });
    }

    // Limpa vari√°vel auxiliar
    window.__dataParaChecagem = null;
    return linhas;
  }

  // =========================================================
  // UI / DataTable
  // =========================================================
  let tabela;
  let dadosMes = [];

  function initMesAno(){
    const mesSel = document.getElementById('fMes');
    const anoSel = document.getElementById('fAno');
    const hoje = new Date();

    for (let m = 0; m < 12; m++) {
      const opt = document.createElement('option');
      opt.value = m + 1;
      opt.text = new Date(2000, m, 1).toLocaleString('pt-BR', { month: 'long' });
      if (m === hoje.getMonth()) opt.selected = true;
      mesSel.appendChild(opt);
    }

    for (let a = 2024; a <= 2030; a++) {
      const opt = document.createElement('option');
      opt.value = a;
      opt.text = a;
      if (a === hoje.getFullYear()) opt.selected = true;
      anoSel.appendChild(opt);
    }
  }

  function carregarTabela(){
    tabela = $('#tabelaVeiculos').DataTable({
      language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json' },
      pageLength: 50,
      lengthMenu: [25, 50, 100, -1],
      order: [[0, 'asc'], [2, 'asc']],
      data: [],
      columns: [
        { data: 'dataISO' },
        { data: 'diaSemana' },
        { data: 'turno' },
        { data: 'carro1' },
        { data: 'carro2' }
      ],
      createdRow: function(row, data){
        if (data.isWeekend) $(row).addClass('tag-weekend');
        if (data.carro1 === 'VAGO' || data.carro2 === 'VAGO') $(row).addClass('tag-vago');
      }
    });
  }

  function aplicarFiltros(){
    const nome = norm(document.getElementById('fFiscal').value);
    const dataStr = document.getElementById('fData').value; // YYYY-MM-DD
    const turno = document.getElementById('fTurno').value;
    const mes = parseInt(document.getElementById('fMes').value);
    const ano = parseInt(document.getElementById('fAno').value);

    // Sempre (re)gera a escala do m√™s selecionado
    dadosMes = gerarEscalaMes(ano, mes);

    let filtrado = dadosMes;

    // Data espec√≠fica
    if (dataStr) {
      filtrado = filtrado.filter(l => l.dataISO === dataStr);
    }

    // Turno
    if (turno) {
      filtrado = filtrado.filter(l => l.turno === turno);
    }

    // Fiscal (procura em Carro1/Carro2)
    if (nome) {
      filtrado = filtrado.filter(l => {
        return norm(l.carro1).includes(nome) || norm(l.carro2).includes(nome);
      });
    }

    // Ordena√ß√£o do DataSet (acento pt-BR) por data + turno
    filtrado.sort((a,b) => {
      if (a.dataISO !== b.dataISO) return a.dataISO.localeCompare(b.dataISO);
      return a.turno.localeCompare(b.turno, 'pt-BR', { sensitivity: 'variant' });
    });

    tabela.clear();
    tabela.rows.add(filtrado).draw();
  }

  document.addEventListener('DOMContentLoaded', async () => {
    initMesAno();
    carregarTabela();

    // Carrega f√©rias a partir do ferias.html (fonte √∫nica)
    await carregarFeriasDeHTML();

    // Padr√£o: mostra o m√™s corrente
    aplicarFiltros();
  });
</script>

</body>
</html>
