<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <!-- Meta tags bÃ¡sicas -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Open Graph -->
  <meta property="og:title" content="VigilÃ¢ncia SanitÃ¡ria de AnÃ¡polis">
  <meta property="og:description" content="Aplicativo interno da VigilÃ¢ncia SanitÃ¡ria">
  <meta property="og:image" content="https://garrado.github.io/VISA/icons/visa-compartilhar.png">
  <meta property="og:url" content="https://garrado.github.io/VISA/">
  <meta property="og:type" content="website">
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#004aad">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icons/visa-192.png">
  
  <title>VigilÃ¢ncia SanitÃ¡ria</title>
  
  <!-- CSS Externo - SEM <style> inline! -->
  <link rel="stylesheet" href="./css/design-tokens.css">
  <link rel="stylesheet" href="./css/base.css">
  <link rel="stylesheet" href="./css/components.css">
  <link rel="stylesheet" href="./css/layouts.css">
  
  <!-- JavaScript -->
  <script src="./js/platform-detector.js"></script>
  <script src="./js/header-loader.js"></script>
</head>

<body>

<!-- Loading -->
<div id="loading">
  <div class="spinner"></div>
  <div style="color:var(--primary); font-weight:600">Verificando acesso...</div>
</div>

<!-- Login -->
<div id="login">
  <div class="loginCard">
    <h2>Ãrea Restrita</h2>
    <p>Entre com sua conta Google para acessar os conteÃºdos internos.</p>
    <button class="btn btnPrimary" onclick="loginGoogle()">Entrar com Google</button>
  </div>
</div>

<!-- ConteÃºdo Principal -->
<div id="conteudo">

<!-- HEADER AUTOMÃTICO - Gerado por header-loader.js -->
<div id="app-header"></div>

<div class="container">

  <div class="grid">
    <!-- Card Avisos -->
    <div class="card avisos">
      <h3>Novidades no Aplicativo</h3>

      <p>
        ğŸ“Š <strong>Indicadores em Tempo Real</strong><br>
      </p>
      <br>
      <p>
        Dados do mÃªs carregados automaticamente: inspeÃ§Ãµes, autos, fiscais e tipos de documentos.
      </p>
      <br>

      <p>
        ğŸ“š <strong>InspeÃ§Ãµes por PerÃ­odo</strong><br>
      </p>
      <br>
      <p>
        Lista todas inspeÃ§Ãµes por fiscal e perÃ­odo desde 2018.
      </p>
      <br>

      <h3>Aviso da SupervisÃ£o</h3>
      <p>
        ğŸ† <strong>Feliz 2026</strong><br>
      </p>
      <br>
      <p>
        Desejamos a todos um Feliz 2026.
      </p>
      <br>
      <p>
        Supervisor de VigilÃ¢ncia SanitÃ¡ria
      </p>
      <br>

      <!-- Indicadores do MÃªs -->
      <div class="indicadores-section">
        <h3>ğŸ“Š Indicadores do MÃªs</h3>
        <div id="indicadores-content">
          <div class="indicadores-loading">ğŸ“Š Carregando dados...</div>
        </div>
      </div>

    </div>

    <!-- Card Central de Trabalho -->
    <div class="card links-section">
      <h3>Central de Trabalho</h3>
      <ul>
        <li><a class="linkPill" href="RPF\RPF2-PERFEITO-AUTH-DROPDOWN.html"><div>InspeÃ§Ãµes<br><small>RelatÃ³rio por fiscal e perÃ­odo</small></div><div class="arrow">ğŸ“Š</div></a></li>
        <li><a class="linkPill" href="legislacao.html"><div>LegislaÃ§Ã£o<br><small>Consulta normativa</small></div><div class="arrow">ğŸ“œ</div></a></li>
        <li><a class="linkPill" href="check.html"><div>Check List<br><small>Roteiro de inspeÃ§Ã£o</small></div><div class="arrow">âœ“</div></a></li>
        <li><a class="linkPill" href="Escala_Ferias_Janeiro_2026_APP"><div>FÃ©rias<br><small>Escala de fÃ©rias de janeiro</small></div><div class="arrow">ğŸ–ï¸</div></a></li>
        <li><a class="linkPill" href="Escala_Veiculos_Janeiro_2026_APP.html"><div>VeÃ­culos<br><small>Escala de uso dos veÃ­culos em janeiro</small></div><div class="arrow">ğŸš—</div></a></li>
        <li><a class="linkPill" href="Escala_Plantao_Janeiro_2026"><div>PlantÃ£o Fiscal<br><small>Escala de plantÃ£o em janeiro</small></div><div class="arrow">ğŸ“…</div></a></li>
        <li><a class="linkPill" href="relatorio_plantao_fiscal.html"><div>OcorrÃªncias<br><small>RelatÃ³rio do plantÃ£o fiscal</small></div><div class="arrow">ğŸ“ˆ</div></a></li>
        <li><a class="linkPill" href="cadastro_economico_por_equipe_colorido.html"><div>CNAEs<br><small>DistribuiÃ§Ã£o por Ã¡rea</small></div><div class="arrow">ğŸ‘¥</div></a></li>
        <li><a class="linkPill" href="Regulados.html"><div>WebCVS<br><small>Sistema CVS online</small></div><div class="arrow">ğŸŒ</div></a></li>
        <li><a class="linkPill" href="mailto:visa@anapolis.go.gov.br"><div>SugestÃµes<br><small>Envie sua ideia</small></div><div class="arrow">ğŸ’¡</div></a></li>
      </ul>
    </div>
  </div>

  <!-- Card Mensagem Institucional -->
  <div class="card">
    <h3>Mensagem Institucional</h3>
    <p>
      Esta pÃ¡gina interna da GerÃªncia de VigilÃ¢ncia SanitÃ¡ria reÃºne informaÃ§Ãµes, links e comunicados destinados aos servidores, com o objetivo de apoiar as atividades de fiscalizaÃ§Ã£o sanitÃ¡ria, promovendo a qualidade das aÃ§Ãµes fiscalizatÃ³rias e a melhor organizaÃ§Ã£o da comunicaÃ§Ã£o e do acesso a dados operacionais.
    </p>
    <br>
    <p class="small">
      ğŸ“„ <a href="README.html" target="_blank" rel="noopener">Consulte aqui o Aviso Institucional e as regras de uso da plataforma</a>
    </p>
  </div>

</div>

<!-- BotÃ£o Encerrar SessÃ£o -->
<div style="text-align: center; padding: 20px 16px;">
  <button class="btn" onclick="logout()">Encerrar sessÃ£o</button>
</div>

<!-- Footer -->
<div class="footer">
  VigilÃ¢ncia SanitÃ¡ria â€“ Diretoria de VigilÃ¢ncia em SaÃºde<br>
  MunicÃ­pio de AnÃ¡polis â€“ GO<br>
  Â© 2025
</div>

</div>

<!-- Modal NÃ£o Autorizado -->
<div id="modalNaoAutorizado" class="modalOverlay" style="display:none" role="dialog" aria-modal="true" aria-labelledby="modalNaoAutorizadoTitulo">
  <div class="modalCard">
    <h3 id="modalNaoAutorizadoTitulo">Acesso nÃ£o autorizado</h3>
    <p>Sua conta Google nÃ£o consta na lista de usuÃ¡rios liberados para esta pÃ¡gina institucional.</p>
    <p class="small" id="modalNaoAutorizadoConta"></p>
    <p class="small">Solicite a liberaÃ§Ã£o ao administrador da pÃ¡gina e tente novamente.</p>
    <div class="modalActions">
      <button class="btn btnPrimary" onclick="fecharModalNaoAutorizado()">Entendi</button>
    </div>
  </div>
</div>

<!-- Firebase Authentication -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  signInWithPopup,
  GoogleAuthProvider,
  onAuthStateChanged,
  signOut,
  setPersistence,
  browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// Sistema de Cache
const AUTH_CACHE_KEY = 'visa_auth_cache';
const AUTH_CACHE_DURATION = 60 * 60 * 1000;

class AuthCache {
  constructor() {
    this.cacheKey = AUTH_CACHE_KEY;
    this.cacheDuration = AUTH_CACHE_DURATION;
  }

  save(user) {
    const cacheData = {
      email: user.email,
      uid: user.uid,
      displayName: user.displayName,
      photoURL: user.photoURL,
      timestamp: Date.now(),
      expiresAt: Date.now() + this.cacheDuration
    };
    try {
      localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
      console.log('âœ… Cache salvo - vÃ¡lido por', Math.floor(this.cacheDuration / 1000 / 60), 'minutos');
    } catch (error) {
      console.warn('Erro ao salvar cache:', error);
    }
  }

  get() {
    try {
      const cached = localStorage.getItem(this.cacheKey);
      if (!cached) return null;
      const data = JSON.parse(cached);
      if (Date.now() < data.expiresAt) return data;
      this.clear();
      return null;
    } catch (error) {
      return null;
    }
  }

  clear() {
    try {
      localStorage.removeItem(this.cacheKey);
      console.log('ğŸ—‘ï¸ Cache limpo');
    } catch (error) {}
  }

  getTimeRemaining() {
    const cached = this.get();
    if (!cached) return 0;
    return Math.max(0, Math.floor((cached.expiresAt - Date.now()) / 1000));
  }
}

const authCache = new AuthCache();

const firebaseConfig = {
  apiKey: "AIzaSyDo473puJesZ9rr3IBoX5AWczCIMuKBTrg",
  authDomain: "visam-3a30b.firebaseapp.com",
  projectId: "visam-3a30b",
  messagingSenderId: "308899251430",
  appId: "1:308899251430:web:0053cdbd0bed7f0de76727"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

setPersistence(auth, browserLocalPersistence).catch((error) => {
  console.error("Erro ao definir persistÃªncia:", error);
});

const AUTHORIZED_EMAILS = new Set([
  "adrianosantos@anapolis.go.gov.br",
  "acadiaasocial@gmail.com",
  "santanaluciana097@gmail.com",
  "visa.saude@anapolis.go.gov.br",
  "rubiamarabel@gmail.com",
  "ps.visa@anapolis.go.gov.br",
  "jotadaguas@gmail.com",
  "geraldoedsonrosa@gmail.com",
  "patycdmes@gmail.com",
  "ariannefvieira@hotmail.com",
  "marinaperillo@hotmail.com",
  "visa@anapolis.go.gov.br",
  "mariaedwiges@anapolis.go.gov.br",
  "tathnut@hotmail.com",
  "simonegrossi@anapolis.go.gov.br",
  "kamillarolim@gmail.com",
  "lulucieneepais@gmail.com",
  "adrianepereira@anapolis.go.gov.br",
  "claudio@anapolis.go.gov.br",
  "silviamarques@anapolis.go.gov.br",
  "mhg.rodovalho@gmail.com",
  "medwiges@gmail.com",
  "lindaenila@gmail.com",
  "wanessab412@gmail.com",
  "juliocteles@anapolis.go.gov.br",
  "fabiolappmarques@gmail.com",
  "lidianesimoes@anapolis.go.gov.br",
  "educacao.esportes@anapolis.go.gov.br",
  "crbferreira81@gmail.com",
  "profajulianakenia@gmail.com",
  "dani.visaanapolis@gmail.com",
  "medicamentos@anapolis.go.gov.br",
  "cesio@anapolis.go.gov.br",
  "gubio@anapolis.go.gov.br",
  "marciorodovalho@anapolis.go.gov.br",
  "edsonarantes@anapolis.go.gov.br",
  "981217644pedro@gmail.com",
  "julianafviturino@gmail.com",
  "thaysasouza97@gmail.com",
  "farm.castro78@gmail.com",
  "viniciuscassiano@anapolis.go.gov.br",
  "thiagogomesgobo@gmail.com",
  "liviabr.visa@gmail.com",
  "wanessa05@gmail.com",
  "santosrat@gmail.com",
  "vivianemiyada@gmail.com",
  "angelavet2@gmail.com",
  "diasbrito1515@gmail.com",
  "ademargatu86@gmail.com",
  "cidalinacoelho@anapolis.go.gov.br",
  "lauraeleuza@gmail.com",
  "portaria344@anapolis.go.gov.br",
  "mens.agitat.molem.cns@gmail.com"
]);

function isAuthorized(user){
  const email = (user?.email || "").toLowerCase().trim();
  return AUTHORIZED_EMAILS.has(email);
}

function showLoading(){
  document.getElementById("loading").style.display = "flex";
  document.getElementById("login").style.display = "none";
  document.getElementById("conteudo").style.display = "none";
}

function showLogin(){
  document.getElementById("loading").style.display = "none";
  document.getElementById("login").style.display = "flex";
  document.getElementById("conteudo").style.display = "none";
}

function showConteudo(){
  document.getElementById("loading").style.display = "none";
  document.getElementById("login").style.display = "none";
  document.getElementById("conteudo").style.display = "block";
}

function showUnauthorizedModal(user){
  const modal = document.getElementById("modalNaoAutorizado");
  const conta = document.getElementById("modalNaoAutorizadoConta");
  const email = user?.email || "(e-mail nÃ£o identificado)";
  if (conta) conta.textContent = `E-mail: ${email}`;
  if (modal) modal.style.display = "flex";
}

window.__pendingLogout = false;

window.fecharModalNaoAutorizado = async function(){
  const modal = document.getElementById("modalNaoAutorizado");
  if (modal) modal.style.display = "none";

  if (window.__pendingLogout){
    window.__pendingLogout = false;
    try { await signOut(auth); } catch(e){ console.error(e); }
  }
};

document.addEventListener("click", (e) => {
  const modal = document.getElementById("modalNaoAutorizado");
  if (modal && modal.style.display === "flex" && e.target === modal) {
    window.fecharModalNaoAutorizado();
  }
});

window.loginGoogle = function() {
  signInWithPopup(auth, provider).catch(console.error);
};

window.logout = function(){
  signOut(auth).catch(console.error);
};

(function initOptimizedAuth() {
  const cachedAuth = authCache.get();
  
  if (cachedAuth && AUTHORIZED_EMAILS.has(cachedAuth.email.toLowerCase())) {
    console.log('âœ… Login via cache - vÃ¡lido por', authCache.getTimeRemaining(), 'segundos');
    showConteudo();
    
    onAuthStateChanged(auth, (user) => {
      if (user && isAuthorized(user)) {
        authCache.save(user);
      } else {
        authCache.clear();
        showLogin();
      }
    });
    
    return;
  }

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      showLogin();
      return;
    }

    if (isAuthorized(user)) {
      authCache.save(user);
      showConteudo();
      return;
    }

    showLogin();
    showUnauthorizedModal(user);
    window.__pendingLogout = true;
  });
})();
</script>

<!-- Papa Parse para carregar CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- Script dos Indicadores -->
<script>
function carregarIndicadores() {
  const container = document.getElementById('indicadores-content');
  if (!container) return;
  
  Papa.parse('RPF/inspecoes.cvs', {
    download: true,
    header: false,
    delimiter: ';',
    skipEmptyLines: true,
    complete: function(results) {
      processarDados(results.data, container);
    },
    error: function(error) {
      container.innerHTML = '<div class="indicadores-loading">âš ï¸ Erro ao carregar dados</div>';
    }
  });
}

function processarDados(data, container) {
  const rows = data.slice(1);
  
  let inspecoesFiltradas = rows.filter(row => row[2] && row[2].includes('01.2026'));
  let periodoTexto = 'Janeiro 2026';
  
  if (inspecoesFiltradas.length === 0) {
    inspecoesFiltradas = rows.filter(row => row[2] && row[2].includes('12.2025'));
    periodoTexto = 'Dezembro 2025';
  }
  
  if (inspecoesFiltradas.length === 0) {
    inspecoesFiltradas = rows.slice(-1000);
    periodoTexto = 'Ãšltimos 1000';
  }
  
  const totalInspecoes = inspecoesFiltradas.length;
  const autos = inspecoesFiltradas.filter(row => row[6] && row[6].includes('AUTO DE IMPOSIÃ‡ÃƒO')).length;
  
  const fiscaisSet = new Set();
  inspecoesFiltradas.forEach(row => {
    if (row[17] && row[17].trim()) fiscaisSet.add(row[17].trim());
  });
  const totalFiscais = fiscaisSet.size;
  
  const tiposDocumentos = {};
  inspecoesFiltradas.forEach(row => {
    if (row[6] && row[6].trim()) {
      tiposDocumentos[row[6].trim()] = (tiposDocumentos[row[6].trim()] || 0) + 1;
    }
  });
  
  const topTipos = Object.entries(tiposDocumentos).sort((a, b) => b[1] - a[1]).slice(0, 5);
  const mediaPorFiscal = totalFiscais > 0 ? Math.round(totalInspecoes / totalFiscais) : 0;
  const taxaAutos = totalInspecoes > 0 ? ((autos / totalInspecoes) * 100).toFixed(1) : 0;
  
  renderizarIndicadores(container, {totalInspecoes, autos, totalFiscais, mediaPorFiscal, taxaAutos, topTipos, periodoTexto});
}

function renderizarIndicadores(container, dados) {
  let html = '<div class="stats-grid">';
  
  // Card InspeÃ§Ãµes
  html += '<div class="stat-card">';
  html += '<div class="stat-icon">ğŸ“Š</div>';
  html += '<div>';
  html += '<div class="stat-numero">' + dados.totalInspecoes + '</div>';
  html += '<div class="stat-label">InspeÃ§Ãµes</div>';
  html += '<div class="stat-detalhe">MÃ©dia ' + dados.mediaPorFiscal + '/fiscal</div>';
  html += '</div></div>';
  
  // Card Autos
  html += '<div class="stat-card">';
  html += '<div class="stat-icon">ğŸ“‹</div>';
  html += '<div>';
  html += '<div class="stat-numero">' + dados.autos + '</div>';
  html += '<div class="stat-label">Autos</div>';
  html += '<div class="stat-detalhe">Taxa ' + dados.taxaAutos + '%</div>';
  html += '</div></div>';
  
  // Card Fiscais
  html += '<div class="stat-card">';
  html += '<div class="stat-icon">ğŸ‘¥</div>';
  html += '<div>';
  html += '<div class="stat-numero">' + dados.totalFiscais + '</div>';
  html += '<div class="stat-label">Fiscais</div>';
  html += '<div class="stat-detalhe">Ativos</div>';
  html += '</div></div>';
  
  html += '</div>';
  
  // Tabela de Documentos
  html += '<div class="tipos-table-container">';
  html += '<h4>ğŸ“„ Tipos de Documentos</h4>';
  html += '<table class="tipos-table">';
  
  dados.topTipos.forEach(function(item) {
    const porcentagem = ((item[1] / dados.totalInspecoes) * 100).toFixed(0);
    let nome = item[0];
    if (nome.length > 28) nome = nome.substring(0, 25) + '...';
    
    html += '<tr><td>' + nome;
    html += '<div class="tipo-barra"><div class="tipo-barra-fill" style="width:' + porcentagem + '%;"></div></div>';
    html += '</td><td>' + item[1] + '</td></tr>';
  });
  
  html += '</table></div>';
  html += '<div class="update-info">ğŸ“… ' + dados.periodoTexto + ' â€¢ ğŸ”„ Atualizado</div>';
  
  container.innerHTML = html;
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', carregarIndicadores);
} else {
  carregarIndicadores();
}
</script>

</body>
</html>
