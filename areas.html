<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Áreas de Atuação – Vigilância Sanitária</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="./css/design-tokens.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
body{font-family:system-ui,Segoe UI,Arial;background:#f6f7fb;margin:0}
header{background:#1a3a6b;color:#fff;padding:26px 20px;text-align:center;position:sticky;top:0}
header h1{margin:0;font-size:2rem;font-weight:900}
header h2{margin-top:6px;font-weight:500;opacity:.9}

.container{max-width:1100px;margin:20px auto;padding:0 16px}
.card{background:#fff;border-radius:16px;padding:18px;margin-bottom:16px;box-shadow:0 4px 14px rgba(0,0,0,.08)}

.filters{display:grid;grid-template-columns:2fr 2fr 1fr 140px 140px;gap:12px}
label{font-weight:700;margin-bottom:6px}
input,select,button{padding:12px;border-radius:10px;border:1px solid #ccc;font-size:1rem}
button{font-weight:800;cursor:pointer}
.btn{background:#2c5aa0;color:#fff;border:none}
.btn-clear{background:#eef2ff;color:#1a3a6b}

table{width:100%;border-collapse:collapse;background:#fff}
th{background:#2c5aa0;color:#fff;padding:10px;cursor:pointer;white-space:nowrap}
td{padding:10px;border-bottom:1px solid #ddd}
tr:hover td{background:#f1f5ff}
.hit{background:#ffe066;border-left:4px solid #1a3a6b;padding:2px 6px;font-weight:900}

.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999}
.modal-box{background:#fff;max-width:760px;margin:5vh auto;border-radius:16px;padding:20px}
.modal-box h3{color:#1a3a6b}
</style>
</head>

<body>

<header>
  <h1>Vigilância Sanitária</h1>
  <h2>Áreas de Atuação por Bairro</h2>
</header>

<div class="container">

<div class="card">
<div class="filters">
  <div>
    <label>Bairro / Local</label>
    <input id="qBairro">
  </div>
  <div>
    <label>Fiscal</label>
    <input id="qFiscal">
  </div>
  <div>
    <label>Área</label>
    <select id="fSigla"><option value="">Todas</option></select>
  </div>
  <button class="btn" onclick="render()">Buscar</button>
  <button class="btn-clear" onclick="limpar()">Limpar</button>
</div>
</div>

<div class="card">
<table>
<thead><tr id="thead"></tr></thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<!-- MODAL CNAE -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle"></h3>
    <ul id="modalList"></ul>
    <button class="btn-clear" onclick="closeModal()">Fechar</button>
  </div>
</div>

<script>
const CSV_BAIRROS="data/bairros.csv";
const CSV_CNAE="data/cnae.csv";

const IGNORE=["CODIGO","SETOR","SETORALIMENTO","FU","CONTROLE"];

const SIGLA_TO_NOME={
  IA:"Indústrias Alimentícias",AG:"Alimentos em Geral",ED:"Ensino",
  OS:"Produtos para Saúde",SS:"Serviços de Saúde",OD:"Serviços Odontológicos",
  CS:"Cosméticos",AM:"Ambiental",VT:"Veterinária",BI:"Outras Áreas I",
  LP:"Assistência à Saúde",AO:"Outras Áreas II",TR:"Transporte",
  DR:"Medicamentos",MD:"Medicamentos",PS:"Produtos Sujeitos à VISA"
};

let dados=[],siglas=[],cnaeMap={};

const norm=s=>String(s||"").toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");

Papa.parse(CSV_CNAE,{
 download:true,header:true,
 complete:r=>{
  r.data.forEach(l=>{
   if(!cnaeMap[l.Equipe]) cnaeMap[l.Equipe]=[];
   if(l.Atividade) cnaeMap[l.Equipe].push(l.Atividade);
  });
 }
});

Papa.parse(CSV_BAIRROS,{
 download:true,header:true,
 complete:r=>{
  const h=Object.keys(r.data[0]).filter(c=>!IGNORE.includes(c));
  siglas=h.filter(c=>c!=="NOME");
  dados=r.data;
  montarHeader();
  montarFiltro();
  render();
 }
});

function montarHeader(){
  const th=document.getElementById("thead");
  th.innerHTML="<th>Bairro</th>"+siglas.map(s=>
   `<th onclick="openModal('${s}')">${SIGLA_TO_NOME[s]||s}</th>`).join("");
}

function montarFiltro(){
  fSigla.innerHTML="<option value=''>Todas</option>"+
    siglas.map(s=>`<option value="${s}">${SIGLA_TO_NOME[s]||s}</option>`).join("");
}

function render(){
 tbody.innerHTML="";
 dados.filter(l=>{
  if(qBairro.value && !norm(l.NOME).includes(norm(qBairro.value))) return false;
  if(fSigla.value && !l[fSigla.value]) return false;
  if(qFiscal.value){
   return siglas.some(s=>norm(l[s]).includes(norm(qFiscal.value)));
  }
  return true;
 }).forEach(l=>{
  tbody.innerHTML+=
   "<tr><td>"+l.NOME+"</td>"+
   siglas.map(s=>{
    let v=l[s]||"";
    if(qFiscal.value && norm(v).includes(norm(qFiscal.value)))
      v=`<span class="hit">${v}</span>`;
    return `<td>${v}</td>`;
   }).join("")+"</tr>";
 });
}

function limpar(){qBairro.value=qFiscal.value=fSigla.value="";render()}

function openModal(sigla){
 modal.style.display="block";
 modalTitle.innerText=SIGLA_TO_NOME[sigla]+" ("+sigla+")";
 modalList.innerHTML=(cnaeMap[sigla]||["Nenhuma atividade"]).map(a=>`<li>${a}</li>`).join("");
}
function closeModal(){modal.style.display="none"}
</script>

</body>
</html>
