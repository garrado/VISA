<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Divis√£o por Bairro/Local √ó Fiscal (SIGLAS) - VISA An√°polis</title>

  <!-- Mesmo design tokens do seu app (se existir na pasta css/) -->
  <link rel="stylesheet" href="./css/design-tokens.css">

  <!-- PapaParse (igual ao RPF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    /* === BASE (padr√£o do RPF) === */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }

    /* fallback caso design-tokens.css n√£o exista */
    :root{
      --bg:#f6f7fb;
      --text:#0f172a;
      --muted:#64748b;
      --card:#ffffff;
      --line:#e5e7eb;
      --shadow: 0 8px 28px rgba(15,23,42,.10);
      --shadow2: 0 4px 14px rgba(15,23,42,.08);
      --brand1:#2c5aa0;
      --brand2:#1a3a6b;
      --input-bg:#fff;
      --input-text:#0f172a;
      --input-border:#d1d5db;
      --input-focus:#2c5aa0;
    }

    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.55;
    }

    header{
      background: #1a3a6b;
      color: #fff;
      padding: 28px 20px 26px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.12);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header h1{
      margin: 0;
      font-size: clamp(1.7rem, 2.4vw, 2.3rem);
      font-weight: 900;
      letter-spacing: .2px;
    }
    header h2{
      margin: 8px 0 0;
      font-size: clamp(1rem, 1.5vw, 1.15rem);
      font-weight: 500;
      opacity: .92;
    }
    .btn-ok-header{
      position: absolute;
      top: 50%;
      right: 16px;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: #34C759;
      font-size: 17px;
      font-weight: 600;
      padding: 16px 12px;
      cursor: pointer;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-ok-header:hover{ opacity: .75; }

    .container{
      max-width: 1100px;
      margin: 22px auto 30px;
      padding: 0 16px;
    }

    .card{
      background: var(--card);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 16px;
      border: 1px solid var(--line);
      box-shadow: var(--shadow2);
    }

    .filter-row{
      display: grid;
      grid-template-columns: 2fr 2fr 1fr 160px 140px;
      gap: 14px;
      align-items: end;
    }

    .filter-group{
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .filter-group label{
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text);
      font-size: .95em;
    }

    .filter-group input,
    .filter-group select{
      width: 100%;
      padding: 12px;
      border: 1px solid var(--input-border);
      border-radius: 10px;
      font-size: 1em;
      background: var(--input-bg);
      color: var(--input-text);
      outline: none;
      min-width: 0;
    }

    .filter-group input:focus,
    .filter-group select:focus{
      border-color: var(--input-focus);
      box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.15);
    }

    .btn-search{
      padding: 12px 18px;
      background: linear-gradient(135deg, var(--brand1), var(--brand2));
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 1em;
      font-weight: 800;
      cursor: pointer;
      transition: .15s transform, .15s box-shadow;
      width: 100%;
    }
    .btn-search:hover{ box-shadow: var(--shadow2); transform: translateY(-1px); }
    .btn-search:active{ transform: translateY(0); }

    .btn-clear{
      padding: 12px 18px;
      background: #eef2ff;
      color: #1a3a6b;
      border: 1px solid #c7d2fe;
      border-radius: 12px;
      font-size: 1em;
      font-weight: 800;
      cursor: pointer;
      width: 100%;
    }
    .btn-clear:hover{ filter: brightness(0.98); }

    .results-card{
      background: var(--card);
      border-radius: 16px;
      padding: 18px;
      border: 1px solid var(--line);
      box-shadow: var(--shadow2);
    }

    .info-box{
      background: rgba(44, 90, 160, 0.08);
      border-left: 4px solid var(--brand1);
      padding: 12px 14px;
      margin-bottom: 14px;
      border-radius: 6px;
      color: var(--text);
      font-weight: 600;
    }

    .table-responsive{
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      border: 1px solid var(--line);
    }

    table{
      width: max(100%, 1050px);
      border-collapse: collapse;
      background: #fff;
    }
    thead th{
      background: var(--brand1);
      color: #fff;
      font-weight: 800;
      padding: 12px 10px;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 2;
      white-space: nowrap;
    }
    tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
      color: var(--text);
      font-size: .95em;
    }
    tbody tr:hover td{
      background: rgba(44, 90, 160, 0.05);
    }

    .muted{ color: var(--muted); font-weight: 600; }
    .mono{
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .hit{
      background: #fff7dd;
      border-radius: 6px;
      padding: 0 3px;
      display: inline-block;
    }

    .footer{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
    }

    @media (max-width: 1024px){
      .filter-row{ grid-template-columns: 1fr; }
      header{ padding: 28px 70px 26px 20px; }
      .btn-search, .btn-clear{ padding: 14px; }
      .filter-group input, .filter-group select{ font-size: 16px; }
    }
  </style>
</head>

<body>
  <header>
    <a class="btn-ok-header" href="index.html">OK</a>
    <h1>Vigil√¢ncia Sanit√°ria</h1>
    <h2>Divis√£o por Bairro/Local √ó Fiscal (por SIGLAS)</h2>
  </header>

  <div class="container">
    <div class="card">
      <div class="filter-row">
        <div class="filter-group">
          <label for="qBairro">Bairro/Local (NOME)</label>
          <input id="qBairro" type="text" placeholder="Ex.: Jundia√≠, Centro, Mercado..." />
        </div>

        <div class="filter-group">
          <label for="qFiscal">Fiscal (busca robusta nas SIGLAS)</label>
          <input id="qFiscal" type="text" placeholder="Ex.: LIDIANE, THIAGO, VIVIANE..." />
        </div>

        <div class="filter-group">
          <label for="fSigla">SIGLA (opcional)</label>
          <select id="fSigla">
            <option value="">(todas)</option>
          </select>
        </div>

        <div class="filter-group">
          <button class="btn-search" id="btnBuscar" type="button">üîç Buscar</button>
        </div>

        <div class="filter-group">
          <button class="btn-clear" id="btnLimpar" type="button">Limpar</button>
        </div>
      </div>
    </div>

    <div class="results-card">
      <div class="info-box" id="infoBox">
        Carregando dados‚Ä¶
      </div>

      <div class="table-responsive">
        <table>
          <thead>
            <tr id="theadRow"></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="footer">
        Fonte: <span class="mono" id="fonteCsv"></span>
        &nbsp;‚Ä¢&nbsp; Registros exibidos: <span class="mono" id="count">0</span>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== AJUSTE AQUI O CAMINHO DO CSV (o seu novo endere√ßo) =====
  // Ex.: "data/bairros.csv" ou "data/divisao_area.csv" etc.
  const CSV_FILE = "data/bairros.csv";

  // Colunas fixas (antes das SIGLAS)
  const FIXED_COLS = ["CODIGO", "NOME", "SETOR", "SETORALIMENTO"];

  // Ignorar "CONTROLE" (vem estranho no CSV √†s vezes)
  const IGNORE_COLS = new Set([
    "CONTROLE", '"CONTROLE"', "ÔªøCONTROLE", "Ôªø\"CONTROLE\"",
    "\uFEFFCONTROLE", '\uFEFF"CONTROLE"'
  ]);

  const el = (id) => document.getElementById(id);
  const qBairro = el("qBairro");
  const qFiscal = el("qFiscal");
  const fSigla  = el("fSigla");
  const tbody   = el("tbody");
  const theadRow= el("theadRow");
  const countEl = el("count");
  const infoBox = el("infoBox");
  const fonteCsv= el("fonteCsv");

  let rows = [];
  let siglas = [];

  fonteCsv.textContent = CSV_FILE;

  function norm(s){
    return String(s ?? "")
      .replace(/\u00A0/g, " ")         // NBSP
      .replace(/\s+/g, " ")
      .trim()
      .toUpperCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function highlight(original, query){
    const o = String(original ?? "");
    const nq = norm(query);
    if(!nq) return escapeHtml(o);
    if(!norm(o).includes(nq)) return escapeHtml(o);
    return `<span class="hit">${escapeHtml(o)}</span>`;
  }

  // ===== FILTRO ROBUSTO POR FISCAL =====
  // - normaliza acentos/case
  // - separa por ; , / | \n e tamb√©m por " E " (quando listam "FULANO E SICRANO")
  function cellHasFiscal(cellValue, qFiscalText){
    const q = norm(qFiscalText);
    if(!q) return true;

    const raw = norm(cellValue);
    if(!raw) return false;

    // se j√° cont√©m direto, ok
    if(raw.includes(q)) return true;

    // tokeniza√ß√£o agressiva (lista de nomes na c√©lula)
    const tokens = raw
      .replace(/\s+E\s+/g, ";")       // "FULANO E SICRANO" -> "FULANO;SICRANO"
      .split(/[;,\n\/|]+/g)
      .map(t => t.replace(/\s+/g," ").trim())
      .filter(Boolean);

    // match por token (q pode ser parte do token ou token pode ser parte do q)
    for(const t of tokens){
      if(t.includes(q) || q.includes(t)) return true;
    }
    return false;
  }

  function buildHeader(){
    const cols = [...FIXED_COLS, ...siglas];
    theadRow.innerHTML = cols.map(c => `<th>${escapeHtml(c)}</th>`).join("");
  }

  function buildSiglaFilter(){
    fSigla.innerHTML =
      `<option value="">(todas)</option>` +
      siglas.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
  }

  function rowMatches(row){
    const qb = norm(qBairro.value);
    const qf = qFiscal.value;
    const fs = fSigla.value;

    // bairro/local
    if(qb){
      if(!norm(row.NOME).includes(qb)) return false;
    }

    // sigla (se selecionou) -> exige que tenha algo nessa coluna
    if(fs){
      const v = String(row[fs] ?? "").trim();
      if(!v) return false;

      // se tamb√©m digitou fiscal, filtra SOMENTE nessa sigla
      if(qf && !cellHasFiscal(row[fs], qf)) return false;
      return true;
    }

    // fiscal (varre todas as siglas)
    if(qf){
      let ok = false;
      for(const s of siglas){
        if(cellHasFiscal(row[s], qf)){ ok = true; break; }
      }
      if(!ok) return false;
    }

    return true;
  }

  function render(){
    const filtered = rows.filter(rowMatches);
    countEl.textContent = String(filtered.length);

    const qb = qBairro.value;
    const qf = qFiscal.value;

    const cols = [...FIXED_COLS, ...siglas];

    tbody.innerHTML = filtered.map(r => {
      const tds = cols.map(c => {
        const v = r[c] ?? "";
        let content = escapeHtml(v);

        if(c === "NOME") content = highlight(v, qb);
        else if(siglas.includes(c) && qf) content = highlight(v, qf);

        if(!String(v).trim()) content = `<span class="muted">‚Äî</span>`;
        return `<td>${content}</td>`;
      }).join("");

      return `<tr>${tds}</tr>`;
    }).join("");

    infoBox.innerHTML = `‚úÖ Dados carregados. Use os filtros e clique em <b>Buscar</b>.`;
  }

  function loadCSV(){
    return new Promise((resolve, reject) => {
      Papa.parse(CSV_FILE, {
        download: true,
        header: true,
        skipEmptyLines: true,
        // se seu CSV for SEMPRE ;, pode travar aqui: delimiter: ";"
        complete: (results) => resolve(results),
        error: (err) => reject(err)
      });
    });
  }

  async function init(){
    infoBox.innerHTML = `Carregando <span class="mono">${escapeHtml(CSV_FILE)}</span>‚Ä¶`;

    const res = await loadCSV();
    const data = (res.data || []);
    const fields = (res.meta && res.meta.fields) ? res.meta.fields : Object.keys(data[0] || {});

    // limpa BOM / "CONTROLE"
    const headers = fields.map(h => String(h || "").replace(/^\uFEFF/,"").trim()).filter(Boolean);
    siglas = headers.filter(h => !IGNORE_COLS.has(h) && !FIXED_COLS.includes(h));

    rows = data.map(r => {
      const obj = {};
      for(const c of FIXED_COLS) obj[c] = r[c] ?? "";
      for(const s of siglas) obj[s] = r[s] ?? "";
      return obj;
    });

    buildHeader();
    buildSiglaFilter();
    render();
  }

  // ===== EVENTOS (padr√£o app) =====
  el("btnBuscar").addEventListener("click", render);

  // Enter para buscar
  [qBairro, qFiscal].forEach(inp => {
    inp.addEventListener("keypress", (e) => {
      if(e.key === "Enter") render();
    });
  });

  fSigla.addEventListener("change", render);

  el("btnLimpar").addEventListener("click", () => {
    qBairro.value = "";
    qFiscal.value = "";
    fSigla.value = "";
    render();
    qBairro.focus();
  });

  init().catch(err => {
    console.error(err);
    infoBox.innerHTML = `‚ùå Erro ao carregar o CSV: <span class="mono">${escapeHtml(err.message || err)}</span><br>
      <span class="muted">Dica: abra via servidor local (Live Server / python -m http.server) e confirme o caminho do arquivo.</span>`;
    tbody.innerHTML = `<tr><td colspan="50" class="muted">Sem dados.</td></tr>`;
    countEl.textContent = "0";
  });
})();
</script>
</body>
</html>
