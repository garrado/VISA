<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>√Åreas de Atua√ß√£o ‚Äì Vigil√¢ncia Sanit√°ria</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="./css/design-tokens.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,"Segoe UI",Arial;background:#f6f7fb}

  header{
    background:#1a3a6b;color:#fff;padding:26px 20px;text-align:center;
    position:sticky;top:0;z-index:100;box-shadow:0 2px 4px rgba(0,0,0,.12)
  }
  header h1{margin:0;font-size:2rem;font-weight:900}
  header h2{margin-top:6px;font-weight:500;opacity:.92}

  /* Bot√£o OK (voltar) */
  .btn-ok-header{
    position:absolute;top:50%;right:16px;transform:translateY(-50%);
    background:transparent;border:none;color:#34C759;font-size:17px;font-weight:700;
    padding:16px 12px;cursor:pointer;text-decoration:none;display:flex;align-items:center;justify-content:center;
  }
  .btn-ok-header:hover{opacity:.75}

  .container{max-width:1100px;margin:20px auto;padding:0 16px}
  .card{
    background:#fff;border-radius:16px;padding:18px;margin-bottom:16px;
    box-shadow:0 4px 14px rgba(0,0,0,.08);
  }

  .filters{display:grid;grid-template-columns:2fr 2fr 1fr 140px 140px;gap:12px;align-items:end}
  label{font-weight:800;margin-bottom:6px;display:block;color:#0f172a}
  input,select,button{padding:12px;border-radius:10px;border:1px solid #cfd3da;font-size:1rem;width:100%}
  input:focus,select:focus{outline:none;border-color:#1a3a6b;box-shadow:0 0 0 3px rgba(26,58,107,.12)}

  button{font-weight:900;cursor:pointer}
  .btn{background:#2c5aa0;color:#fff;border:none}
  .btn-clear{background:#eef2ff;color:#1a3a6b;border:1px solid #c7d2fe}
  .btn:hover{filter:brightness(.98)}
  .btn-clear:hover{filter:brightness(.98)}

  /* Dica entre filtros e tabela */
  .hint{
    background:rgba(44,90,160,.08);
    border-left:4px solid #2c5aa0;
    padding:10px 12px;
    border-radius:10px;
    color:#0f172a;
    font-weight:800;
    margin-top:12px;
  }

  /* Tabela e scroll */
  .table-wrap{overflow:auto;border-radius:12px;border:1px solid rgba(15,23,42,.10)}
  table{
    width:max(100%, 1050px);
    border-collapse:separate; border-spacing:0;
    background:#fff;
  }

  thead th{
    background:#2c5aa0;color:#fff;padding:10px;
    white-space:nowrap;
    position:sticky;top:0;z-index:2;
    text-align:left;
  }
  tbody td{
    padding:10px;border-bottom:1px solid #e5e7eb;color:#0f172a;vertical-align:top
  }
  tbody tr:hover td{background:#f1f5ff}

  /* ‚úÖ Sticky primeira coluna (Bairro) sem deslocar */
  th:first-child, td:first-child{
    position:sticky; left:0;
    background:#fff; z-index:3;
    min-width:240px;
  }
  thead th:first-child{
    background:#2c5aa0;color:#fff;z-index:6;
  }
  tr:hover td:first-child{background:#fff}

  /* Destaque fiscal */
  .hit{
    background:#ffe066;border-left:4px solid #1a3a6b;
    padding:2px 6px;border-radius:6px;font-weight:900;color:#1a3a6b;display:inline-block
  }

  .col-hidden{display:none !important;}

  /* Modal CNAE */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;padding:12px}
  .modal-box{
    background:#fff;max-width:760px;margin:5vh auto;border-radius:16px;padding:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.25);
  }
  .modal-box h3{color:#1a3a6b;margin-bottom:10px}
  .modal-box ul{padding-left:20px;line-height:1.6}
  .modal-actions{display:flex;justify-content:flex-end;margin-top:14px}

  @media(max-width:1024px){
    .filters{grid-template-columns:1fr}
    th:first-child, td:first-child{min-width:200px}
  }

/* =========================
   AJUSTE RESPONSIVO ‚Äì COLUNA BAIRRO
========================= */
@media (max-width: 768px){

  /* reduz largura m√≠nima da coluna Bairro */
  th:first-child,
  td:first-child{
    min-width: 140px;     /* antes estava ~200/240 */
    max-width: 160px;
    font-size: 0.85rem;   /* diminui a fonte s√≥ no mobile */
    line-height: 1.2;
    white-space: normal;  /* permite quebrar o nome do bairro */
    word-break: break-word;
  }

  /* opcional: um pouco menos de padding para caber melhor */
  th:first-child,
  td:first-child{
    padding: 8px;
  }
}

/* =========================
   AJUSTE RESPONSIVO ‚Äì T√çTULO E SUBT√çTULO
   (evita sobrepor o bot√£o OK)
========================= */
@media (max-width: 768px){

  header{
    padding-right: 72px; /* garante espa√ßo f√≠sico pro bot√£o OK */
  }

  header h1{
    font-size: 1.45rem;  /* ajuste fino do t√≠tulo */
    line-height: 1.2;
  }

  header h2{
    font-size: 0.95rem;  /* ajuste fino do subt√≠tulo */
    line-height: 1.25;
  }
}

 /* ===== Bot√£o Aviso Legal ===== */
.btn-legal{
  background:#fff3cd;
  border:1px solid #f0ad4e;
  color:#8a1f11;
  font-weight:900;
  padding:10px 16px;
  border-radius:999px;
  cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}
.btn-legal:hover{
  filter:brightness(.97);
}

/* ===== Texto do Aviso Legal ===== */
.aviso-legal-text{
  font-size:0.95rem;
  line-height:1.55;
  color:#1f2937;
}
.aviso-legal-text p{
  margin-bottom:12px;
}

 
</style>
</head>

<body>
<header>
  <a class="btn-ok-header" href="index.html">OK</a>
  <h1>Vigil√¢ncia Sanit√°ria</h1>
  <h2>√Åreas de Atua√ß√£o por Bairro</h2>
</header>

 <div class="container">
  <div style="text-align:center; margin:12px 0 4px;">
    <button class="btn-legal" id="btnAvisoLegal">‚ö†Ô∏è Aviso Legal</button>
  </div>
</div>
 
<div class="container">

  <div class="card">
    <div class="filters">
      <div>
        <label for="qBairro">Bairro / Local</label>
        <input id="qBairro" placeholder="Ex.: Centro, Jundia√≠, Mercado...">
      </div>
      <div>
        <label for="qFiscal">Fiscal</label>
        <input id="qFiscal" placeholder="Ex.: LIDIANE, THIAGO, VIVIANE...">
      </div>
      <div>
        <label for="fSigla">√Årea (opcional)</label>
        <select id="fSigla"><option value="">Todas</option></select>
      </div>
      <div><button class="btn" id="btnBuscar" type="button">Buscar</button></div>
      <div><button class="btn-clear" id="btnLimpar" type="button">Limpar</button></div>
    </div>

    <div class="hint">
      üí° Clique na √°rea de atua√ß√£o pra ver CNAEs relacionados.
    </div>
  </div>

  <div class="card">
    <div class="table-wrap">
      <table>
        <thead><tr id="thead"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- MODAL CNAE -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle"></h3>
    <ul id="modalList"></ul>
    <div class="modal-actions">
      <button class="btn-clear" id="btnFecharModal" type="button">Fechar</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Config
========================= */
const CSV_BAIRROS = "data/bairros.csv";
const CSV_CNAE    = "data/cnae.csv";

// Excluir definitivamente estas colunas (n√£o aparecem e n√£o entram como sigla)
const IGNORE_COLS = new Set(["CODIGO","SETOR","SETORALIMENTO","FU","CONTROLE"]);

// SIGLA -> Nome real da √°rea
const SIGLA_TO_NOME = {
  "IA": "Ind√∫strias Aliment√≠cias",
  "AG": "Alimentos em Geral",
  "ED": "Estabelecimentos de Ensino",
  "OS": "Produtos para Sa√∫de",
  "SS": "Servi√ßos de Sa√∫de",
  "OD": "Servi√ßos Odontol√≥gicos",
  "CS": "Cosm√©ticos e Saneantes",
  "AM": "Vigil√¢ncia Ambiental",
  "VT": "Servi√ßos Veterin√°rios",
  "BI": "Outras √Åreas I",
  "LP": "Estabelecimentos Assistenciais √† Sa√∫de",
  "AO": "Outras √Åreas II",
  "TR": "Servi√ßos de Transporte",
  "DR": "Com√©rcio varejista de Medicamentos",
  "MD": "Medicamentos"
};

// DOM
const qBairro = document.getElementById("qBairro");
const qFiscal = document.getElementById("qFiscal");
const fSigla  = document.getElementById("fSigla");
const thead   = document.getElementById("thead");
const tbody   = document.getElementById("tbody");
const modal   = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const modalList  = document.getElementById("modalList");

let dados = [];
let siglas = [];
let cnaeMap = {}; // SIGLA -> [atividades]

function norm(s){
  return String(s ?? "")
    .replace(/\u00A0/g, " ")
    .replace(/\s+/g, " ")
    .trim()
    .toUpperCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}

function labelArea(sigla){
  const nome = SIGLA_TO_NOME[sigla];
  return nome ? `${nome} (${sigla})` : sigla;
}

/* =========================
   CNAE loading
========================= */
function loadCSV(url){
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: res => resolve(res.data || []),
      error: err => reject(err)
    });
  });
}

 function openAvisoLegal(){
  document.getElementById("avisoLegalModal").style.display = "block";
}

function closeAvisoLegal(){
  document.getElementById("avisoLegalModal").style.display = "none";
}

 
async function init(){
  // Carrega CNAE e Bairros em paralelo
  const [cnaeRows, bairrosRows] = await Promise.all([
    loadCSV(CSV_CNAE),
    loadCSV(CSV_BAIRROS)
  ]);

  // Monta mapa CNAE: Equipe (SIGLA) -> lista Atividade
  cnaeMap = {};
  cnaeRows.forEach(r => {
    const sigla = String(r.Equipe || "").trim();
    const atividade = String(r.Atividade || "").trim();
    if(!sigla || !atividade) return;
    if(!cnaeMap[sigla]) cnaeMap[sigla] = [];
    cnaeMap[sigla].push(atividade);
  });

  // Dados bairros
  dados = bairrosRows;

  // Descobre colunas (siglas) a partir da primeira linha
  const first = bairrosRows[0] || {};
  const cols = Object.keys(first)
    .map(c => String(c).trim())
    .filter(c => c && !IGNORE_COLS.has(c));

  // Queremos: primeira coluna vis√≠vel √© NOME (Bairro)
  // Todas as demais viram "siglas" (√°reas)
  siglas = cols.filter(c => c !== "NOME");

  montarHeader();
  montarFiltroArea();
  render();
}

function montarHeader(){
  // Bairro N√ÉO clic√°vel
  let html = `<th>Bairro / Local</th>`;

  // √Åreas clic√°veis para abrir CNAE
  html += siglas.map(s => `
    <th data-sigla="${s}" title="Clique para ver CNAEs relacionados">
      <span style="cursor:pointer; font-weight:900;" onclick="openModal('${s}')">
        ${labelArea(s)} ‚ìò
      </span>
    </th>
  `).join("");

  thead.innerHTML = html;
}

function montarFiltroArea(){
  fSigla.innerHTML =
    `<option value="">Todas</option>` +
    siglas.map(s => `<option value="${s}">${labelArea(s)}</option>`).join("");
}

/* =========================
   Render + oculta√ß√£o colunas
========================= */
function rowMatches(l){
  const qb = norm(qBairro.value);
  const qf = norm(qFiscal.value);
  const fs = fSigla.value;

  if(qb && !norm(l.NOME).includes(qb)) return false;

  if(fs && !String(l[fs] || "").trim()) return false;

  if(qf){
    if(fs){
      return norm(l[fs]).includes(qf);
    }
    return siglas.some(s => norm(l[s]).includes(qf));
  }

  return true;
}

function render(){
  tbody.innerHTML = "";

  const qf = norm(qFiscal.value);
  const fs = fSigla.value;

  const filtradas = dados.filter(rowMatches);

  filtradas.forEach(l => {
    const tds = siglas.map(s => {
      let v = String(l[s] || "");
      if(qf && norm(v).includes(qf)){
        v = `<span class="hit">${v}</span>`;
      }
      return `<td>${v}</td>`;
    }).join("");

    tbody.innerHTML += `<tr><td>${String(l.NOME || "")}</td>${tds}</tr>`;
  });

  aplicarOcultacaoDeColunas(filtradas, qf, fs);
}

function aplicarOcultacaoDeColunas(linhasFiltradas, qfNorm, siglaSelecionada){
  const ths = thead.querySelectorAll("th"); // 0 = Bairro, demais = siglas
  const trs = tbody.querySelectorAll("tr");

  // Se n√£o h√° fiscal digitado: mostra todas as siglas
  if(!qfNorm){
    for(let i=1; i<ths.length; i++){
      ths[i].classList.remove("col-hidden");
      trs.forEach(tr => tr.children[i]?.classList.remove("col-hidden"));
    }
    return;
  }

  // Se √°rea selecionada: mostra s√≥ ela
  if(siglaSelecionada){
    const idx = 1 + siglas.indexOf(siglaSelecionada);
    for(let i=1; i<ths.length; i++){
      const show = (i === idx);
      ths[i].classList.toggle("col-hidden", !show);
      trs.forEach(tr => tr.children[i]?.classList.toggle("col-hidden", !show));
    }
    return;
  }

  // Caso geral: mostrar apenas siglas que contenham o fiscal em pelo menos 1 linha filtrada
  const visiveis = new Set();
  siglas.forEach(s => {
    for(const l of linhasFiltradas){
      if(norm(l[s] || "").includes(qfNorm)){
        visiveis.add(s);
        break;
      }
    }
  });

  for(let i=1; i<ths.length; i++){
    const sigla = siglas[i-1];
    const show = visiveis.has(sigla);
    ths[i].classList.toggle("col-hidden", !show);
    trs.forEach(tr => tr.children[i]?.classList.toggle("col-hidden", !show));
  }
}

/* =========================
   Modal CNAE
========================= */
function openModal(sigla){
  const list = cnaeMap[sigla] || [];
  modalTitle.textContent = `Atividades Econ√¥micas ‚Äì ${labelArea(sigla)}`;
  modalList.innerHTML = (list.length ? list : ["Nenhuma atividade cadastrada."])
    .map(a => `<li>${a}</li>`).join("");
  modal.style.display = "block";
}
function closeModal(){ modal.style.display = "none"; }

// exp√µe para onclick do header
window.openModal = openModal;

</div>

  <div class="modal-box">
    <h3 style="color:#8a1f11;">Aviso Legal</h3>

    <div class="aviso-legal-text">
      <p>
        Informamos que a divis√£o dos fiscais por √°reas de atua√ß√£o n√£o √© fixa,
        n√£o gerando direito adquirido ou qualquer forma de vincula√ß√£o permanente.
      </p>

      <p>
        Nos termos da Lei Complementar n¬∫ 548/2023, compete ao Secret√°rio Municipal
        de Sa√∫de a organiza√ß√£o mensal das Ordens de Servi√ßo, inclusive quanto √†
        defini√ß√£o e √† redistribui√ß√£o das √°reas de atua√ß√£o.
      </p>

      <p>
        Ressalta-se que essa atribui√ß√£o foi formalmente delegada ao Gerente da
        Vigil√¢ncia Sanit√°ria, a quem cabe organizar e ajustar mensalmente as
        Ordens de Servi√ßo, conforme a necessidade do servi√ßo p√∫blico, a demanda
        operacional e o interesse da Administra√ß√£o.
      </p>

      <p>
        Dessa forma, eventuais altera√ß√µes na defini√ß√£o das √°reas de atua√ß√£o s√£o
        legais, leg√≠timas e inerentes ao poder de gest√£o administrativa, devendo
        ser observadas por todos.
      </p>
    </div>

    <div class="modal-actions">
      <button class="btn-clear" onclick="closeAvisoLegal()">Fechar</button>
    </div>
  </div>
</div>

 
 
/* =========================
   Eventos
========================= */
document.getElementById("btnBuscar").addEventListener("click", render);
document.getElementById("btnLimpar").addEventListener("click", () => {
  qBairro.value = "";
  qFiscal.value = "";
  fSigla.value  = "";
  render();
  qBairro.focus();
});

[qBairro, qFiscal].forEach(inp => {
  inp.addEventListener("keydown", (e) => {
    if(e.key === "Enter") render();
  });
});
fSigla.addEventListener("change", render);

document.getElementById("btnFecharModal").addEventListener("click", closeModal);
modal.addEventListener("click", (e) => {
  if(e.target === modal) closeModal();
});

/* start */
init().catch(err => {
  console.error(err);
  alert("Erro ao carregar dados. Verifique se data/bairros.csv e data/cnae.csv existem e se est√° abrindo via servidor (Live Server).");
});
<script>
  // ... todo o JS da p√°gina ...

  function openAvisoLegal(){ ... }
  function closeAvisoLegal(){ ... }
document.getElementById("btnAvisoLegal").addEventListener("click", () => {
  document.getElementById("avisoLegalModal").style.display = "block";
});
 document.getElementById("btnFecharAvisoLegal").addEventListener("click", () => {
  document.getElementById("avisoLegalModal").style.display = "none";
});


 
</script>

 
</script>
 <div class="modal" id="avisoLegalModal">
<div class="modal" id="avisoLegalModal">

</body>
</html>






