<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Ordens de Servi√ßo - VISA An√°polis</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- Design System CSS -->
    <link rel="stylesheet" href="./css/design-tokens.css">

    <!-- DataTables CSS e JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    <!-- PapaParse para ler CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Eruda DevTools para Debug Mobile (remover em produ√ß√£o) -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>

    <style>
        /* RESET */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* HEADER */
        header {
            background: #1a3a6b;
            color: #ffffff;
            padding: 28px 20px 26px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            margin: 0;
            font-size: clamp(1.4rem, 2.4vw, 2.3rem);
            font-weight: 900;
            letter-spacing: .2px;
            color: #ffffff;
        }

        header h2 {
            margin: 8px 0 0;
            font-size: clamp(1rem, 1.5vw, 1.15rem);
            font-weight: 500;
            opacity: .92;
            color: #ffffff;
        }

        /* Bot√£o OK - voltar */
.btn-ok-header {
    position: absolute;
    top: 50%;
    right: 16px;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: #34C759;
    font-size: 17px;
    font-weight: 600;
    padding: 16px 12px;
    cursor: pointer;
    text-decoration: none;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-ok-header:hover {
    opacity: 0.7;
}


        /* CONTAINER */
        .container {
            max-width: 1400px;
            margin: 22px auto 30px;
            padding: 0 16px;
        }

        /* CARD DE FILTROS */
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid var(--line);
            box-shadow: var(--shadow2);
        }

        .card h3 {
            color: var(--brand1);
            font-size: 1.3em;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--brand1);
            padding-bottom: 10px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 0;
            justify-content: flex-end;  ‚Üê ADICIONAR ESSA LINHA
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
            font-size: 0.95em;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 1em;
            background: var(--input-bg);
            color: var(--input-text);
            box-sizing: border-box;
            width: 100%;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--input-focus);
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.15);
        }

        .btn-search {
            padding: 12px 32px;
            background: linear-gradient(135deg, var(--brand1), var(--brand2));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.05em;
            font-weight: 700;
            cursor: pointer;
            transition: .15s transform, .15s box-shadow;
            margin-top: 10px;
        }

        .btn-search:hover {
            box-shadow: var(--shadow2);
            transform: translateY(-1px);
        }

        .btn-search:active {
            transform: translateY(0);
        }

        /* √ÅREA DE RESULTADOS */
        .results-card {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--line);
            box-shadow: var(--shadow2);
        }

        .info-box {
            background: rgba(44, 90, 160, 0.08);
            border-left: 4px solid var(--brand1);
            padding: 15px;
            margin-bottom: 16px;
            border-radius: 4px;
            color: var(--text);
        }

        .info-box.warning {
            background: #fff7dd;
            border-left-color: #d1a000;
        }

        .info-box.success {
            background: rgba(52, 199, 89, 0.1);
            border-left-color: #34C759;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--brand1), var(--brand2));
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            min-width: 140px;
            box-shadow: var(--shadow2);
        }

        .stat-card h3 {
            font-size: 2.2em;
            margin-bottom: 5px;
            border: none;
            padding: 0;
        }

        .stat-card p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: var(--muted);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ccd6e0;
            border-top: 4px solid var(--brand1);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* DATATABLES */
        table.dataTable {
            width: 100% !important;
            border-collapse: collapse;
            margin-top: 16px !important;
        }

        table.dataTable thead th {
            background: var(--brand1);
            color: white;
            font-weight: 600;
            padding: 12px 8px;
            text-align: left;
            white-space: nowrap;
        }

        table.dataTable tbody td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--line);
            color: var(--text);
        }

        table.dataTable tbody tr:hover {
            background-color: rgba(44, 90, 160, 0.05);
            cursor: pointer;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-block;
        }

        .badge-requerimento { background: #007bff; color: white; }
        .badge-oficio { background: #28a745; color: white; }
        .badge-denuncia { background: #dc3545; color: white; }
        .badge-protocolo { background: #6f42c1; color: white; }

        .badge-complexidade-alta { background: #dc3545; color: white; }
        .badge-complexidade-media { background: #ffc107; color: #333; }
        .badge-complexidade-baixa { background: #28a745; color: white; }

        .icon {
            font-size: 1.2em;
        }

        .icon-atendido-sim { color: #28a745; }
        .icon-atendido-nao { color: #ffc107; }
        .icon-cancelado { color: #dc3545; }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { 
                transform: translateY(-50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--brand1), var(--brand2));
            color: white;
            padding: 25px;
            position: relative;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.6em;
            border: none;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            color: white;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .close:hover {
            transform: rotate(90deg) scale(1.2);
        }

        .modal-body {
            padding: 25px;
            max-height: calc(85vh - 180px);
            overflow-y: auto;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            color: var(--brand1);
            border-bottom: 2px solid var(--brand1);
            padding-bottom: 8px;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .detail-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-label {
            font-weight: 600;
            color: #555;
            width: 200px;
            flex-shrink: 0;
        }

        .detail-value {
            color: #333;
            flex: 1;
        }

        .modal-footer {
            background: #f8f9fa;
            padding: 20px 25px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 2px solid #e0e0e0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--brand1), var(--brand2));
            color: white;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* RESPONSIVO */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            .filter-row {
                grid-template-columns: 1fr;
            }

            #tabelaOS {
                min-width: 900px;
            }

            .filter-group select,
            .filter-group input {
                font-size: 16px;
            }

            .btn-search {
                width: 100%;
                padding: 14px;
            }

            header {
                padding: 28px 70px 26px 20px;
            }

            .detail-row {
                flex-direction: column;
            }

            .detail-label {
                width: 100%;
                margin-bottom: 5px;
            }

            .stats {
                flex-direction: column;
            }
        }

        @media print {
            .card, .btn, .modal-footer {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="btn-ok-header">OK</a>
        <h1>Vigil√¢ncia Sanit√°ria</h1>
        <h2>Consulta de Ordens de Servi√ßo</h2>
    </header>

    <div class="container">
        <!-- Card de Filtros -->
        <div class="card">
            <h3>üîç Filtros de Busca</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filterTipo">Tipo de OS:</label>
                    <select id="filterTipo">
                        <option value="">-- Todos os Tipos --</option>
                        <option value="Requerimento">Requerimento</option>
                        <option value="Of√≠cio">Of√≠cio</option>
                        <option value="Den√∫ncia">Den√∫ncia</option>
                        <option value="Protocolo">Protocolo</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterFiscal">Fiscal:</label>
                    <select id="filterFiscal">
                        <option value="">-- Todos os Fiscais --</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterNumero">N√∫mero da OS:</label>
                    <input type="text" id="filterNumero" placeholder="Ex: 20210001">
                </div>

                <div class="filter-group">
                    <label for="filterRazao">Raz√£o Social:</label>
                    <input type="text" id="filterRazao" placeholder="Digite parte do nome...">
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label for="filterFantasia">Nome Fantasia:</label>
                    <input type="text" id="filterFantasia" placeholder="Digite parte do fantasia...">
                </div>

                <div class="filter-group">
                    <label for="filterCancelado">Cancelado:</label>
                    <select id="filterCancelado">
                        <option value="">Todos</option>
                        <option value="N√£o" selected>N√£o</option>
                        <option value="Sim">Sim</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filterAtendido">Atendido:</label>
                    <select id="filterAtendido">
                        <option value="">Todos</option>
                        <option value="N√£o" selected>N√£o</option>
                        <option value="Sim">Sim</option>
                    </select>
                </div>

                <div class="filter-group">
                    <button class="btn-search">üîç Buscar</button>
                </div>
            </div>
        </div>

        <!-- Estat√≠sticas -->
        <div class="stats" id="statsArea" style="display: none;">
            <div class="stat-card">
                <h3 id="totalOS">0</h3>
                <p>Total de OS</p>
            </div>
            <div class="stat-card">
                <h3 id="totalAtendidas">0</h3>
                <p>Atendidas</p>
            </div>
            <div class="stat-card">
                <h3 id="totalPendentes">0</h3>
                <p>Pendentes</p>
            </div>
            <div class="stat-card">
                <h3 id="totalCanceladas">0</h3>
                <p>Canceladas</p>
            </div>
        </div>

        <!-- Card de Resultados -->
        <div class="results-card">
            <div id="infoBox"></div>

            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                Carregando dados...
            </div>

            <div class="table-responsive">
                <table id="tabelaOS" class="display" style="display: none;" width="100%">
                    <thead>
                        <tr>
                            <th>N√∫mero OS</th>
                            <th>Tipo</th>
                            <th>Fiscal</th>
                            <th>Raz√£o Social</th>
                            <th>Nome Fantasia</th>
                            <th>Complexidade</th>
                            <th>Data Encam.</th>
                            <th>Motivo/Assunto</th>
                            <th>Atendido</th>
                            <th>Cancelado</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Detalhes da Ordem de Servi√ßo</h2>
                <span class="close" onclick="fecharModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                <button class="btn btn-secondary" onclick="fecharModal()">Voltar</button>
            </div>
        </div>
    </div>

    <script>
        // Lista oficial de fiscais da VISAM An√°polis (igual ao RPF-7.html)
        const fiscaisOficiais = [
            "ACADIA DE SOUZA VIEIRA SILVA",
            "ADRIANA CRHISTINA DE REZENDE CARNEIRO",
            "ADRIANE PEREIRA GUIMAR√ÉES",
            "ALINE CASTRO DAMASIO",
            "ANA PAULA RODRIGUES CORR√äA GUIMAR√ÉES",
            "ANGELA RIBEIRO NEVES",
            "ARIANNE FERREIRA VIEIRA",
            "C√âSIO MALAQUIAS",
            "CL√ÅUDIO NASCIMENTO SILVA",
            "CL√ìVIS RAFAEL BORGES FERREIRA",
            "DANIEL SOARES BARBOSA",
            "DANIELA DE ALMEIDA CASTRO",
            "EDSON ARANTES FARIA FILHO",
            "EDUARDO LUCAS MAGALH√ÉES CASTRO",
            "FAB√çOLA PEDROSA PEIXOTO MARQUES",
            "GERALDO EDSON ROSA",
            "GLEICIANE MARIA JOS√â DA SILVA",
            "G√öBIO DIAS PEREIRA",
            "JO√ÉO BATISTA LUCAS DA SILVA REIS",
            "JOSE LUIZ RIBEIRO",
            "JULIANA FERREIRA VITURINO",
            "JULIANA K√äNIA MARTINS DA SILVA",
            "JULIO C√âSAR TELES SPINDOLA",
            "KAMILLA CHRYSTINE ROLIM D. SANTOS GARC√äS",
            "LIDIANE SIM√ïES",
            "LIVIA BRITO",
            "LUCIANA CONSOLA√á√ÉO DOS SANTOS",
            "LUCIANA SANTANA DA ROCHA",
            "LUCIENE DE SOUZA BARBOSA GOMES SILVA",
            "MARCIO HENRIQUE GOMES RODOVALHO",
            "MARIA EDWIGES PINHEIRO DE SOUZA CHAVES",
            "MARINA PERILLO NAVARRETE LAVERS",
            "PATR√çCIA CORDEIRO DE MORAES E SOUZA",
            "PEDRO HENRIQUE AIRES RIBEIRO",
            "RODRIGO ALESSANDRO T√îGO SANTOS",
            "R√öBIA MARA DE FREITAS",
            "SILVIA MARQUES NAVES DA MOTA SOUZA",
            "SIMONE DUARTE GROSSI",
            "TATHIANE PESSOA DE SOUZA",
            "THIAGO GOMES GOBO",
            "VANESSA SANTANA",
            "VIVIANE MANOEL DA SILVA BORGES",
            "VIVIANE MIYADA",
            "WANESSA DE BRITO JORGE"
        ];

        // Vari√°veis globais
        let dadosRequerimento = [];
        let dadosOficio = [];
        let dadosDenuncia = [];
        let dadosProtocolo = [];
        let dadosTramitacao = [];
        let dadosRegulados = [];
        let todasOS = [];
        let dataTable = null;

        // Popular select de fiscais
        function popularFiscais() {
            const select = $('#filterFiscal');
            fiscaisOficiais.forEach(fiscal => {
                select.append(`<option value="${fiscal}">${fiscal}</option>`);
            });
        }

        // Normalizar texto para compara√ß√£o
        function normalizarTexto(str) {
            if (!str) return '';
            return String(str).trim().toUpperCase()
                .normalize('NFD').replace(/[ÃÄ-ÕØ]/g, '');
        }

        // Verificar se fiscal est√° na lista oficial
        function fiscalValido(nome) {
            if (!nome || String(nome).trim() === '') return false;
            const normalizado = normalizarTexto(nome);
            return fiscaisOficiais.some(f => normalizarTexto(f) === normalizado);
        }

        // Carregar arquivos CSV
        function carregarArquivos() {
            let arquivosCarregados = 0;
            const totalArquivos = 6;
            let errosCarregamento = [];

            mostrarInfo('‚è≥ Carregando dados...', 'info');

            function verificarCarregamento() {
                arquivosCarregados++;
                if (arquivosCarregados === totalArquivos) {
                    if (errosCarregamento.length > 0) {
                        mostrarInfo('‚ö†Ô∏è Alguns arquivos n√£o foram carregados: ' + errosCarregamento.join(', '), 'warning');
                    } else {
                        mostrarInfo('‚úÖ Dados carregados! Use os filtros acima para buscar.', 'success');
                    }
                }
            }

            // Carregar Requerimentos
            Papa.parse('data/requerimento.csv', {
                download: true,
                header: true,
                delimiter: ';',
                encoding: 'utf-8',
                complete: function(results) {
                    dadosRequerimento = results.data;
                    verificarCarregamento();
                },
                error: function(error) {
                    console.error('Erro ao carregar requerimento.csv:', error);
                    errosCarregamento.push('Requerimento');
                    verificarCarregamento();
                }
            });

            // Carregar Of√≠cios
            Papa.parse('data/oficio.csv', {
                download: true,
                header: true,
                delimiter: ';',
                encoding: 'utf-8',
                complete: function(results) {
                    dadosOficio = results.data;
                    verificarCarregamento();
                },
                error: function(error) {
                    console.error('Erro ao carregar oficio.csv:', error);
                    errosCarregamento.push('Of√≠cio');
                    verificarCarregamento();
                }
            });

            // Carregar Den√∫ncias
            Papa.parse('data/denuncia.csv', {
                download: true,
                header: true,
                delimiter: ';',
                encoding: 'utf-8',
                complete: function(results) {
                    dadosDenuncia = results.data;
                    verificarCarregamento();
                },
                error: function(error) {
                    console.error('Erro ao carregar denuncia.csv:', error);
                    errosCarregamento.push('Den√∫ncia');
                    verificarCarregamento();
                }
            });

            // Carregar Protocolos
            Papa.parse('data/protocolo.csv', {
                download: true,
                header: true,
                delimiter: ';',
                encoding: 'utf-8',
                complete: function(results) {
                    dadosProtocolo = results.data;
                    verificarCarregamento();
                },
                error: function(error) {
                    console.error('Erro ao carregar protocolo.csv:', error);
                    errosCarregamento.push('Protocolo');
                    verificarCarregamento();
                }
            });

            // Carregar Tramita√ß√£o
            Papa.parse('data/tramitacao.csv', {
                download: true,
                header: true,
                delimiter: ';',
                encoding: 'utf-8',
                complete: function(results) {
                    dadosTramitacao = results.data;
                    verificarCarregamento();
                },
                error: function(error) {
                    console.error('Erro ao carregar tramitacao.csv:', error);
                    errosCarregamento.push('Tramita√ß√£o');
                    verificarCarregamento();
                }
            });

            // Carregar Regulados
            Papa.parse('data/regulados.csv', {
                download: true,
                header: true,
                delimiter: ';',
                encoding: 'utf-8',
                complete: function(results) {
                    dadosRegulados = results.data;
                    verificarCarregamento();
                },
                error: function(error) {
                    console.error('Erro ao carregar regulados.csv:', error);
                    errosCarregamento.push('Regulados');
                    verificarCarregamento();
                }
            });
        }

        // Mostrar info box
        function mostrarInfo(mensagem, tipo = 'info') {
            const infoBox = $('#infoBox');
            infoBox.removeClass('info-box warning success');
            infoBox.addClass(`info-box ${tipo}`);
            infoBox.html(mensagem);
            infoBox.show();
        }

        // Converter data DD.MM.YYYY para YYYY-MM-DD
        function converterData(dataStr) {
            if (!dataStr || dataStr.trim() === '') return '';
            const partes = dataStr.split('.');
            if (partes.length === 3) {
                return `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
            }
            return '';
        }

        // Formatar data para exibi√ß√£o
        function formatarDataBR(dataISO) {
            if (!dataISO) return '-';
            const partes = dataISO.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }

        // Processar booleano
        function processarBool(valor) {
            if (!valor || String(valor).trim() === '') return false;
            const v = String(valor).toUpperCase();
            return v === 'TRUE' || v === 'SIM' || v === 'T' || v === 'S';
        }

        // Buscar Ordens de Servi√ßo
        function buscarOrdens() {
            console.log('üîç Iniciando busca de ordens...');
            
            $('#loading').show();
            $('#tabelaOS').hide();
            $('#infoBox').hide();
            $('#statsArea').hide();

            // Verificar se dados foram carregados
            if (!dadosRequerimento.length && !dadosOficio.length && !dadosDenuncia.length && !dadosProtocolo.length) {
                console.error('‚ùå Nenhum dado foi carregado ainda!');
                mostrarInfo('‚ö†Ô∏è Os dados ainda est√£o sendo carregados. Aguarde e tente novamente.', 'warning');
                $('#loading').hide();
                return;
            }

            console.log('üìä Dados carregados:', {
                requerimentos: dadosRequerimento.length,
                oficios: dadosOficio.length,
                denuncias: dadosDenuncia.length,
                protocolos: dadosProtocolo.length,
                regulados: dadosRegulados.length,
                tramitacao: dadosTramitacao.length
            });

            // PROCESSAR EM CHUNKS para n√£o travar o Android
            todasOS = [];
            let processados = 0;
            const totalItens = dadosRequerimento.length + dadosOficio.length + 
                              dadosDenuncia.length + dadosProtocolo.length;

            // Fun√ß√£o para processar lotes
            function processarEmLotes() {
                const CHUNK_SIZE = 100; // Processar 100 itens por vez
                let inicio = processados;
                let fim = Math.min(inicio + CHUNK_SIZE, totalItens);
                
                // Processar REQUERIMENTOS
                if (processados < dadosRequerimento.length) {
                    const inicioReq = processados;
                    const fimReq = Math.min(fim, dadosRequerimento.length);
                    
                    for (let i = inicioReq; i < fimReq; i++) {
                        const r = dadosRequerimento[i];
                        if (!r.OS || r.OS.trim() === '') continue;

                        const fiscal = r.Fiscal_Encaminha || '';
                        if (fiscal && fiscal.trim() !== '' && !fiscalValido(fiscal)) continue;

                        let razaoSocial = r.Requerente || '';
                        let fantasia = '';
                        let logradouro = '';
                        let cnpj = '';
                        let cpf = '';
                        let cdbai = '';

                        if (r.Codigo) {
                            const regulado = dadosRegulados.find(reg => 
                                String(reg.CODIGO).trim() === String(r.Codigo).trim()
                            );
                            if (regulado) {
                                razaoSocial = regulado.RAZAO || razaoSocial;
                                fantasia = regulado.FANTASIA || '';
                                logradouro = regulado.LOGRADOURO || '';
                                cnpj = regulado.CGC || '';
                                cpf = regulado.CPF || '';
                                cdbai = regulado.CDBAI || '';
                            }
                        }

                        todasOS.push({
                            numero: r.OS,
                            tipo: 'Requerimento',
                            fiscal: fiscal,
                            razao_social: razaoSocial,
                            fantasia: fantasia,
                            complexidade: r.Complexidade || '',
                            data_req: converterData(r.Dt_Req),
                            data_encaminha: converterData(r.Dt_encaminha),
                            motivo: r.Motivo || '',
                            atendida: processarBool(r.Atendimento) ? 'Sim' : 'N√£o',
                            cancelado: processarBool(r.Cancelado) ? 'Sim' : 'N√£o',
                            area: r.Area || '',
                            logradouro: logradouro,
                            cnpj: cnpj,
                            cpf: cpf,
                            observacao: r.Obs_Req || '',
                            cdbai: cdbai
                        });
                    }
                    
                    processados = fimReq;
                }
                // Processar OF√çCIOS
                else if (processados < dadosRequerimento.length + dadosOficio.length) {
                    const base = dadosRequerimento.length;
                    const inicioOf = processados - base;
                    const fimOf = Math.min(fim - base, dadosOficio.length);
                    
                    for (let i = inicioOf; i < fimOf; i++) {
                        const o = dadosOficio[i];
                        if (!o.Oficio || o.Oficio.trim() === '') continue;

                        const fiscal = o.Fiscalencaminha || '';
                        if (fiscal && fiscal.trim() !== '' && !fiscalValido(fiscal)) continue;

                        todasOS.push({
                            numero: o.Oficio,
                            tipo: 'Of√≠cio',
                            fiscal: fiscal,
                            razao_social: o.Regulado || '',
                            fantasia: o.Fantasia || '',
                            complexidade: '',
                            data_req: converterData(o.Data),
                            data_encaminha: converterData(o.Dtencaminha),
                            motivo: o.Motivo || '',
                            atendida: processarBool(o.Archive) ? 'Sim' : 'N√£o',
                            cancelado: processarBool(o.Cancela) ? 'Sim' : 'N√£o',
                            area: '',
                            logradouro: o.Logradouro || '',
                            cnpj: o.Cnpj || '',
                            cpf: o.Cpf || '',
                            observacao: o.Ordem || '',
                            cdbai: o.Cdbai || ''
                        });
                    }
                    
                    processados = base + fimOf;
                }
                // Processar DEN√öNCIAS
                else if (processados < dadosRequerimento.length + dadosOficio.length + dadosDenuncia.length) {
                    const base = dadosRequerimento.length + dadosOficio.length;
                    const inicioDen = processados - base;
                    const fimDen = Math.min(fim - base, dadosDenuncia.length);
                    
                    for (let i = inicioDen; i < fimDen; i++) {
                        const d = dadosDenuncia[i];
                        if (!d.Denuncia || d.Denuncia.trim() === '') continue;

                        const fiscal = d.FiscalEncaminha || '';
                        if (fiscal && fiscal.trim() !== '' && !fiscalValido(fiscal)) continue;

                        todasOS.push({
                            numero: d.Denuncia,
                            tipo: 'Den√∫ncia',
                            fiscal: fiscal,
                            razao_social: d.Reclamado || '',
                            fantasia: '',
                            complexidade: '',
                            data_req: converterData(d.Data),
                            data_encaminha: converterData(d.DtEncaminha),
                            motivo: d.Objeto1 || '',
                            atendida: processarBool(d.Archive) ? 'Sim' : 'N√£o',
                            cancelado: 'N√£o',
                            area: d.Area || '',
                            logradouro: d.Logradouro || '',
                            cnpj: d.Cnpj || '',
                            cpf: d.Cpf || '',
                            observacao: d.Descricao || '',
                            cdbai: d.Cdbai || ''
                        });
                    }
                    
                    processados = base + fimDen;
                }
                // Processar PROTOCOLOS
                else {
                    const base = dadosRequerimento.length + dadosOficio.length + dadosDenuncia.length;
                    const inicioProt = processados - base;
                    const fimProt = Math.min(fim - base, dadosProtocolo.length);
                    
                    for (let i = inicioProt; i < fimProt; i++) {
                        const p = dadosProtocolo[i];
                        if (!p.Protocolo || p.Protocolo.trim() === '') continue;

                        const carga = p.Carga || '';
                        if (carga && carga.trim() !== '' && !fiscalValido(carga)) continue;

                        const trams = dadosTramitacao.filter(t => 
                            String(t.PROTOCOLO).trim() === String(p.Protocolo).trim()
                        );

                        let dataEncaminha = '';
                        let destinoValido = true;

                        if (trams.length > 0) {
                            trams.sort((a, b) => {
                                const dataA = converterData(a.DATA);
                                const dataB = converterData(b.DATA);
                                if (dataA !== dataB) return dataB.localeCompare(dataA);
                                return (b.HORA || '').localeCompare(a.HORA || '');
                            });

                            const tramRecente = trams[0];
                            dataEncaminha = converterData(tramRecente.DATA);

                            if (carga && carga.trim() !== '') {
                                const destino = normalizarTexto(tramRecente.DESTINO);
                                const cargaNorm = normalizarTexto(carga);

                                if (destino !== cargaNorm) {
                                    destinoValido = false;
                                }
                            }
                        }

                        if (!destinoValido) continue;

                        todasOS.push({
                            numero: p.Protocolo,
                            tipo: 'Protocolo',
                            fiscal: carga,
                            razao_social: p.Protocolante || '',
                            fantasia: '',
                            complexidade: '',
                            data_req: converterData(p.Data),
                            data_encaminha: dataEncaminha,
                            motivo: p.Assunto || '',
                            atendida: 'N√£o',
                            cancelado: 'N√£o',
                            area: '',
                            logradouro: '',
                            cnpj: '',
                            cpf: p.Documento || '',
                            observacao: p.Observa || '',
                            cdbai: ''
                        });
                    }
                    
                    processados = base + fimProt;
                }
                
                // Atualizar progresso
                const percentual = Math.round((processados / totalItens) * 100);
                mostrarInfo(`‚è≥ Processando dados... ${percentual}%`, 'info');
                
                // Continuar processando ou finalizar
                if (processados < totalItens) {
                    setTimeout(processarEmLotes, 10); // Pequena pausa entre chunks
                } else {
                    console.log(`‚úÖ Total de OS processadas: ${todasOS.length}`);
                    aplicarFiltros();
                }
            }
            
            // Iniciar processamento
            setTimeout(processarEmLotes, 10);
        }

        // Aplicar filtros
        function aplicarFiltros() {
            const tipo = $('#filterTipo').val().toLowerCase();
            const fiscal = normalizarTexto($('#filterFiscal').val());
            const numero = $('#filterNumero').val().toLowerCase();
            const razao = $('#filterRazao').val().toLowerCase();
            const fantasia = $('#filterFantasia').val().toLowerCase();
            const cancelado = $('#filterCancelado').val();
            const atendido = $('#filterAtendido').val();

            console.log('üîé Aplicando filtros:', { tipo, fiscal, numero, razao, fantasia, cancelado, atendido });

            let osFiltradas = todasOS.filter(os => {
                // Filtro de tipo
                if (tipo && os.tipo.toLowerCase() !== tipo) return false;

                // Filtro de fiscal (s√≥ aplica se tiver valor selecionado)
                if (fiscal && normalizarTexto(os.fiscal) !== fiscal) return false;

                // Filtro de n√∫mero
                if (numero && !os.numero.toLowerCase().includes(numero)) return false;

                // Filtro de raz√£o social
                if (razao && !os.razao_social.toLowerCase().includes(razao)) return false;

                // Filtro de fantasia
                if (fantasia && !os.fantasia.toLowerCase().includes(fantasia)) return false;

                // Filtro de cancelado
                if (cancelado && os.cancelado !== cancelado) return false;

                // Filtro de atendido
                if (atendido && os.atendida !== atendido) return false;

                return true;
            });

            console.log(`‚úÖ OS ap√≥s filtros: ${osFiltradas.length} de ${todasOS.length}`);

            exibirResultados(osFiltradas);
        }

        // Exibir resultados
        function exibirResultados(resultados) {
            $('#loading').hide();

            if (resultados.length === 0) {
                mostrarInfo('Nenhuma Ordem de Servi√ßo encontrada com os filtros selecionados.', 'warning');
                $('#tabelaOS').hide();
                $('#statsArea').hide();
                return;
            }

            // Atualizar estat√≠sticas
            const atendidas = resultados.filter(os => os.atendida === 'Sim').length;
            const canceladas = resultados.filter(os => os.cancelado === 'Sim').length;
            const pendentes = resultados.filter(os => os.atendida === 'N√£o' && os.cancelado === 'N√£o').length;

            $('#totalOS').text(resultados.length);
            $('#totalAtendidas').text(atendidas);
            $('#totalPendentes').text(pendentes);
            $('#totalCanceladas').text(canceladas);
            $('#statsArea').show();

            mostrarInfo(`Encontradas <strong>${resultados.length}</strong> Ordens de Servi√ßo.`, 'success');

            // Destruir DataTable anterior
            if (dataTable) {
                dataTable.destroy();
            }

            // Limpar e popular tabela
            const tbody = $('#tabelaOS tbody');
            tbody.empty();

            resultados.forEach((os, index) => {
                const badgeTipo = `badge-${os.tipo.toLowerCase().normalize('NFD').replace(/[ÃÄ-ÕØ]/g, "")}`;
                let badgeComplexidade = '';

                if (os.complexidade && os.tipo === 'Requerimento') {
                    const comp = os.complexidade.toLowerCase();
                    let classe = 'baixa';
                    if (comp.includes('alta') || comp.includes('alto')) classe = 'alta';
                    else if (comp.includes('m√©dia') || comp.includes('medio')) classe = 'media';
                    badgeComplexidade = `<span class="badge badge-complexidade-${classe}">${os.complexidade}</span>`;
                }

                const iconAtendido = os.atendida === 'Sim' ? 
                    '<span class="icon icon-atendido-sim">‚úÖ</span>' : 
                    '<span class="icon icon-atendido-nao">‚è≥</span>';

                const iconCancelado = os.cancelado === 'Sim' ? 
                    '<span class="icon icon-cancelado">‚ùå</span>' : '';

                tbody.append(`
                    <tr onclick="mostrarDetalhes(${index})">
                        <td>${os.numero}</td>
                        <td><span class="badge ${badgeTipo}">${os.tipo}</span></td>
                        <td>${os.fiscal || '-'}</td>
                        <td>${os.razao_social}</td>
                        <td>${os.fantasia || '-'}</td>
                        <td>${badgeComplexidade || '-'}</td>
                        <td>${formatarDataBR(os.data_encaminha)}</td>
                        <td>${os.motivo}</td>
                        <td>${iconAtendido}</td>
                        <td>${iconCancelado}</td>
                    </tr>
                `);
            });

            // Inicializar DataTable
            $('#tabelaOS').show();
            dataTable = $('#tabelaOS').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
                },
                order: [[0, 'desc']],
                pageLength: 25
            });

            // Armazenar resultados filtrados para o modal
            window.resultadosFiltrados = resultados;
        }

        // Mostrar detalhes no modal
        function mostrarDetalhes(index) {
            const os = window.resultadosFiltrados[index];

            $('#modalTitle').text(`Ordem de Servi√ßo: ${os.numero} - ${os.tipo}`);

            let html = `
                <div class="detail-section">
                    <h3>üìã Informa√ß√µes Temporais</h3>
                    <div class="detail-row">
                        <div class="detail-label">Data de Requerimento:</div>
                        <div class="detail-value">${formatarDataBR(os.data_req)}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Data de Encaminhamento:</div>
                        <div class="detail-value">${formatarDataBR(os.data_encaminha)}</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>üë§ Respons√°vel</h3>
                    <div class="detail-row">
                        <div class="detail-label">Fiscal Encarregado:</div>
                        <div class="detail-value">${os.fiscal || '-'}</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>üè¢ Dados do Estabelecimento</h3>
                    <div class="detail-row">
                        <div class="detail-label">Raz√£o Social:</div>
                        <div class="detail-value">${os.razao_social || '-'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Nome de Fantasia:</div>
                        <div class="detail-value">${os.fantasia || '-'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">CNPJ:</div>
                        <div class="detail-value">${os.cnpj || '-'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">CPF:</div>
                        <div class="detail-value">${os.cpf || '-'}</div>
                    </div>`;

            if (os.area) {
                html += `
                    <div class="detail-row">
                        <div class="detail-label">CNAE/√Årea:</div>
                        <div class="detail-value">${os.area}</div>
                    </div>`;
            }

            if (os.complexidade && os.tipo === 'Requerimento') {
                html += `
                    <div class="detail-row">
                        <div class="detail-label">Complexidade:</div>
                        <div class="detail-value">${os.complexidade}</div>
                    </div>`;
            }

            html += `
                </div>

                <div class="detail-section">
                    <h3>üìç Localiza√ß√£o</h3>
                    <div class="detail-row">
                        <div class="detail-label">Endere√ßo:</div>
                        <div class="detail-value">${os.logradouro || '-'}</div>
                    </div>`;

            if (os.cdbai) {
                html += `
                    <div class="detail-row">
                        <div class="detail-label">C√≥digo do Bairro:</div>
                        <div class="detail-value">${os.cdbai}</div>
                    </div>`;
            }

            html += `
                </div>

                <div class="detail-section">
                    <h3>üìù Observa√ß√µes</h3>
                    <div class="detail-row">
                        <div class="detail-label">Motivo/Assunto:</div>
                        <div class="detail-value">${os.motivo || '-'}</div>
                    </div>`;

            if (os.observacao) {
                html += `
                    <div class="detail-row">
                        <div class="detail-label">Observa√ß√£o:</div>
                        <div class="detail-value">${os.observacao}</div>
                    </div>`;
            }

            html += `
                </div>

                <div class="detail-section">
                    <h3>‚úÖ Status</h3>
                    <div class="detail-row">
                        <div class="detail-label">Atendida:</div>
                        <div class="detail-value">
                            <span class="badge ${os.atendida === 'Sim' ? 'badge-oficio' : 'badge-denuncia'}">
                                ${os.atendida === 'Sim' ? '‚úì Sim' : '‚è≥ N√£o'}
                            </span>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Cancelada:</div>
                        <div class="detail-value">
                            <span class="badge ${os.cancelado === 'Sim' ? 'badge-denuncia' : 'badge-oficio'}">
                                ${os.cancelado === 'Sim' ? '‚ùå Sim' : '‚úì N√£o'}
                            </span>
                        </div>
                    </div>
                </div>
            `;

            $('#modalBody').html(html);
            $('#detailModal').show();
        }

        // Fechar modal
        function fecharModal() {
            $('#detailModal').hide();
        }

        // Fechar modal ao clicar fora
        $(window).on('click', function(event) {
            if (event.target.id === 'detailModal') {
                fecharModal();
            }
        });

        // Atalho ESC para fechar modal
        $(document).on('keydown', function(event) {
            if (event.key === 'Escape') {
                fecharModal();
            }
        });

        // Inicializa√ß√£o
        $(document).ready(function() {
            popularFiscais();
            carregarArquivos();
            
            // Event listener para bot√£o de busca (mais compat√≠vel que onclick inline)
            $('.btn-search').on('click', function(e) {
                e.preventDefault();
                buscarOrdens();
            });
            
            // Permitir busca com Enter nos campos de input
            $('.filter-group input').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    buscarOrdens();
                }
            });
        });
    </script>
</body>
</html>
